
<!DOCTYPE html><html><head>
    <title>Backend from the Beginning, part 3: Databases, Dependency Injection, Middleware, and Routing</title>
    <meta name="GENERATOR" content="github.com/gomarkdown/markdown markdown processor for Go"/>
    <meta charset="utf-8"/>
    <link rel="stylesheet" type="text/css" href="/s.css"/>
    <link rel="icon" type="image/x-icon" href="/favicon.ico"/>
  </head>
  <body>
  
  <h1>Backend from the Beginning, part 3: Databases, Dependency Injection, Middleware, and Routing</h1>
  
  <p>A software article by Efron Licht.</p>
  
  <p>September 2023</p>
  
  <h4>more articles</h4>
  
  <ul>
  <li><p>backend from the beginning: a complete guide to backend development in go</p>
  
  <ol>
  <li><a href="https://eblog.fly.dev/backendbasics.html">bftb 1: Introduction, TCP, DNS, HTTP</a></li>
  <li><a href="https://eblog.fly.dev/backendbasics2.html">bftb 2: Practical backend with <code>net/http</code>, <code>net/url</code>, <code>encoding/json</code>, and <code>context</code></a></li>
  <li><a href="https://eblog.fly.dev/backendbasics3.html">bftb 3: Finishing touches: middleware, dependencies, &amp; routing</a></li>
  <li><del>[bftb 4: When I hear the word ‘framework’ I reach for my revolver]</del> <strong>(COMING SOON)</strong></li>
  </ol></li>
  
  <li><p>advanced go &amp; gamedev</p>
  
  <ol>
  <li><a href="https://eblog.fly.dev/console.html">advanced go: reflection-based debug console</a></li>
  <li><a href="https://eblog.fly.dev/console-autocomplete.html">reflection-based debug console: autocomplete</a></li>
  </ol></li>
  
  <li><p>go quirks &amp; tricks</p>
  
  <ol>
  <li><a href="https://eblog.fly.dev/quirks.html">declaration, control flow, typesystem</a></li>
  <li><a href="https://eblog.fly.dev/quirks2.html">concurrency, unsafe, reflect</a></li>
  <li><a href="https://eblog.fly.dev/quirks3.html">arrays, validation, build constraints</a></li>
  </ol></li>
  
  <li><p>starting software</p>
  
  <ol>
  <li><a href="https://eblog.fly.dev/startfast.html">start fast: booting go programs quickly with <code>inittrace</code> and <code>nonblocking[T]</code></a></li>
  <li><a href="https://eblog.fly.dev/fastdocker.html">docker should be fast, not slow</a></li>
  <li><a href="https://eblog.fly.dev/onoff.html">have you tried turning it on and off again?</a></li>
  <li><a href="https://eblog.fly.dev/testfast.html">test fast: a practical guide to a livable test suite</a></li>
  </ol></li>
  
  <li><p>miscellaneous</p>
  
  <ol>
  <li><a href="https://eblog.fly.dev/faststack.html">faststack: analyzing &amp; optimizing gin’s panic stack traces</a></li>
  <li><a href="https://eblog.fly.dev/bytehacking.html">simple byte hacking: a uuid adventure</a></li>
  </ol></li>
  </ul>
  
  <p>This is the third article in a series on backend development in Go that aims to teach <strong>understanding</strong> of how backend is put together, rather than just lego-like assembly of pre-built components. This article will try to be accessible on it’s own, but it will be much easier to follow if you’ve read the <a href="https://eblog.fly.dev/backendbasics.html">first</a> and <a href="https://eblog.fly.dev/backendbasics2.html">second</a> articles in the series.</p>
  
  <p>A brief note before we begin: it’s wild how well the first two articles went over - 60,000 views and counting from reddit alone! An encouraging sign, to say the least. Anyways, let’s get to it.</p>
  
  <h3>Review</h3>
  
  <ul>
  <li><p>In the <a href="https://eblog.fly.dev/backendbasics.html">first article</a>, we went through the components of the internet up to HTTP - TCP, IP, &amp; DNS, and built our own HTTP library and basic servers.</p></li>
  
  <li><p>In the <a href="https://eblog.fly.dev/backendbasics2.html">second article</a>, we went on a tour through the standard library’s networking packages and demonstrated how to build HTTP servers and clients in practice, rather than theory.</p></li>
  
  <li><p>In this third article, we’ll put the pieces together by covering our final missing pieces.</p>
  
  <ul>
  <li>the <code>database/sql</code> package (how to connect to a database)</li>
  <li>dependency injection for clients &amp; servers (how to put a database in our server)</li>
  <li>middleware (adding sophisticated behavior to our servers and clients, like authentication, logging, and tracing)</li>
  <li><strong>routing</strong> requests to the correct handler.</li>
  </ul></li>
  
  <li><p>The fourth article will be an opinion piece on software design and frameworks in the large. It may not come out; only if I think I can do it justice rather than make Yet Another Software Rant.</p></li>
  </ul>
  
  <h2>Databases</h2>
  
  <p>Sooner or later your backend project will need to store data that falls into one or more of the following categories:</p>
  
  <ul>
  <li><strong>Persistent</strong> - data that needs to be stored for longer than the lifetime of a single process; i.e, across program or system restarts.</li>
  <li><strong>Shared</strong> - data that needs to be accessed by multiple processes or systems.</li>
  <li><strong>Large</strong> - data that’s too large to keep in memory.</li>
  </ul>
  
  <p>There are a variety of ways to solve these problems, including but not limited to:</p>
  
  <ul>
  <li>writing to files (either locally, using a networked filesystem, or something like aws s3)</li>
  <li>using a key-value store like redis or memcached</li>
  <li>using a traditional relational database like postgres or mysql</li>
  </ul>
  
  <p>But traditional relational databases are by far the most common, so we’ll focus on that for now. Specifically, we will use <a href="https://www.postgresql.org/">PostgreSQL</a>, a popular open-source relational database. <code>SQL</code> is too large of a topic to cover in this article, so I’ll assume you have some knowledge and stick to the parts about integrating it with Go and backend development specifically. I hope to eventually do an article series covering SQL and databases more in-depth.</p>
  
  <h2>Connecting to a Database</h2>
  
  <p>Like most databases, <strong>PostgreSQL</strong> is a client-server application that uses the TCP/IP stack to communicate with clients.  We covered the TCP/IP stack in the <a href="https://eblog.fly.dev/backendbasics.html">first article</a>, so we won’t go into detail here. Unlike our servers so far, which used <code>HTTP</code> on top of that, <code>postgres</code> uses it’s own binary application-level protocol.If we wanted to communicate with postgres directly, the process would look broadly similar to the HTTP-by-hand we did in the <a href="https://eblog.fly.dev/backendbasics.html">first article</a>. Starting with a URL like “postgres://user:password@host:port/database”, we’d do something like this:</p>
  
  <ul>
  <li>Use <code>net.ResolveTCPAddr</code> to resolve the hostname and port to an IP address.</li>
  <li>Use <code>net.DialTCP</code> to connect to the server.</li>
  <li>Spin up a goroutine to listen for responses from the server, and another to send requests to the server, communicating between them using channels or another synchronization primitive.</li>
  </ul>
  
  <p>Unlike HTTP, however, the postgres protocol is not human-readable, and parsing the requests and responses would be a lot of work, so this time we’ll skip straight to using libraries. Specifically, the <code>database/sql</code> package from the standard library.</p>
  
  <h3><a href="https://pkg.go.dev/database/sql"><code>database/sql</code></a></h3>
  
  <p>The database/sql package provides a unified interface for interacting with SQL databases. Each different database needs it’s own driver, which is registered at import time by convention. A couple of notes before we get started:</p>
  
  <ul>
  <li>Even though the overall interface is generic, your queries must be written in the SQL dialect of the database you’re using; there’s no abstraction layer for that. In particular, watch out for differences in parameter placeholders: postgres uses <code>$1</code>, <code>$2</code>, etc, while mysql uses <code>?</code>.</li>
  <li>Similarly, the error messages are specific to the database you’re using and not particularly helpful. You’ll need to read the documentation for your database to understand what they mean.</li>
  </ul>
  
  <p>While Go provides a standard <em>interface</em> for interacting with databases, it does not provide <em>drivers</em> to make the actual connections and translate the requests and responses to and from the database’s protocol. That’s the domain of third-party drivers. The <a href="https://pkg.go.dev/github.com/jackc/pgx/v5"><code>github.com/jackc/pgx/v5</code></a> provides such a driver for postgres.</p>
  
  <p>If we want to use it, we’ll need to import that package, like so:</p>
  
  <pre><code class="language-go"><span class="kwd">import</span> <span class="pun">(</span>
      <span class="str">&#34;database/sql&#34;</span>
      <span class="pln">_</span> <span class="str">&#34;github.com/jackc/pgx/v5&#34;</span> <span class="com">// register the driver</span>
  <span class="pun">)</span>
  </code></pre>
  
  <p>Note the ‘<code>_</code>’ : this is a “blank import”, which means that we’re importing the package for it’s side effects (that is, registering the driver).</p>
  
  <h3>sql.Open</h3>
  
  <p>The <code>sql.Open</code> function connects to a database and returns a <code>*sql.DB</code> object that we can use to interact with it. It takes two arguments: the name of the driver, and a connection string. The connection string is driver-specific, but for postgres it looks like this:</p>
  
  <p><code>&#34;postgres://user:password@host:port/database?sslmode=mode&#34;</code></p>
  
  <p>That is, it’s a URL with the following required parameters:</p>
  
  <ul>
  <li><code>user</code> - the username to connect with</li>
  <li><code>password</code> - the password to connect with</li>
  <li><code>host</code> - the hostname of the database server</li>
  <li><code>port</code> - the port to connect to</li>
  <li><code>database</code> - the name of the database to connect to</li>
  </ul>
  
  <p>And a query parameter:</p>
  
  <ul>
  <li><code>mode</code> - whether to use SSL to connect to the database. This is required for most hosted databases, but we’ll disable it for now.</li>
  </ul>
  
  <p>We covered URLs in detail in the <a href="https://eblog.fly.dev/backendbasics.html">first article</a>, so this should be pretty familiar.</p>
  
  <p>By convention, <code>postgres</code> uses port <code>5432</code>. Usually, you’ll want to store either the entire connection string or the individual components in environment variables, so that you</p>
  
  <ul>
  <li>can change them without recompiling your program</li>
  <li>don’t leak secrets like passwords into your source code or compiled binaries.</li>
  </ul>
  
  <p>The following table shows the environment variables we’ll use, and their corresponding components of the connection string:</p>
  
  <table>
  <thead>
  <tr>
  <th>env var</th>
  <th>connection string component</th>
  <th>note</th>
  </tr>
  </thead>
  
  <tbody>
  <tr>
  <td><code>PG_USER</code></td>
  <td><code>user</code></td>
  <td></td>
  </tr>
  
  <tr>
  <td><code>PG_PASSWORD</code></td>
  <td><code>password</code></td>
  <td>be careful not to leak this!</td>
  </tr>
  
  <tr>
  <td><code>PG_HOST</code></td>
  <td><code>host</code></td>
  <td></td>
  </tr>
  
  <tr>
  <td><code>PG_PORT</code></td>
  <td><code>port</code></td>
  <td>integer in range 0-65535; 5432 for postgres by convention</td>
  </tr>
  
  <tr>
  <td><code>PG_DATABASE</code></td>
  <td><code>database</code></td>
  <td></td>
  </tr>
  
  <tr>
  <td><code>PG_SSLMODE</code></td>
  <td><code>mode</code></td>
  <td><code>disable</code> or <code>require</code>; optional</td>
  </tr>
  </tbody>
  </table>
  
  <h3>Sidenote: configuration</h3>
  
  <p>A brief note on configuration: as backend programs grow, they tend to accumulate a lot of configuration, which if not carefully managed can make programs fail in mysterious ways.</p>
  
  <p><strong>It’s always good to let the user know which configuration knobs they’re missing, rather than just failing with a cryptic error message.</strong> Configuration struggles are a common source of frustration for developers: spending a little bit of time early on error messages will save you a lot of time in the long run.</p>
  
  <p>I’ve written a handy library for environment variables, <a href="https://pkg.go.dev/gitlab.com/efronlicht/enve"><code>enve</code></a> for this purpose, but for now, we’ll do it by hand: the concept is easy.</p>
  
  <p>Installing and configurating databases can be a bit tricky, so for the purpose of this article, we’ll use the wonderful <a href="https://github.com/fergusstrange/embedded-postgres"><code>fergusstrange/embedded-postgres</code></a> to stick the database directly in our binary. This obviously isn’t suitable for production, since you’ll have no persistent storage, but it’s great for testing and development, and means that my examples will work right out of the box for you on a variety of platforms.</p>
  
  <p>The following complete program, <code>dbping</code>, sets up an embedded postgres database and connects to it, pinging it to make sure we can connect.</p>
  
  <h4>DB Example 1: <code>dbping</code></h4>
  
  <pre><code class="language-go"><span class="com">// dbping.go</span>
  <span class="kwd">package</span> <span class="pln">main</span>
  
  <span class="kwd">import</span> <span class="pun">(</span>
      <span class="str">&#34;context&#34;</span>
      <span class="str">&#34;database/sql&#34;</span>
      <span class="str">&#34;flag&#34;</span>
      <span class="str">&#34;fmt&#34;</span>
      <span class="str">&#34;io&#34;</span>
      <span class="str">&#34;log&#34;</span>
      <span class="str">&#34;os&#34;</span>
      <span class="str">&#34;sort&#34;</span>
      <span class="str">&#34;strconv&#34;</span>
      <span class="str">&#34;time&#34;</span>
  
      <span class="pln">embeddedpostgres</span> <span class="str">&#34;github.com/fergusstrange/embedded-postgres&#34;</span> <span class="com">// embedded postgres server.</span>
      <span class="pln">_</span> <span class="str">&#34;github.com/jackc/pgx/v5&#34;</span>                                   <span class="com">// register the db driver</span>
  <span class="pun">)</span>
  
  
  <span class="kwd">func</span> <span class="pln">main</span><span class="pun">(</span><span class="pun">)</span> <span class="pun">{</span>
      <span class="pln">timeout</span> <span class="pun">:</span><span class="pun">=</span> <span class="pln">flag</span><span class="pun">.</span><span class="typ">Duration</span><span class="pun">(</span><span class="str">&#34;timeout&#34;</span><span class="pun">,</span> <span class="dec">5</span><span class="pun">*</span><span class="pln">time</span><span class="pun">.</span><span class="typ">Second</span><span class="pun">,</span> <span class="str">&#34;timeout for connecting to postgres&#34;</span><span class="pun">)</span>
      <span class="pln">flag</span><span class="pun">.</span><span class="typ">Parse</span><span class="pun">(</span><span class="pun">)</span>
  
      <span class="pln">cfg</span><span class="pun">,</span> <span class="pln">err</span> <span class="pun">:</span><span class="pun">=</span> <span class="pln">pgConfigFromEnv</span><span class="pun">(</span><span class="pun">)</span> <span class="com">// defined below</span>
      <span class="kwd">if</span> <span class="pln">err</span> <span class="pun">!</span><span class="pun">=</span> <span class="kwd">nil</span> <span class="pun">{</span>
          <span class="pln">log</span><span class="pun">.</span><span class="typ">Fatalf</span><span class="pun">(</span><span class="str">&#34;postgres configuration error: %v&#34;</span><span class="pun">,</span> <span class="pln">err</span><span class="pun">)</span>
      <span class="pun">}</span>
      <span class="com">// ---- setup embedded postgres server ----</span>
      <span class="pln">portN</span><span class="pun">,</span> <span class="pln">err</span> <span class="pun">:</span><span class="pun">=</span> <span class="pln">strconv</span><span class="pun">.</span><span class="typ">Atoi</span><span class="pun">(</span><span class="pln">cfg</span><span class="pun">.</span><span class="pln">port</span><span class="pun">)</span>
      <span class="kwd">if</span> <span class="pln">err</span> <span class="pun">!</span><span class="pun">=</span> <span class="kwd">nil</span> <span class="pun">{</span>
          <span class="pln">panic</span><span class="pun">(</span><span class="pln">err</span><span class="pun">)</span>
      <span class="pun">}</span>
  
      <span class="com">// we&#39;ll mirror the postgres config in the environment so that you can&#39;t actually get it &#39;wrong&#39; when running</span>
      <span class="com">// this example; you do need to set the environment variables, though.</span>
      <span class="pln">embeddedCfg</span> <span class="pun">:</span><span class="pun">=</span> <span class="pln">embeddedpostgres</span><span class="pun">.</span><span class="typ">DefaultConfig</span><span class="pun">(</span><span class="pun">)</span><span class="pun">.</span>
          <span class="typ">Username</span><span class="pun">(</span><span class="pln">cfg</span><span class="pun">.</span><span class="pln">user</span><span class="pun">)</span><span class="pun">.</span>
          <span class="typ">Password</span><span class="pun">(</span><span class="pln">cfg</span><span class="pun">.</span><span class="pln">password</span><span class="pun">)</span><span class="pun">.</span>
          <span class="typ">Database</span><span class="pun">(</span><span class="pln">cfg</span><span class="pun">.</span><span class="pln">database</span><span class="pun">)</span><span class="pun">.</span>
          <span class="typ">Port</span><span class="pun">(</span><span class="pln">uint32</span><span class="pun">(</span><span class="pln">portN</span><span class="pun">)</span><span class="pun">)</span><span class="pun">.</span>
          <span class="typ">Logger</span><span class="pun">(</span><span class="pln">io</span><span class="pun">.</span><span class="typ">Discard</span><span class="pun">)</span> <span class="com">// discard embedded postgres&#39; logs; they&#39;re not helpful for this example</span>
  
      <span class="pln">embeddedDB</span> <span class="pun">:</span><span class="pun">=</span> <span class="pln">embeddedpostgres</span><span class="pun">.</span><span class="typ">NewDatabase</span><span class="pun">(</span><span class="pln">embeddedCfg</span><span class="pun">)</span>
      <span class="kwd">if</span> <span class="pln">err</span> <span class="pun">:</span><span class="pun">=</span> <span class="pln">embeddedDB</span><span class="pun">.</span><span class="typ">Start</span><span class="pun">(</span><span class="pun">)</span><span class="pun">;</span> <span class="pln">err</span> <span class="pun">!</span><span class="pun">=</span> <span class="kwd">nil</span> <span class="pun">{</span>
          <span class="pln">panic</span><span class="pun">(</span><span class="pln">err</span><span class="pun">)</span>
      <span class="pun">}</span>
      <span class="pln">log</span><span class="pun">.</span><span class="typ">Printf</span><span class="pun">(</span><span class="str">&#34;postgres is running on: %s\n&#34;</span><span class="pun">,</span> <span class="pln">embeddedCfg</span><span class="pun">.</span><span class="typ">GetConnectionURL</span><span class="pun">(</span><span class="pun">)</span><span class="pun">)</span>
      <span class="pln">defer</span> <span class="pln">embeddedDB</span><span class="pun">.</span><span class="typ">Stop</span><span class="pun">(</span><span class="pun">)</span> <span class="com">// if we don&#39;t stop the database, it will continue running after our program exits and block the port.</span>
  
      <span class="com">// ---- connect to postgres ----</span>
  
      <span class="pln">db</span><span class="pun">,</span> <span class="pln">err</span> <span class="pun">:</span><span class="pun">=</span> <span class="pln">sql</span><span class="pun">.</span><span class="typ">Open</span><span class="pun">(</span>
          <span class="str">&#34;postgres&#34;</span><span class="pun">,</span> 
          <span class="pln">cfg</span><span class="pun">.</span><span class="typ">String</span><span class="pun">(</span><span class="pun">)</span><span class="pun">,</span> <span class="com">// defined below</span>
      <span class="pun">)</span>
      <span class="kwd">if</span> <span class="pln">err</span> <span class="pun">!</span><span class="pun">=</span> <span class="kwd">nil</span> <span class="pun">{</span>
          <span class="pln">panic</span><span class="pun">(</span><span class="pln">err</span><span class="pun">)</span>
      <span class="pun">}</span>
      <span class="pln">defer</span> <span class="pln">db</span><span class="pun">.</span><span class="typ">Close</span><span class="pun">(</span><span class="pun">)</span> <span class="com">// always close the database when you&#39;re done with it.</span>
  
      <span class="com">// always ping the database to ensure a connection is made.</span>
      <span class="com">// any time you talk to a DB, use a context with a timeout, since DB connections could be lost or delayed indefinitely.</span>
      <span class="pln">ctx</span><span class="pun">,</span> <span class="pln">cancel</span> <span class="pun">:</span><span class="pun">=</span> <span class="pln">context</span><span class="pun">.</span><span class="typ">WithTimeout</span><span class="pun">(</span><span class="pln">context</span><span class="pun">.</span><span class="typ">Background</span><span class="pun">(</span><span class="pun">)</span><span class="pun">,</span> <span class="pun">*</span><span class="pln">timeout</span><span class="pun">)</span>
      <span class="pln">defer</span> <span class="pln">cancel</span><span class="pun">(</span><span class="pun">)</span>
      <span class="kwd">if</span> <span class="pln">err</span> <span class="pun">:</span><span class="pun">=</span> <span class="pln">db</span><span class="pun">.</span><span class="typ">PingContext</span><span class="pun">(</span><span class="pln">ctx</span><span class="pun">)</span><span class="pun">;</span> <span class="pln">err</span> <span class="pun">!</span><span class="pun">=</span> <span class="kwd">nil</span> <span class="pun">{</span>
          <span class="pln">panic</span><span class="pun">(</span><span class="pln">err</span><span class="pun">)</span>
      <span class="pun">}</span>
      <span class="pln">log</span><span class="pun">.</span><span class="typ">Println</span><span class="pun">(</span><span class="str">&#34;ping successful&#34;</span><span class="pun">)</span>
  
  <span class="pun">}</span>
  
  <span class="com">// pgconfig is a struct that holds the configuration for connecting to a postgres database.</span>
  <span class="com">// each field corresponds to a component of the connection string.</span>
  <span class="com">// the following required environment variables are used to populate the struct:</span>
  <span class="com">//</span>
  <span class="com">//    PG_USER</span>
  <span class="com">//     PG_PASSWORD</span>
  <span class="com">//     PG_HOST</span>
  <span class="com">//     PG_PORT</span>
  <span class="com">//     PG_DATABASE</span>
  <span class="com">//</span>
  <span class="com">// additionally, the following optional environment variable is used to populate the sslmode:</span>
  <span class="com">//</span>
  <span class="com">//    PG_SSLMODE: must be one of  &#34;&#34;, &#34;disable&#34;, &#34;allow&#34;, &#34;require&#34;, &#34;verify-ca&#34;, or &#34;verify-full&#34;</span>
  <span class="kwd">type</span> <span class="pln">pgconfig</span> <span class="kwd">struct</span> <span class="pun">{</span>
      <span class="pln">user</span><span class="pun">,</span> <span class="pln">database</span><span class="pun">,</span> <span class="pln">host</span><span class="pun">,</span> <span class="pln">password</span><span class="pun">,</span> <span class="pln">port</span> <span class="pln">string</span> <span class="com">// required</span>
      <span class="pln">sslMode</span>                              <span class="pln">string</span> <span class="com">// optional</span>
  <span class="pun">}</span>
  
  <span class="kwd">func</span> <span class="pln">pgConfigFromEnv</span><span class="pun">(</span><span class="pun">)</span> <span class="pun">(</span><span class="pln">pgconfig</span><span class="pun">,</span> <span class="pln">error</span><span class="pun">)</span> <span class="pun">{</span>
      <span class="kwd">var</span> <span class="pln">missing</span> <span class="pun">[</span><span class="pun">]</span><span class="pln">string</span>
      <span class="com">// small closures like this can help reduce code duplication and make intent clearer.</span>
      <span class="com">// you generally pay a small performance penalty for this, but for configuration, it&#39;s not a big deal;</span>
      <span class="com">// you can spare the nanoseconds.</span>
      <span class="com">// i prefer little helper functions like this to a complicated configuration framework like viper, cobra, envconfig, etc.</span>
      <span class="kwd">get</span> <span class="pun">:</span><span class="pun">=</span> <span class="kwd">func</span><span class="pun">(</span><span class="pln">key</span> <span class="pln">string</span><span class="pun">)</span> <span class="pln">string</span> <span class="pun">{</span>
          <span class="pln">val</span> <span class="pun">:</span><span class="pun">=</span> <span class="pln">os</span><span class="pun">.</span><span class="typ">Getenv</span><span class="pun">(</span><span class="pln">key</span><span class="pun">)</span>
          <span class="kwd">if</span> <span class="pln">val</span> <span class="pun">=</span><span class="pun">=</span> <span class="str">&#34;&#34;</span> <span class="pun">{</span>
              <span class="pln">missing</span> <span class="pun">=</span> <span class="kwd">append</span><span class="pun">(</span><span class="pln">missing</span><span class="pun">,</span> <span class="pln">key</span><span class="pun">)</span>
          <span class="pun">}</span>
          <span class="kwd">return</span> <span class="pln">val</span>
      <span class="pun">}</span>
      <span class="pln">cfg</span> <span class="pun">:</span><span class="pun">=</span> <span class="pln">pgconfig</span><span class="pun">{</span>
          <span class="pln">user</span><span class="pun">:</span>     <span class="kwd">get</span><span class="pun">(</span><span class="str">&#34;PG_USER&#34;</span><span class="pun">)</span><span class="pun">,</span>
          <span class="pln">database</span><span class="pun">:</span> <span class="kwd">get</span><span class="pun">(</span><span class="str">&#34;PG_DATABASE&#34;</span><span class="pun">)</span><span class="pun">,</span>
          <span class="pln">host</span><span class="pun">:</span>     <span class="kwd">get</span><span class="pun">(</span><span class="str">&#34;PG_HOST&#34;</span><span class="pun">)</span><span class="pun">,</span>
          <span class="pln">password</span><span class="pun">:</span> <span class="kwd">get</span><span class="pun">(</span><span class="str">&#34;PG_PASSWORD&#34;</span><span class="pun">)</span><span class="pun">,</span>
          <span class="pln">port</span><span class="pun">:</span>     <span class="kwd">get</span><span class="pun">(</span><span class="str">&#34;PG_PORT&#34;</span><span class="pun">)</span><span class="pun">,</span>
          <span class="pln">sslMode</span><span class="pun">:</span>  <span class="pln">os</span><span class="pun">.</span><span class="typ">Getenv</span><span class="pun">(</span><span class="str">&#34;PG_SSLMODE&#34;</span><span class="pun">)</span><span class="pun">,</span> <span class="com">// optional, so we don&#39;t add it to missing</span>
      <span class="pun">}</span>
      <span class="kwd">switch</span> <span class="pln">cfg</span><span class="pun">.</span><span class="pln">sslMode</span> <span class="pun">{</span>
      <span class="kwd">case</span> <span class="str">&#34;&#34;</span><span class="pun">,</span> <span class="str">&#34;disable&#34;</span><span class="pun">,</span> <span class="str">&#34;allow&#34;</span><span class="pun">,</span> <span class="str">&#34;require&#34;</span><span class="pun">,</span> <span class="str">&#34;verify-ca&#34;</span><span class="pun">,</span> <span class="str">&#34;verify-full&#34;</span><span class="pun">:</span>
          <span class="com">// valid sslmode</span>
      <span class="kwd">default</span><span class="pun">:</span>
          <span class="kwd">return</span> <span class="pln">cfg</span><span class="pun">,</span> <span class="pln">fmt</span><span class="pun">.</span><span class="typ">Errorf</span><span class="pun">(</span><span class="str">`invalid sslmode &#34;%s&#34;: expected one of &#34;&#34;, &#34;disable&#34;, &#34;allow&#34;, &#34;require&#34;, &#34;verify-ca&#34;, or &#34;verify-full&#34;`</span><span class="pun">,</span> <span class="pln">cfg</span><span class="pun">.</span><span class="pln">sslMode</span><span class="pun">)</span>
      <span class="pun">}</span>
  
      <span class="kwd">if</span> <span class="pln">len</span><span class="pun">(</span><span class="pln">missing</span><span class="pun">)</span> <span class="pun">&gt;</span> <span class="dec">0</span> <span class="pun">{</span>
          <span class="pln">sort</span><span class="pun">.</span><span class="typ">Strings</span><span class="pun">(</span><span class="pln">missing</span><span class="pun">)</span> <span class="com">// sort for consistency in error message</span>
          <span class="kwd">return</span> <span class="pln">cfg</span><span class="pun">,</span> <span class="pln">fmt</span><span class="pun">.</span><span class="typ">Errorf</span><span class="pun">(</span><span class="str">&#34;missing required environment variables: %v&#34;</span><span class="pun">,</span> <span class="pln">missing</span><span class="pun">)</span>
      <span class="pun">}</span>
      <span class="kwd">return</span> <span class="pln">cfg</span><span class="pun">,</span> <span class="kwd">nil</span>
  <span class="pun">}</span>
  
  <span class="com">// String returns the connection string for the given pgconfig.</span>
  <span class="kwd">func</span> <span class="pun">(</span><span class="pln">pg</span> <span class="pln">pgconfig</span><span class="pun">)</span> <span class="typ">String</span><span class="pun">(</span><span class="pun">)</span> <span class="pln">string</span> <span class="pun">{</span>
      <span class="pln">s</span> <span class="pun">:</span><span class="pun">=</span> <span class="pln">fmt</span><span class="pun">.</span><span class="typ">Sprintf</span><span class="pun">(</span><span class="str">&#34;postgres://%s:%s@%s:%s/%s&#34;</span><span class="pun">,</span> <span class="pln">pg</span><span class="pun">.</span><span class="pln">user</span><span class="pun">,</span> <span class="pln">pg</span><span class="pun">.</span><span class="pln">password</span><span class="pun">,</span> <span class="pln">pg</span><span class="pun">.</span><span class="pln">host</span><span class="pun">,</span> <span class="pln">pg</span><span class="pun">.</span><span class="pln">port</span><span class="pun">,</span> <span class="pln">pg</span><span class="pun">.</span><span class="pln">database</span><span class="pun">)</span>
      <span class="kwd">if</span> <span class="pln">pg</span><span class="pun">.</span><span class="pln">sslMode</span> <span class="pun">!</span><span class="pun">=</span> <span class="str">&#34;&#34;</span> <span class="pun">{</span>
          <span class="pln">s</span> <span class="pun">+</span><span class="pun">=</span> <span class="str">&#34;?sslmode=&#34;</span> <span class="pun">+</span> <span class="pln">pg</span><span class="pun">.</span><span class="pln">sslMode</span>
      <span class="pun">}</span>
      <span class="kwd">return</span> <span class="pln">s</span>
  <span class="pun">}</span>
  
  </code></pre>
  
  <p>Let’s build and run it:</p>
  
  <pre><code class="language-bash"><span class="pln">go</span> <span class="pln">build</span> <span class="pun">-</span><span class="pln">o</span> <span class="pln">dbping</span> <span class="pun">.</span><span class="pun">/</span><span class="pln">dbping</span><span class="pun">.</span><span class="pln">go</span>
  <span class="pun">.</span><span class="pun">/</span><span class="pln">dbping</span>
  </code></pre>
  
  <p>OUT:</p>
  
  <pre><code class="language-text"><span class="dec">2023</span><span class="pun">/</span><span class="dec">09</span><span class="pun">/</span><span class="dec">17</span> <span class="dec">09</span><span class="pun">:</span><span class="dec">52</span><span class="pun">:</span><span class="dec">45</span> <span class="pln">missing</span> <span class="dec">5</span> <span class="pln">required</span> <span class="pln">environment</span> <span class="pln">variable</span><span class="pun">(</span><span class="pln">s</span><span class="pun">)</span><span class="pun">:</span> <span class="pun">[</span><span class="typ">PG_DATABASE</span> <span class="typ">PG_HOST</span> <span class="typ">PG_PASSWORD</span> <span class="typ">PG_PORT</span> <span class="typ">PG_USER</span><span class="pun">]</span>
  </code></pre>
  
  <p>Whoops; we forgot to set the environment variables. Good thing we added those error messages.
  Let’s try again:</p>
  
  <pre><code class="language-bash"><span class="typ">PG_USER</span><span class="pun">=</span><span class="pln">postgres</span> <span class="typ">PG_PASSWORD</span><span class="pun">=</span><span class="pln">admin</span> <span class="typ">PG_HOST</span><span class="pun">=</span><span class="pln">localhost</span> <span class="typ">PG_PORT</span><span class="pun">=</span><span class="dec">5432</span> <span class="typ">PG_DATABASE</span><span class="pun">=</span><span class="pln">postgres</span> <span class="pun">.</span><span class="pun">/</span><span class="pln">dbping</span>
  </code></pre>
  
  <p>OUT:</p>
  
  <pre><code class="language-text"><span class="pln">panic</span><span class="pun">:</span> <span class="pln">pq</span><span class="pun">:</span> <span class="typ">SSL</span> <span class="kwd">is</span> <span class="kwd">not</span> <span class="pln">enabled</span> <span class="pln">on</span> <span class="pln">the</span> <span class="pln">server</span>
  </code></pre>
  
  <p>SSL, or Secure Sockets Layer, is a protocol for encrypting network traffic; it’s the <strong>S</strong> in HTTPS. (This article series won’t get into SSL and HTTPS, but you should, on your own time.) Let’s set the PG_SSLMODE environment variable to “disabled”:</p>
  
  <pre><code class="language-bash"><span class="typ">PG_USER</span><span class="pun">=</span><span class="pln">postgres</span> <span class="typ">PG_PASSWORD</span><span class="pun">=</span><span class="pln">admin</span> <span class="typ">PG_HOST</span><span class="pun">=</span><span class="pln">localhost</span> <span class="typ">PG_PORT</span><span class="pun">=</span><span class="dec">5432</span> <span class="typ">PG_DATABASE</span><span class="pun">=</span><span class="pln">postgres</span> <span class="typ">PG_SSLMODE</span><span class="pun">=</span><span class="pln">disable</span> <span class="pun">.</span><span class="pun">/</span><span class="pln">dbping</span>
  </code></pre>
  
  <p>OUT:</p>
  
  <pre><code class="language-text"><span class="dec">2023</span><span class="pun">/</span><span class="dec">09</span><span class="pun">/</span><span class="dec">17</span> <span class="dec">10</span><span class="pun">:</span><span class="dec">14</span><span class="pun">:</span><span class="dec">14</span> <span class="pln">postgres</span> <span class="pln">configuration</span> <span class="pln">error</span><span class="pun">:</span> <span class="pln">invalid</span> <span class="pln">sslmode</span> <span class="str">&#34;disabled&#34;</span><span class="pun">:</span> <span class="pln">expected</span> <span class="pln">one</span> <span class="pln">of</span> <span class="str">&#34;&#34;</span><span class="pun">,</span> <span class="str">&#34;disable&#34;</span><span class="pun">,</span> <span class="str">&#34;allow&#34;</span><span class="pun">,</span> <span class="str">&#34;require&#34;</span><span class="pun">,</span> <span class="str">&#34;verify-ca&#34;</span><span class="pun">,</span> <span class="kwd">or</span> <span class="str">&#34;verify-full&#34;</span>
  </code></pre>
  
  <p>… looks like it’s <em>disable</em>, not <em>disable<strong>d</strong></em>. One last time:</p>
  
  <pre><code class="language-bash"><span class="typ">PG_USER</span><span class="pun">=</span><span class="pln">postgres</span> <span class="typ">PG_PASSWORD</span><span class="pun">=</span><span class="pln">admin</span> <span class="typ">PG_HOST</span><span class="pun">=</span><span class="pln">localhost</span> <span class="typ">PG_PORT</span><span class="pun">=</span><span class="dec">5432</span> <span class="typ">PG_DATABASE</span><span class="pun">=</span><span class="pln">postgres</span> <span class="typ">PG_SSLMODE</span><span class="pun">=</span><span class="pln">disable</span> <span class="pun">.</span><span class="pun">/</span><span class="pln">dbping</span>
  </code></pre>
  
  <p>OUT:</p>
  
  <pre><code class="language-text"><span class="dec">2023</span><span class="pun">/</span><span class="dec">09</span><span class="pun">/</span><span class="dec">17</span> <span class="dec">10</span><span class="pun">:</span><span class="dec">15</span><span class="pun">:</span><span class="dec">19</span> <span class="pln">postgres</span> <span class="kwd">is</span> <span class="pln">running</span> <span class="pln">on</span><span class="pun">:</span> <span class="pln">postgresql</span><span class="pun">:</span><span class="com">//postgres:admin@localhost:5432/postgres</span>
  <span class="dec">2023</span><span class="pun">/</span><span class="dec">09</span><span class="pun">/</span><span class="dec">17</span> <span class="dec">10</span><span class="pun">:</span><span class="dec">15</span><span class="pun">:</span><span class="dec">19</span> <span class="pln">ping</span> <span class="pln">successful</span>
  </code></pre>
  
  <p>OK, looks good. Little configuration errors like this can easily stall a project for hours or days, so it’s worth taking the time to make sure your error messages are clear and helpful. <strong>If you run into a configuration error, take the time to add a message that guides your next user to the solution; after all, that next user might be you.</strong></p>
  
  <h3>Using <code>*sql.DB</code></h3>
  
  <p>The following table summarizes the basic API of <code>*sql.DB</code>. Note that all methods take a <code>context.Context</code> as their first argument. <strong>Never use the non-<code>Context</code> versions of these methods; they are a deprecated API. If you’re not sure what context to use, use <code>context.TODO()</code></strong>.</p>
  
  <table>
  <thead>
  <tr>
  <th>Method</th>
  <th>Returns</th>
  <th>Description</th>
  <th>Use Cases</th>
  </tr>
  </thead>
  
  <tbody>
  <tr>
  <td><code>PingContext</code></td>
  <td>error</td>
  <td>Ping the database to ensure a connection is made.</td>
  <td>Health check</td>
  </tr>
  
  <tr>
  <td><code>ExecContext</code></td>
  <td>Result, error</td>
  <td>Execute a query that does not return rows.</td>
  <td>Create, Update, Delete</td>
  </tr>
  
  <tr>
  <td><code>QueryRowContext</code></td>
  <td>Row</td>
  <td>Execute a query that returns a single row.</td>
  <td>Single item lookup</td>
  </tr>
  
  <tr>
  <td><code>QueryContext</code></td>
  <td>Rows, error</td>
  <td>Execute a query that returns rows.</td>
  <td>All other queries</td>
  </tr>
  </tbody>
  </table>
  <p>I had a big section here where I demonstrated the APIs, but it quickly grew so big it completely overwhelmed the rest of the article, which is already over twice as long as part 2. Instead, I’ll just point you to the <a href="https://pkg.go.dev/database/sql">official docs for the <code>database/sql</code> package</a></p>
  
  <h3>Dependency Injection, or, “how do I put a database in my server?”</h3>
  
  <p>So far when we’ve created http handlers, they’ve been self-contained: they don’t depend on anything outside of themselves; that is, they’re just <code>func(http.ResponseWriter, *http.Request)</code>s. But in the real world, we’ll want to access a database, cache, message queue, or other outside dependency from within our handlers.</p>
  
  <p>The simplest and best way to handle this is to <strong>pass the dependencies in as arguments</strong> to a function that creates the handler.</p>
  
  <p>That is, instead of:</p>
  
  <pre><code class="language-go"><span class="com">// example: &#39;global&#39; database connection</span>
  <span class="kwd">var</span> <span class="pln">db</span> <span class="pun">*</span><span class="pln">sql</span><span class="pun">.</span><span class="typ">DB</span> 
  <span class="kwd">func</span> <span class="pln">init</span><span class="pun">(</span><span class="pun">)</span> <span class="pun">{</span>
      <span class="pln">db</span><span class="pun">,</span> <span class="pln">err</span> <span class="pun">:</span><span class="pun">=</span> <span class="pln">sql</span><span class="pun">.</span><span class="typ">Open</span><span class="pun">(</span><span class="str">&#34;postgres&#34;</span><span class="pun">,</span> <span class="str">&#34;...&#34;</span><span class="pun">)</span>
      <span class="kwd">if</span> <span class="pln">err</span> <span class="pun">!</span><span class="pun">=</span> <span class="kwd">nil</span> <span class="pun">{</span>
          <span class="pln">panic</span><span class="pun">(</span><span class="pln">err</span><span class="pun">)</span>
      <span class="pun">}</span>
  <span class="pun">}</span>
  <span class="kwd">func</span> <span class="pln">getUser</span><span class="pun">(</span><span class="pln">w</span> <span class="pln">http</span><span class="pun">.</span><span class="typ">ResponseWriter</span><span class="pun">,</span> <span class="pln">r</span> <span class="pun">*</span><span class="pln">http</span><span class="pun">.</span><span class="typ">Request</span><span class="pun">)</span> <span class="pun">{</span>
      <span class="com">// ... parse &amp; validate request...</span>
  
  
      <span class="kwd">if</span> <span class="pln">err</span> <span class="pun">:</span><span class="pun">=</span><span class="pln">db</span><span class="pun">.</span><span class="typ">QueryRowContext</span><span class="pun">(</span><span class="pln">r</span><span class="pun">.</span><span class="typ">Context</span><span class="pun">(</span><span class="pun">)</span><span class="pun">,</span> <span class="str">&#34;SELECT * FROM users WHERE id = $1&#34;</span><span class="pun">,</span> <span class="pln">id</span><span class="pun">)</span><span class="pun">.</span><span class="typ">Scan</span><span class="pun">(</span><span class="pun">&amp;</span><span class="pln">user</span><span class="pun">.</span><span class="typ">ID</span><span class="pun">,</span> <span class="pun">&amp;</span><span class="pln">user</span><span class="pun">.</span><span class="typ">Name</span><span class="pun">,</span> <span class="pun">&amp;</span><span class="pln">user</span><span class="pun">.</span><span class="typ">Email</span><span class="pun">)</span><span class="pun">;</span> <span class="pln">err</span> <span class="pun">!</span><span class="pun">=</span> <span class="kwd">nil</span> <span class="pun">{</span>
  
      <span class="pun">}</span>
      <span class="com">// etc, etc, etc</span>
  <span class="pun">}</span>
  </code></pre>
  
  <p><em>inject</em> the dependency:</p>
  
  <pre><code class="language-go"><span class="com">// this function RETURNS a handler, rather than being a handler itself.</span>
  <span class="kwd">func</span> <span class="pln">getUser</span><span class="pun">(</span><span class="pln">db</span> <span class="pun">*</span><span class="pln">sql</span><span class="pun">.</span><span class="typ">DB</span><span class="pun">)</span> <span class="pln">http</span><span class="pun">.</span><span class="typ">HandlerFunc</span> <span class="pun">{</span>
      <span class="com">// db is now a local variable, rather than a global variable.</span>
  
      <span class="com">// this is the actual handler function, sometimes called a &#39;closure&#39; since it &#34;closes over&#34; the db variable.</span>
      <span class="kwd">return</span> <span class="kwd">func</span><span class="pun">(</span><span class="pln">w</span> <span class="pln">http</span><span class="pun">.</span><span class="typ">ResponseWriter</span><span class="pun">,</span> <span class="pln">r</span> <span class="pun">*</span><span class="pln">http</span><span class="pun">.</span><span class="typ">Request</span><span class="pun">)</span> <span class="pun">{</span>
          <span class="com">// ... parse &amp; validate request...</span>
          <span class="kwd">if</span> <span class="pln">err</span> <span class="pun">:</span><span class="pun">=</span><span class="pln">db</span><span class="pun">.</span><span class="typ">QueryRowContext</span><span class="pun">(</span><span class="pln">r</span><span class="pun">.</span><span class="typ">Context</span><span class="pun">(</span><span class="pun">)</span><span class="pun">,</span> <span class="str">&#34;SELECT * FROM users WHERE id = $1&#34;</span><span class="pun">,</span> <span class="pln">id</span><span class="pun">)</span><span class="pun">.</span><span class="typ">Scan</span><span class="pun">(</span><span class="pun">&amp;</span><span class="pln">user</span><span class="pun">.</span><span class="typ">ID</span><span class="pun">,</span> <span class="pun">&amp;</span><span class="pln">user</span><span class="pun">.</span><span class="typ">Name</span><span class="pun">,</span> <span class="pun">&amp;</span><span class="pln">user</span><span class="pun">.</span><span class="typ">Email</span><span class="pun">)</span><span class="pun">;</span> <span class="pln">err</span> <span class="pun">!</span><span class="pun">=</span> <span class="kwd">nil</span> <span class="pun">{</span>
              <span class="com">// ...</span>
          <span class="pun">}</span>
      <span class="pun">}</span>
  <span class="pun">}</span>
  </code></pre>
  
  <p>Alternatively, you can declare a struct containing the dependencies and let that struct implement the <code>http.Handler</code> interface:</p>
  
  <pre><code class="language-go"><span class="kwd">type</span> <span class="pln">userHandler</span> <span class="kwd">struct</span> <span class="pun">{</span> <span class="pln">db</span> <span class="pun">*</span><span class="pln">sql</span><span class="pun">.</span><span class="typ">DB</span> <span class="pun">}</span>
  <span class="kwd">func</span> <span class="pun">(</span><span class="pln">u</span> <span class="pln">userHandler</span><span class="pun">)</span> <span class="typ">ServeHTTP</span><span class="pun">(</span><span class="pln">w</span> <span class="pln">http</span><span class="pun">.</span><span class="typ">ResponseWriter</span><span class="pun">,</span> <span class="pln">r</span> <span class="pun">*</span><span class="pln">http</span><span class="pun">.</span><span class="typ">Request</span><span class="pun">)</span> <span class="pun">{</span>
      <span class="com">// ... parse &amp; validate request...</span>
      <span class="kwd">if</span> <span class="pln">err</span> <span class="pun">:</span><span class="pun">=</span><span class="pln">u</span><span class="pun">.</span><span class="pln">db</span><span class="pun">.</span><span class="typ">QueryRowContext</span><span class="pun">(</span><span class="pln">r</span><span class="pun">.</span><span class="typ">Context</span><span class="pun">(</span><span class="pun">)</span><span class="pun">,</span> <span class="str">&#34;SELECT * FROM users WHERE id = $1&#34;</span><span class="pun">,</span> <span class="pln">id</span><span class="pun">)</span><span class="pun">.</span><span class="typ">Scan</span><span class="pun">(</span><span class="pun">&amp;</span><span class="pln">user</span><span class="pun">.</span><span class="typ">ID</span><span class="pun">,</span> <span class="pun">&amp;</span><span class="pln">user</span><span class="pun">.</span><span class="typ">Name</span><span class="pun">,</span> <span class="pun">&amp;</span><span class="pln">user</span><span class="pun">.</span><span class="typ">Email</span><span class="pun">)</span><span class="pun">;</span> <span class="pln">err</span> <span class="pun">!</span><span class="pun">=</span> <span class="kwd">nil</span> <span class="pun">{</span>
          <span class="com">// ...</span>
      <span class="pun">}</span>
  <span class="pun">}</span>
  </code></pre>
  
  <p>I recommend you stick with closures, since they are lighter-weight: the code is only in one place rather than two, and you don’t need to create a new struct type for each handler.</p>
  
  <p>We’ll use dependency injection repeatedly throughout the rest of this article, especially while writing middleware.</p>
  
  <h2>middleware</h2>
  
  <h3>client middleware</h3>
  
  <p>There’s a lot of shared behavior we might want to add to many of our outgoing HTTP requests.</p>
  
  <p>A few things that come to mind off the top of my head:</p>
  
  <ul>
  <li>Timing how long it takes for a request to complete</li>
  <li>Adding an authorization header</li>
  <li>Retrying failed requests with exponential backoff</li>
  <li>Collecting metrics on the number of requests made to each endpoint</li>
  <li>Logging failed requests</li>
  <li>Set <code>Accept-Encoding: gzip</code> header on requests to let the server know we can handle gzipped responses</li>
  <li>Transparently unzip responses sent with the <code>&#39;Content-Encoding: gzip&#39;</code> header (actually, go’s http client does this for us already, but sshhh)</li>
  <li>etc, etc, etc</li>
  </ul>
  
  <p>The total weight of this code is probably substantial. If we added all of these behaviors to simple routes that just make a GET request and unmarshal the reponse to JSON, our ‘wrapper’ code would quickly dwarf the actual business logic.</p>
  
  <p>Another approach might be to make our own <code>DoRequest</code> function that would encapsulate all this behavior. This is certainly possible, though it gets rather complex. Here’s what that might look like for a subset of the above behaviors:</p>
  
  <pre><code class="language-go">
  <span class="com">// DoRequest is a helper function that sends the given request using the given client. It adds the following functionality:</span>
  <span class="com">//   - adds a context to the request</span>
  <span class="com">//   - adds an authorization header to the request</span>
  <span class="com">//   - retries the request up to 3 times if the server is unavailable or returns a 5xx status code</span>
  <span class="com">//   - returns an error if the server returns a 4xx status code</span>
  <span class="com">//   - logs the request duration</span>
  <span class="com">//   </span>
  <span class="kwd">func</span> <span class="typ">DoRequest</span><span class="pun">(</span><span class="pln">ctx</span> <span class="pln">context</span><span class="pun">.</span><span class="typ">Context</span><span class="pun">,</span> <span class="pln">c</span> <span class="pun">*</span><span class="pln">http</span><span class="pun">.</span><span class="typ">Client</span><span class="pun">,</span> <span class="pln">r</span> <span class="pun">*</span><span class="pln">http</span><span class="pun">.</span><span class="typ">Request</span><span class="pun">)</span> <span class="pun">(</span><span class="pun">*</span><span class="pln">http</span><span class="pun">.</span><span class="typ">Response</span><span class="pun">,</span> <span class="pln">error</span><span class="pun">)</span> <span class="pun">{</span>
      <span class="pln">r</span> <span class="pun">=</span> <span class="pln">r</span><span class="pun">.</span><span class="typ">WithContext</span><span class="pun">(</span><span class="pln">ctx</span><span class="pun">)</span> <span class="com">// add context to request</span>
      <span class="com">// track execution time</span>
      <span class="pln">start</span> <span class="pun">:</span><span class="pun">=</span> <span class="pln">time</span><span class="pun">.</span><span class="typ">Now</span><span class="pun">(</span><span class="pun">)</span>
      <span class="pln">defer</span> <span class="kwd">func</span><span class="pun">(</span><span class="pun">)</span> <span class="pun">{</span> <span class="pln">log</span><span class="pun">.</span><span class="typ">Printf</span><span class="pun">(</span><span class="str">&#34;request took %s&#34;</span><span class="pun">,</span> <span class="pln">time</span><span class="pun">.</span><span class="typ">Since</span><span class="pun">(</span><span class="pln">start</span><span class="pun">)</span><span class="pun">)</span> <span class="pun">}</span><span class="pun">(</span><span class="pun">)</span>
  
      <span class="pln">r</span> <span class="pun">=</span> <span class="pln">addAuthHeader</span><span class="pun">(</span><span class="pln">r</span><span class="pun">)</span> <span class="com">// add auth header to request</span>
  
      <span class="com">// retry logic</span>
      <span class="kwd">var</span> <span class="pln">retryErrs</span> <span class="pln">error</span>
      <span class="kwd">for</span> <span class="kwd">retry</span> <span class="pun">:</span><span class="pun">=</span> <span class="pln">uint</span><span class="pun">(</span><span class="dec">0</span><span class="pun">)</span><span class="pun">;</span> <span class="kwd">retry</span> <span class="pun">&lt;</span> <span class="dec">3</span><span class="pun">;</span> <span class="kwd">retry</span><span class="pun">+</span><span class="pun">+</span> <span class="pun">{</span>
          <span class="kwd">if</span> <span class="kwd">retry</span> <span class="pun">&gt;</span> <span class="dec">0</span> <span class="pun">{</span>
              <span class="pln">time</span><span class="pun">.</span><span class="typ">Sleep</span><span class="pun">(</span><span class="dec">10</span> <span class="pun">*</span> <span class="pln">time</span><span class="pun">.</span><span class="typ">Millisecond</span> <span class="pun">&lt;</span><span class="pun">&lt;</span> <span class="kwd">retry</span><span class="pun">)</span>
          <span class="pun">}</span>
          <span class="pln">resp</span><span class="pun">,</span> <span class="pln">err</span> <span class="pun">:</span><span class="pun">=</span> <span class="pln">c</span><span class="pun">.</span><span class="typ">Do</span><span class="pun">(</span><span class="pln">r</span><span class="pun">)</span>
          <span class="kwd">if</span> <span class="pln">errors</span><span class="pun">.</span><span class="typ">Is</span><span class="pun">(</span><span class="pln">retryErrs</span><span class="pun">,</span> <span class="pln">syscall</span><span class="pun">.</span><span class="typ">ECONNREFUSED</span><span class="pun">)</span> <span class="pun">|</span><span class="pun">|</span> <span class="pln">errors</span><span class="pun">.</span><span class="typ">Is</span><span class="pun">(</span><span class="pln">retryErrs</span><span class="pun">,</span> <span class="pln">syscall</span><span class="pun">.</span><span class="typ">ECONNRESET</span><span class="pun">)</span> <span class="pun">{</span>
              <span class="pln">retryErrs</span> <span class="pun">=</span> <span class="pln">errors</span><span class="pun">.</span><span class="typ">Join</span><span class="pun">(</span><span class="pln">retryErrs</span><span class="pun">,</span> <span class="pln">err</span><span class="pun">)</span>
              <span class="kwd">continue</span>
          <span class="pun">}</span>
          <span class="kwd">if</span> <span class="pln">retryErrs</span> <span class="pun">!</span><span class="pun">=</span> <span class="kwd">nil</span> <span class="pun">{</span>
              <span class="kwd">return</span> <span class="kwd">nil</span><span class="pun">,</span> <span class="pln">fmt</span><span class="pun">.</span><span class="typ">Errorf</span><span class="pun">(</span><span class="str">&#34;failed after %d retries: %w&#34;</span><span class="pun">,</span> <span class="kwd">retry</span><span class="pun">,</span> <span class="pln">retryErrs</span><span class="pun">)</span>
          <span class="pun">}</span>
          <span class="kwd">switch</span> <span class="pln">sc</span> <span class="pun">:</span><span class="pun">=</span> <span class="pln">resp</span><span class="pun">.</span><span class="typ">StatusCode</span><span class="pun">;</span> <span class="pun">{</span>
          <span class="kwd">case</span> <span class="pln">sc</span> <span class="pun">&lt;</span><span class="pun">=</span> <span class="dec">200</span> <span class="pun">&amp;</span><span class="pun">&amp;</span> <span class="pln">sc</span> <span class="pun">&lt;</span> <span class="dec">400</span><span class="pun">:</span>
              <span class="kwd">return</span> <span class="pln">resp</span><span class="pun">,</span> <span class="kwd">nil</span> <span class="com">// success! we&#39;re done here.</span>
          <span class="kwd">case</span> <span class="pln">sc</span> <span class="pun">&lt;</span><span class="pun">=</span> <span class="dec">400</span> <span class="pun">&amp;</span><span class="pun">&amp;</span> <span class="pln">sc</span> <span class="pun">&lt;</span> <span class="dec">500</span><span class="pun">:</span> <span class="com">// 4xx status code</span>
              <span class="kwd">return</span> <span class="kwd">nil</span><span class="pun">,</span> <span class="pln">fmt</span><span class="pun">.</span><span class="typ">Errorf</span><span class="pun">(</span><span class="str">&#34;failed after %d retries: %s&#34;</span><span class="pun">,</span> <span class="kwd">retry</span><span class="pun">,</span> <span class="pln">resp</span><span class="pun">.</span><span class="typ">Status</span><span class="pun">)</span>
          <span class="kwd">default</span><span class="pun">:</span> <span class="com">// 5xx, 1xx, or unknown status code</span>
              <span class="pln">retryErrs</span> <span class="pun">=</span> <span class="pln">errors</span><span class="pun">.</span><span class="typ">Join</span><span class="pun">(</span><span class="pln">retryErrs</span><span class="pun">,</span> <span class="pln">fmt</span><span class="pun">.</span><span class="typ">Errorf</span><span class="pun">(</span><span class="str">&#34;try %d: %s&#34;</span><span class="pun">,</span> <span class="kwd">retry</span><span class="pun">,</span> <span class="pln">resp</span><span class="pun">.</span><span class="typ">Status</span><span class="pun">)</span><span class="pun">)</span>
          <span class="pun">}</span>
  
      <span class="pun">}</span>
      <span class="kwd">return</span> <span class="kwd">nil</span><span class="pun">,</span> <span class="pln">fmt</span><span class="pun">.</span><span class="typ">Errorf</span><span class="pun">(</span><span class="str">&#34;failed after 3 retries: %w&#34;</span><span class="pun">,</span> <span class="pln">retryErrs</span><span class="pun">)</span>
  
  <span class="pun">}</span>
  </code></pre>
  
  <p>Then we could simply replace <code>client.Do</code> with <code>DoRequest(client, r)</code>.</p>
  
  <p>This has some advantages:</p>
  
  <ul>
  <li>Only one place to look</li>
  <li>Simple control flow</li>
  <li>Easy to add new functionality</li>
  </ul>
  
  <p>But things get difficult very quickly if we want to be able to add <em>some</em> but not all of this functionality to a request. For example:</p>
  
  <ul>
  <li>Different routes might need different authorization headers (what if we’re hitting two different services?)</li>
  <li>One route might need a longer timeout b/c it’s known to be slow.</li>
  <li>Some routes must be rate limited to avoid overloading the server, but others are O.K. to hit as hard as we can.</li>
  </ul>
  
  <p>What we really need is some kind of composability, where we can quickly apply <em>some</em> of the options to a client on an as-needed basis. We can build such a system by using <em>middleware</em>. Let’s talk about how <code>http.Client</code> works first:
  when we call <code>Client.Do</code>, the client sends a request to the server by calling the <code>RoundTrip</code> method on it’s <code>http.RoundTripper</code>, which is usually <code>http.DefaultTransport</code>. That <code>RoundTrip</code> method does all the low-level work of sending the request and receiving the response that we covered in the <a href="https://eblog.fly.dev/backendbasics.html">first article</a> (though, admittedly, in a much more sophisticated way).</p>
  
  <p>If we substituted out that <code>RoundTripper</code> for our own, we could intercept the request and modify it before it’s sent to the server. We could also intercept the response and modify it before it’s returned to the caller. We’d just have to make sure to eventually call the original <code>RoundTrip</code> method, so that the request actually gets sent to the server.</p>
  
  <p>That’s exactly what <strong>middleware</strong> does. Essentially, middleware “wraps” a client, sitting between it and the outside world. It modifies requests and responses as they pass through it, and can short-circuit the request/response cycle entirely.</p>
  
  <p>Our desired API will look something like this:</p>
  
  <pre><code class="language-go"><span class="kwd">var</span> <span class="pln">rt</span> <span class="pln">http</span><span class="pun">.</span><span class="typ">RoundTripper</span> <span class="pun">=</span> <span class="pln">http</span><span class="pun">.</span><span class="typ">DefaultTransport</span>
  <span class="pln">rt</span> <span class="pun">=</span> <span class="typ">TimeRequest</span><span class="pun">(</span><span class="pln">rt</span><span class="pun">)</span> 
  <span class="pln">rt</span> <span class="pun">=</span> <span class="typ">RetryOn5xx</span><span class="pun">(</span><span class="pln">rt</span><span class="pun">,</span> <span class="dec">10</span><span class="pun">*</span><span class="pln">time</span><span class="pun">.</span><span class="typ">Millisecond</span><span class="pun">,</span> <span class="dec">3</span><span class="pun">)</span>
  <span class="pln">rt</span> <span class="pun">=</span> <span class="pun">.</span><span class="pun">.</span><span class="pun">.</span>
  <span class="pln">client</span> <span class="pun">:</span><span class="pun">=</span> <span class="pun">&amp;</span><span class="pln">http</span><span class="pun">.</span><span class="typ">Client</span><span class="pun">{</span>
      <span class="typ">Timeout</span><span class="pun">:</span> <span class="dec">1</span> <span class="pun">*</span> <span class="pln">time</span><span class="pun">.</span><span class="typ">Second</span><span class="pun">,</span>
      <span class="typ">Transport</span><span class="pun">:</span> <span class="pln">rt</span><span class="pun">,</span>
  <span class="pun">}</span>
  </code></pre>
  
  <h3>Building Client Middleware</h3>
  
  <p>The RoundTripper interface looks like this:</p>
  
  <pre><code class="language-go"><span class="kwd">type</span> <span class="typ">RoundTripper</span> <span class="kwd">interface</span> <span class="pun">{</span>
      <span class="typ">RoundTrip</span><span class="pun">(</span><span class="pun">*</span><span class="pln">http</span><span class="pun">.</span><span class="typ">Request</span><span class="pun">)</span> <span class="pun">(</span><span class="pun">*</span><span class="pln">http</span><span class="pun">.</span><span class="typ">Response</span><span class="pun">,</span> <span class="pln">error</span><span class="pun">)</span>
  <span class="pun">}</span>
  </code></pre>
  
  <p>We’ll follow the example of the <code>http.HandlerFunc</code> and build a <code>RoundTripFunc</code> type that implements this interface:</p>
  
  <pre><code class="language-go">
  <span class="com">// RoundTripFunc is an adapter to allow the use of ordinary functions as RoundTrippers, a-la http.HandlerFunc</span>
  <span class="kwd">type</span> <span class="typ">RoundTripFunc</span> <span class="kwd">func</span><span class="pun">(</span><span class="pun">*</span><span class="pln">http</span><span class="pun">.</span><span class="typ">Request</span><span class="pun">)</span> <span class="pun">(</span><span class="pun">*</span><span class="pln">http</span><span class="pun">.</span><span class="typ">Response</span><span class="pun">,</span> <span class="pln">error</span><span class="pun">)</span>
  
  <span class="com">// RoundTrip implements the RoundTripper interface by calling f(r)</span>
  <span class="kwd">func</span> <span class="pun">(</span><span class="pln">f</span> <span class="typ">RoundTripFunc</span><span class="pun">)</span> <span class="typ">RoundTrip</span><span class="pun">(</span><span class="pln">r</span> <span class="pun">*</span><span class="pln">http</span><span class="pun">.</span><span class="typ">Request</span><span class="pun">)</span> <span class="pun">(</span><span class="pun">*</span><span class="pln">http</span><span class="pun">.</span><span class="typ">Response</span><span class="pun">,</span> <span class="pln">error</span><span class="pun">)</span> <span class="pun">{</span><span class="kwd">return</span> <span class="pln">f</span><span class="pun">(</span><span class="pln">r</span><span class="pun">)</span><span class="pun">}</span>
  
  <span class="kwd">var</span> <span class="pln">_</span> <span class="pln">http</span><span class="pun">.</span><span class="typ">RoundTripper</span> <span class="pun">=</span> <span class="typ">RoundTripFunc</span><span class="pun">(</span><span class="kwd">nil</span><span class="pun">)</span> <span class="com">// assert that RoundTripFunc implements http.RoundTripper at compile time</span>
  </code></pre>
  
  <h4>Client Middleware without Dependencies</h4>
  
  <p>Let’s build a package, <code>clientmw</code>, and implement a few simple middlewares. Each middleware will be a function that takes a <code>http.RoundTripper</code> and returns a <code>RoundTripFunc</code> that wraps it.</p>
  
  <p>The most basic kind of middleware has no other arguments, and simply wraps the <code>RoundTripper</code> in a closure. Here’s an example:</p>
  
  <pre><code class="language-go"><span class="kwd">package</span> <span class="pln">clientmw</span>
  
  <span class="com">// we&#39;ll use this helper function to log the beginning and end of each middleware. no need for this in the real world,</span>
  <span class="com">// but it should help you understand what&#39;s going on.</span>
  <span class="kwd">func</span> <span class="pln">logExec</span><span class="pun">(</span><span class="pln">name</span> <span class="pln">string</span><span class="pun">)</span> <span class="kwd">func</span><span class="pun">(</span><span class="pun">)</span> <span class="pun">{</span>
   <span class="pln">log</span><span class="pun">.</span><span class="typ">Printf</span><span class="pun">(</span><span class="str">&#34;middleware: begin %s&#34;</span><span class="pun">,</span> <span class="pln">name</span><span class="pun">)</span>
   <span class="kwd">return</span> <span class="kwd">func</span><span class="pun">(</span><span class="pun">)</span> <span class="pun">{</span> <span class="pln">defer</span> <span class="pln">log</span><span class="pun">.</span><span class="typ">Printf</span><span class="pun">(</span><span class="str">&#34;middleware: end %s&#34;</span><span class="pun">,</span> <span class="pln">name</span><span class="pun">)</span> <span class="pun">}</span>
  <span class="pun">}</span>
  <span class="com">// TimeRequest returns a RoundTripFunc that logs the duration of the request.</span>
  <span class="kwd">func</span> <span class="typ">TimeRequest</span><span class="pun">(</span><span class="pln">rt</span> <span class="pln">http</span><span class="pun">.</span><span class="typ">RoundTripper</span><span class="pun">)</span> <span class="typ">RoundTripFunc</span> <span class="pun">{</span>
      <span class="kwd">return</span> <span class="kwd">func</span><span class="pun">(</span><span class="pln">r</span> <span class="pun">*</span><span class="pln">http</span><span class="pun">.</span><span class="typ">Request</span><span class="pun">)</span> <span class="pun">(</span><span class="pun">*</span><span class="pln">http</span><span class="pun">.</span><span class="typ">Response</span><span class="pun">,</span> <span class="pln">error</span><span class="pun">)</span> <span class="pun">{</span>
          <span class="com">// for demonstration purposes, we&#39;ll add these logs to each middleware; don&#39;t do this in production!</span>
          <span class="pln">defer</span> <span class="pln">logExec</span><span class="pun">(</span><span class="str">&#34;TimeRequest&#34;</span><span class="pun">)</span><span class="pun">(</span><span class="pun">)</span>
  
          <span class="pln">start</span> <span class="pun">:</span><span class="pun">=</span> <span class="pln">time</span><span class="pun">.</span><span class="typ">Now</span><span class="pun">(</span><span class="pun">)</span>
          <span class="pln">resp</span><span class="pun">,</span> <span class="pln">err</span> <span class="pun">:</span><span class="pun">=</span> <span class="pln">rt</span><span class="pun">.</span><span class="typ">RoundTrip</span><span class="pun">(</span><span class="pln">r</span><span class="pun">)</span> <span class="com">// call next middleware, or http.DefaultTransport.RoundTrip if this is the last middleware</span>
          <span class="kwd">if</span> <span class="pln">err</span> <span class="pun">!</span><span class="pun">=</span> <span class="kwd">nil</span> <span class="pun">{</span>
              <span class="pln">log</span><span class="pun">.</span><span class="typ">Printf</span><span class="pun">(</span><span class="str">&#34;%s %s: errored after %s&#34;</span><span class="pun">,</span> <span class="pln">r</span><span class="pun">.</span><span class="typ">Method</span><span class="pun">,</span> <span class="pln">r</span><span class="pun">.</span><span class="typ">URL</span><span class="pun">,</span> <span class="pln">time</span><span class="pun">.</span><span class="typ">Since</span><span class="pun">(</span><span class="pln">start</span><span class="pun">)</span><span class="pun">)</span>
              <span class="kwd">return</span> <span class="kwd">nil</span><span class="pun">,</span> <span class="pln">err</span>
          <span class="pun">}</span>
          <span class="pln">log</span><span class="pun">.</span><span class="typ">Printf</span><span class="pun">(</span><span class="str">&#34;%s %s: %d %s in %s&#34;</span><span class="pun">,</span> <span class="pln">r</span><span class="pun">.</span><span class="typ">Method</span><span class="pun">,</span> <span class="pln">r</span><span class="pun">.</span><span class="typ">URL</span><span class="pun">,</span> <span class="pln">resp</span><span class="pun">.</span><span class="typ">StatusCode</span><span class="pun">,</span> <span class="pln">http</span><span class="pun">.</span><span class="typ">StatusText</span><span class="pun">(</span><span class="pln">resp</span><span class="pun">.</span><span class="typ">StatusCode</span><span class="pun">)</span><span class="pun">,</span> <span class="pln">time</span><span class="pun">.</span><span class="typ">Since</span><span class="pun">(</span><span class="pln">start</span><span class="pun">)</span><span class="pun">)</span>
          <span class="kwd">return</span> <span class="pln">resp</span><span class="pun">,</span> <span class="kwd">nil</span>
      <span class="pun">}</span>
  <span class="pun">}</span>
  </code></pre>
  
  <h4>Client Middleware with Injected Dependencies</h4>
  
  <p>But generally speaking you’ll want to pass some arguments to your middleware, <em>injecting</em> the dependencies.</p>
  
  <p>For example, we might want to have configurable retries:</p>
  
  <pre><code class="language-go"><span class="kwd">package</span> <span class="pln">clientmw</span>
  
  <span class="com">// RetryOn5xx returns a RoundTripFunc that retries the request up to n times if the server returns a 5xx status code.</span>
  <span class="com">// It will use exponential backoff: first retry will be after wait, second after 2*wait, third after 4*wait, etc.</span>
  <span class="kwd">func</span> <span class="typ">RetryOn5xx</span><span class="pun">(</span><span class="pln">rt</span> <span class="pln">http</span><span class="pun">.</span><span class="typ">RoundTripper</span><span class="pun">,</span> <span class="pln">wait</span> <span class="pln">time</span><span class="pun">.</span><span class="typ">Duration</span><span class="pun">,</span> <span class="pln">tries</span> <span class="kwd">int</span><span class="pun">)</span> <span class="typ">RoundTripFunc</span> <span class="pun">{</span>
      <span class="com">// validate arguments OUTSIDE of the closure, so that it only happens once</span>
      <span class="kwd">if</span> <span class="pln">n</span> <span class="pun">&lt;</span><span class="pun">=</span> <span class="dec">1</span> <span class="pun">{</span>
          <span class="pln">panic</span><span class="pun">(</span><span class="str">&#34;n must be &gt; 1&#34;</span><span class="pun">)</span>
      <span class="pun">}</span>
      <span class="kwd">if</span> <span class="pln">wait</span> <span class="pun">&lt;</span><span class="pun">=</span> <span class="dec">0</span> <span class="pun">{</span>
          <span class="pln">panic</span><span class="pun">(</span><span class="str">&#34;wait must be &gt; 0&#34;</span><span class="pun">)</span>
      <span class="pun">}</span>
      <span class="kwd">return</span> <span class="kwd">func</span><span class="pun">(</span><span class="pln">r</span> <span class="pun">*</span><span class="pln">http</span><span class="pun">.</span><span class="typ">Request</span><span class="pun">)</span> <span class="pun">(</span><span class="pun">*</span><span class="pln">http</span><span class="pun">.</span><span class="typ">Response</span><span class="pun">,</span> <span class="pln">error</span><span class="pun">)</span> <span class="pun">{</span>
          <span class="pln">defer</span> <span class="pln">logExec</span><span class="pun">(</span><span class="str">&#34;RetryOn5xx&#34;</span><span class="pun">)</span><span class="pun">(</span><span class="pun">)</span>
              <span class="com">// retry logic</span>
          <span class="kwd">var</span> <span class="pln">retryErrs</span> <span class="pln">error</span>
          <span class="kwd">for</span> <span class="kwd">retry</span> <span class="pun">:</span><span class="pun">=</span> <span class="pln">uint</span><span class="pun">(</span><span class="dec">0</span><span class="pun">)</span><span class="pun">;</span> <span class="kwd">retry</span> <span class="pun">&lt;</span> <span class="pln">tries</span><span class="pun">;</span> <span class="kwd">retry</span><span class="pun">+</span><span class="pun">+</span> <span class="pun">{</span>
              <span class="kwd">if</span> <span class="kwd">retry</span> <span class="pun">&gt;</span> <span class="dec">0</span> <span class="pun">{</span>
                  <span class="pln">time</span><span class="pun">.</span><span class="typ">Sleep</span><span class="pun">(</span><span class="pln">wait</span> <span class="pun">&lt;</span><span class="pun">&lt;</span> <span class="kwd">retry</span><span class="pun">)</span>
              <span class="pun">}</span>
              <span class="pln">resp</span><span class="pun">,</span> <span class="pln">err</span> <span class="pun">:</span><span class="pun">=</span> <span class="pln">rt</span><span class="pun">.</span><span class="typ">RoundTrip</span><span class="pun">(</span><span class="pln">r</span><span class="pun">)</span> <span class="com">// call next middleware, or http.DefaultTransport.RoundTrip if this is the last middleware</span>
              <span class="kwd">if</span> <span class="pln">errors</span><span class="pun">.</span><span class="typ">Is</span><span class="pun">(</span><span class="pln">retryErrs</span><span class="pun">,</span> <span class="pln">syscall</span><span class="pun">.</span><span class="typ">ECONNREFUSED</span><span class="pun">)</span> <span class="pun">|</span><span class="pun">|</span> <span class="pln">errors</span><span class="pun">.</span><span class="typ">Is</span><span class="pun">(</span><span class="pln">retryErrs</span><span class="pun">,</span> <span class="pln">syscall</span><span class="pun">.</span><span class="typ">ECONNRESET</span><span class="pun">)</span> <span class="pun">{</span>
                  <span class="pln">retryErrs</span> <span class="pun">=</span> <span class="pln">errors</span><span class="pun">.</span><span class="typ">Join</span><span class="pun">(</span><span class="pln">retryErrs</span><span class="pun">,</span> <span class="pln">err</span><span class="pun">)</span>
                  <span class="kwd">continue</span>
              <span class="pun">}</span>
              <span class="kwd">if</span> <span class="pln">retryErrs</span> <span class="pun">!</span><span class="pun">=</span> <span class="kwd">nil</span> <span class="pun">{</span>
                  <span class="kwd">return</span> <span class="kwd">nil</span><span class="pun">,</span> <span class="pln">fmt</span><span class="pun">.</span><span class="typ">Errorf</span><span class="pun">(</span><span class="str">&#34;failed after %d retries: %w&#34;</span><span class="pun">,</span> <span class="kwd">retry</span><span class="pun">,</span> <span class="pln">retryErrs</span><span class="pun">)</span>
              <span class="pun">}</span>
              <span class="kwd">switch</span> <span class="pln">sc</span> <span class="pun">:</span><span class="pun">=</span> <span class="pln">resp</span><span class="pun">.</span><span class="typ">StatusCode</span><span class="pun">;</span> <span class="pun">{</span>
              <span class="kwd">case</span> <span class="pln">sc</span> <span class="pun">&lt;</span><span class="pun">=</span> <span class="dec">200</span> <span class="pun">&amp;</span><span class="pun">&amp;</span> <span class="pln">sc</span> <span class="pun">&lt;</span> <span class="dec">400</span><span class="pun">:</span>
                  <span class="kwd">return</span> <span class="pln">resp</span><span class="pun">,</span> <span class="kwd">nil</span> <span class="com">// success! we&#39;re done here.</span>
              <span class="kwd">case</span> <span class="pln">sc</span> <span class="pun">&lt;</span><span class="pun">=</span> <span class="dec">400</span> <span class="pun">&amp;</span><span class="pun">&amp;</span> <span class="pln">sc</span> <span class="pun">&lt;</span> <span class="dec">500</span><span class="pun">:</span> <span class="com">// 4xx status code</span>
                  <span class="kwd">return</span> <span class="kwd">nil</span><span class="pun">,</span> <span class="pln">fmt</span><span class="pun">.</span><span class="typ">Errorf</span><span class="pun">(</span><span class="str">&#34;failed after %d retries: %s&#34;</span><span class="pun">,</span> <span class="kwd">retry</span><span class="pun">,</span> <span class="pln">resp</span><span class="pun">.</span><span class="typ">Status</span><span class="pun">)</span>
              <span class="kwd">default</span><span class="pun">:</span> <span class="com">// 5xx, 1xx, or unknown status code</span>
                  <span class="pln">retryErrs</span> <span class="pun">=</span> <span class="pln">errors</span><span class="pun">.</span><span class="typ">Join</span><span class="pun">(</span><span class="pln">retryErrs</span><span class="pun">,</span> <span class="pln">fmt</span><span class="pun">.</span><span class="typ">Errorf</span><span class="pun">(</span><span class="str">&#34;try %d: %s&#34;</span><span class="pun">,</span> <span class="kwd">retry</span><span class="pun">,</span> <span class="pln">resp</span><span class="pun">.</span><span class="typ">Status</span><span class="pun">)</span><span class="pun">)</span>
              <span class="pun">}</span>
  
          <span class="pun">}</span>
          <span class="kwd">return</span> <span class="kwd">nil</span><span class="pun">,</span> <span class="pln">fmt</span><span class="pun">.</span><span class="typ">Errorf</span><span class="pun">(</span><span class="str">&#34;failed after 3 retries: %w&#34;</span><span class="pun">,</span> <span class="pln">retryErrs</span><span class="pun">)</span>
      <span class="pun">}</span>
  <span class="pun">}</span>
  </code></pre>
  
  <p>Most middleware modifies the <code>context</code> of the request; this allows later middlewares to access the values set by earlier ones. For example, we may wish to <strong>trace</strong> our requests, adding a unique ID to each request that will be be associated with every log and carried from service to service via the headers. We can do this with a middleware that keeps track of a <code>Trace</code> struct in the context.</p>
  
  <p>Additionally, we’ll use the <a href="https://pkg.go.dev/github.com/google/uuid"><code>github.com/google/uuid</code></a> package to generate unique IDs. I talk about uuids in some detail in my article on <a href="https://eblog.fly.dev/bytehacking.html">simple byte hacking</a>; don’t worry about it for now.</p>
  
  <pre><code class="language-go"><span class="kwd">package</span> <span class="pln">trace</span>
  <span class="kwd">import</span> <span class="str">&#34;github.com/google/uuid&#34;</span>
  <span class="kwd">type</span> <span class="typ">Trace</span> <span class="kwd">struct</span> <span class="pun">{</span>
      <span class="typ">TraceID</span> <span class="pln">uuid</span><span class="pun">.</span><span class="typ">UUID</span> <span class="com">// TraceID is unique across the lifecycle of a single &#39;event&#39;, regardless of how many requests it takes to complete. Carried in the `X-Trace-ID` header.</span>
      <span class="typ">RequestID</span> <span class="pln">uuid</span><span class="pun">.</span><span class="typ">UUID</span> <span class="com">// RequestID is unique to each request. Carried in the `X-Request-ID` header.</span>
  <span class="pun">}</span>
  </code></pre>
  
  <p>We’ll use the following generic methods to add and retrieve values of a type from a context. See <a href="https://eblog.fly.dev/quirks.html">my article on Go quirks and tricks, pt 1</a> for more details on how this works.</p>
  
  <pre><code class="language-go"><span class="kwd">package</span> <span class="pln">ctxutil</span>
  <span class="kwd">type</span> <span class="pln">key</span><span class="pun">[</span><span class="typ">T</span> <span class="pln">any</span><span class="pun">]</span> <span class="kwd">struct</span><span class="pun">{</span><span class="pun">}</span> <span class="com">// key is a unique type that we can use as a key in a context</span>
  
  <span class="com">// WithValue returns a new context with the given value set. Only one value of each type can be set in a context; setting a value of the same type will overwrite the previous value.</span>
  <span class="kwd">func</span> <span class="typ">WithValue</span><span class="pun">[</span><span class="typ">T</span> <span class="pln">any</span><span class="pun">]</span><span class="pun">(</span><span class="pln">ctx</span> <span class="pln">context</span><span class="pun">.</span><span class="typ">Context</span><span class="pun">,</span> <span class="pln">value</span> <span class="typ">T</span><span class="pun">)</span> <span class="pln">context</span><span class="pun">.</span><span class="typ">Context</span> <span class="pun">{</span>
      <span class="kwd">return</span> <span class="pln">context</span><span class="pun">.</span><span class="typ">WithValue</span><span class="pun">(</span><span class="pln">ctx</span><span class="pun">,</span> <span class="pln">key</span><span class="pun">[</span><span class="typ">T</span><span class="pun">]</span><span class="pun">{</span><span class="pun">}</span><span class="pun">,</span> <span class="pln">value</span><span class="pun">)</span>
  <span class="pun">}</span>
  <span class="com">// Value returns the value of type T in the given context, or false if the context does not contain a value of type T.</span>
  <span class="kwd">func</span> <span class="typ">Value</span><span class="pun">[</span><span class="typ">T</span> <span class="pln">any</span><span class="pun">]</span><span class="pun">(</span><span class="pln">ctx</span> <span class="pln">context</span><span class="pun">.</span><span class="typ">Context</span><span class="pun">)</span> <span class="pun">(</span><span class="typ">T</span><span class="pun">,</span> <span class="kwd">bool</span><span class="pun">)</span> <span class="pun">{</span>
      <span class="pln">value</span><span class="pun">,</span> <span class="pln">ok</span> <span class="pun">:</span><span class="pun">=</span> <span class="pln">ctx</span><span class="pun">.</span><span class="typ">Value</span><span class="pun">(</span><span class="pln">key</span><span class="pun">[</span><span class="typ">T</span><span class="pun">]</span><span class="pun">{</span><span class="pun">}</span><span class="pun">)</span><span class="pun">.</span><span class="pun">(</span><span class="typ">T</span><span class="pun">)</span>
      <span class="kwd">return</span> <span class="pln">value</span><span class="pun">,</span> <span class="pln">ok</span>
  <span class="pun">}</span>
  </code></pre>
  
  <p>Let’s put together a <code>Trace</code> middleware that adds a <code>Trace</code> struct to the context and adds the <code>X-Trace-ID</code> and <code>X-Request-ID</code> headers to the request.</p>
  
  <pre><code class="language-go"><span class="kwd">package</span> <span class="pln">clientmw</span>
  <span class="com">// Trace returns a RoundTripFunc that </span>
  <span class="com">// - adds a trace to the request context</span>
  <span class="com">// - generating a new one if necessary</span>
  <span class="com">// - adds the X-Trace-ID and X-Request-ID headers to the request</span>
  <span class="com">// - then calls the next RoundTripper</span>
  <span class="kwd">func</span> <span class="typ">Trace</span><span class="pun">(</span><span class="pln">rt</span> <span class="pln">http</span><span class="pun">.</span><span class="typ">RoundTripper</span><span class="pun">)</span> <span class="typ">RoundTripFunc</span> <span class="pun">{</span>
      <span class="kwd">return</span> <span class="kwd">func</span><span class="pun">(</span><span class="pln">r</span> <span class="pun">*</span><span class="pln">http</span><span class="pun">.</span><span class="typ">Request</span><span class="pun">)</span> <span class="pun">(</span><span class="pun">*</span><span class="pln">http</span><span class="pun">.</span><span class="typ">Response</span><span class="pun">,</span> <span class="pln">error</span><span class="pun">)</span> <span class="pun">{</span>
          <span class="pln">defer</span> <span class="pln">logExec</span><span class="pun">(</span><span class="str">&#34;Trace&#34;</span><span class="pun">)</span><span class="pun">(</span><span class="pun">)</span>
          <span class="com">// does the request already have a trace? if so, use it. otherwise, generate a new one.</span>
          <span class="pln">traceID</span><span class="pun">,</span> <span class="pln">err</span> <span class="pun">:</span><span class="pun">=</span> <span class="pln">uuid</span><span class="pun">.</span><span class="typ">Parse</span><span class="pun">(</span><span class="pln">r</span><span class="pun">.</span><span class="typ">Header</span><span class="pun">.</span><span class="typ">Get</span><span class="pun">(</span><span class="str">&#34;X-Trace-ID&#34;</span><span class="pun">)</span><span class="pun">)</span>
          <span class="kwd">if</span> <span class="pln">err</span> <span class="pun">!</span><span class="pun">=</span> <span class="kwd">nil</span> <span class="pun">{</span>
              <span class="pln">traceID</span> <span class="pun">=</span> <span class="pln">uuid</span><span class="pun">.</span><span class="typ">New</span><span class="pun">(</span><span class="pun">)</span>
          <span class="pun">}</span>
  
          <span class="com">// build the trace. it&#39;s a small struct, so we put it directly in the context and don&#39;t bother with a pointer.</span>
          <span class="pln">trace</span> <span class="pun">:</span><span class="pun">=</span> <span class="pln">trace</span><span class="pun">.</span><span class="typ">Trace</span><span class="pun">{</span> <span class="typ">TraceID</span><span class="pun">:</span> <span class="pln">traceID</span><span class="pun">,</span> <span class="typ">RequestID</span><span class="pun">:</span> <span class="pln">uuid</span><span class="pun">.</span><span class="typ">New</span><span class="pun">(</span><span class="pun">)</span><span class="pun">}</span>
          
  
          <span class="pln">ctx</span> <span class="pun">:</span><span class="pun">=</span> <span class="pln">ctxutil</span><span class="pun">.</span><span class="typ">WithValue</span><span class="pun">(</span><span class="pln">r</span><span class="pun">.</span><span class="typ">Context</span><span class="pun">(</span><span class="pun">)</span><span class="pun">,</span> <span class="pln">trace</span><span class="pun">)</span> <span class="com">// add trace to context; retrieve with ctxutil.Value[Trace](ctx)</span>
          <span class="pln">r</span> <span class="pun">=</span> <span class="pln">r</span><span class="pun">.</span><span class="typ">WithContext</span><span class="pun">(</span><span class="pln">ctx</span><span class="pun">)</span> <span class="com">// add context to request</span>
  
          <span class="com">// add trace id &amp; request id to headers</span>
          <span class="pln">r</span><span class="pun">.</span><span class="typ">Header</span><span class="pun">.</span><span class="typ">Set</span><span class="pun">(</span><span class="str">&#34;X-Trace-ID&#34;</span><span class="pun">,</span> <span class="pln">trace</span><span class="pun">.</span><span class="typ">TraceID</span><span class="pun">.</span><span class="typ">String</span><span class="pun">(</span><span class="pun">)</span><span class="pun">)</span>  
          <span class="pln">r</span><span class="pun">.</span><span class="typ">Header</span><span class="pun">.</span><span class="typ">Set</span><span class="pun">(</span><span class="str">&#34;X-Request-ID&#34;</span><span class="pun">,</span> <span class="pln">trace</span><span class="pun">.</span><span class="typ">RequestID</span><span class="pun">.</span><span class="typ">String</span><span class="pun">(</span><span class="pun">)</span><span class="pun">)</span>
          <span class="kwd">return</span> <span class="pln">rt</span><span class="pun">.</span><span class="typ">RoundTrip</span><span class="pun">(</span><span class="pln">r</span><span class="pun">)</span> <span class="com">// call next middleware, or http.DefaultTransport.RoundTrip if this is the last middleware</span>
      <span class="pun">}</span>
  <span class="pun">}</span>
  </code></pre>
  
  <p>Let’s pick up this trace in the next middleware, one that adds a logger to our requests. We’ll just use the standard library’s unstructured <a href="https://pkg.go.dev/log"><code>log</code></a> package for now.</p>
  
  <blockquote>
  <p>Note: In practice you should probably use a structured logger. Both <a href="https://github.com/rs/zerolog"><code>rs/zerolog</code></a> and <a href="https://github.com/uber-go/zap"><code>uber-go/zap</code></a> are popular choices, and the standard library has recently introduced it’s own structured logging package, <a href="https://pkg.go.dev/log/slog"><code>log/slog</code></a>. I can happily recommend any of these. But for now, we’ll dodge the question entirely and leave logging and metrics for a future article.</p>
  </blockquote>
  
  <p>This will supersede our original <code>TimeRequest</code> middleware, so we’ll add the timing logic here as well.</p>
  
  <pre><code class="language-go"><span class="kwd">package</span> <span class="pln">clientmw</span>
  <span class="com">// Log returns a RoundTripFunc that logs the request duration and status code. It uses the trace from the context as a prefix, if it exists. See Trace in this package and servermw.Log for the server-side implementation.</span>
  <span class="kwd">func</span> <span class="typ">Log</span><span class="pun">(</span><span class="pln">rt</span> <span class="pln">http</span><span class="pun">.</span><span class="typ">RoundTripper</span><span class="pun">,</span> <span class="pln">log</span> <span class="pun">*</span><span class="pln">log</span><span class="pun">.</span><span class="typ">Logger</span><span class="pun">)</span> <span class="typ">RoundTripFunc</span> <span class="pun">{</span>
      <span class="kwd">return</span> <span class="kwd">func</span><span class="pun">(</span><span class="pln">r</span> <span class="pun">*</span><span class="pln">http</span><span class="pun">.</span><span class="typ">Request</span><span class="pun">)</span> <span class="pun">(</span><span class="pun">*</span><span class="pln">http</span><span class="pun">.</span><span class="typ">Response</span><span class="pun">,</span> <span class="pln">error</span><span class="pun">)</span> <span class="pun">{</span>
          <span class="pln">defer</span> <span class="pln">logExec</span><span class="pun">(</span><span class="str">&#34;Log&#34;</span><span class="pun">)</span><span class="pun">(</span><span class="pun">)</span>
          <span class="pln">trace</span><span class="pun">,</span> <span class="pln">ok</span> <span class="pun">:</span><span class="pun">=</span> <span class="pln">ctxutil</span><span class="pun">.</span><span class="typ">Value</span><span class="pun">[</span><span class="typ">Trace</span><span class="pun">]</span><span class="pun">(</span><span class="pln">r</span><span class="pun">.</span><span class="typ">Context</span><span class="pun">(</span><span class="pun">)</span><span class="pun">)</span>
          <span class="kwd">if</span> <span class="pln">ok</span> <span class="pun">{</span>
              <span class="pln">prefix</span> <span class="pun">:</span><span class="pun">=</span> <span class="pln">fmt</span><span class="pun">.</span><span class="typ">Sprintf</span><span class="pun">(</span><span class="str">&#34;%s %s: [%s %s]: &#34;</span><span class="pun">,</span> <span class="pln">r</span><span class="pun">.</span><span class="typ">Method</span><span class="pun">,</span> <span class="pln">r</span><span class="pun">.</span><span class="typ">URL</span><span class="pun">,</span> <span class="pln">trace</span><span class="pun">.</span><span class="typ">TraceID</span><span class="pun">,</span> <span class="pln">trace</span><span class="pun">.</span><span class="typ">RequestID</span><span class="pun">)</span>
          <span class="pun">}</span> <span class="kwd">else</span> <span class="pun">{</span>
              <span class="pln">prefix</span> <span class="pun">:</span><span class="pun">=</span> <span class="pln">fmt</span><span class="pun">.</span><span class="typ">Sprintf</span><span class="pun">(</span><span class="str">&#34;%s %s: &#34;</span><span class="pun">,</span> <span class="pln">r</span><span class="pun">.</span><span class="typ">Method</span><span class="pun">,</span> <span class="pln">r</span><span class="pun">.</span><span class="typ">URL</span><span class="pun">)</span>
          <span class="pun">}</span>
  
          <span class="pln">logger</span> <span class="pun">:</span><span class="pun">=</span> <span class="pln">log</span><span class="pun">.</span><span class="typ">New</span><span class="pun">(</span><span class="pln">os</span><span class="pun">.</span><span class="typ">Stderr</span><span class="pun">,</span> <span class="pln">prefix</span><span class="pun">,</span> <span class="pln">log</span><span class="pun">.</span><span class="typ">LstdFlags</span> <span class="pun">|</span> <span class="pln">log</span><span class="pun">.</span><span class="typ">Lshortfile</span><span class="pun">)</span>
          <span class="pln">ctx</span> <span class="pun">:</span><span class="pun">=</span> <span class="pln">ctxutil</span><span class="pun">.</span><span class="typ">WithValue</span><span class="pun">(</span><span class="pln">r</span><span class="pun">.</span><span class="typ">Context</span><span class="pun">(</span><span class="pun">)</span><span class="pun">,</span> <span class="pln">logger</span><span class="pun">)</span> <span class="com">// add logger to context; retrieve with ctxutil.Value[log.Logger](ctx)</span>
          <span class="pln">r</span> <span class="pun">=</span> <span class="pln">r</span><span class="pun">.</span><span class="typ">WithContext</span><span class="pun">(</span><span class="pln">ctx</span><span class="pun">)</span> <span class="com">// add context to request</span>
  
          <span class="pln">start</span> <span class="pun">:</span><span class="pun">=</span> <span class="pln">time</span><span class="pun">.</span><span class="typ">Now</span><span class="pun">(</span><span class="pun">)</span>
          <span class="pln">resp</span><span class="pun">,</span> <span class="pln">err</span> <span class="pun">:</span><span class="pun">=</span> <span class="pln">rt</span><span class="pun">.</span><span class="typ">RoundTrip</span><span class="pun">(</span><span class="pln">r</span><span class="pun">)</span> <span class="com">// call next middleware, or http.DefaultTransport.RoundTrip if this is the last middleware</span>
          <span class="kwd">if</span> <span class="pln">err</span> <span class="pun">!</span><span class="pun">=</span> <span class="kwd">nil</span> <span class="pun">{</span>
              <span class="pln">logger</span><span class="pun">.</span><span class="typ">Printf</span><span class="pun">(</span><span class="str">&#34;errored after %s: %s&#34;</span><span class="pun">,</span> <span class="pln">time</span><span class="pun">.</span><span class="typ">Since</span><span class="pun">(</span><span class="pln">start</span><span class="pun">)</span><span class="pun">,</span> <span class="pln">err</span><span class="pun">)</span>
              <span class="kwd">return</span> <span class="kwd">nil</span><span class="pun">,</span> <span class="pln">err</span>
          <span class="pun">}</span>
          <span class="pln">logger</span><span class="pun">.</span><span class="typ">Printf</span><span class="pun">(</span><span class="str">&#34;%d %s in %s&#34;</span><span class="pun">,</span> <span class="pln">resp</span><span class="pun">.</span><span class="typ">StatusCode</span><span class="pun">,</span> <span class="pln">http</span><span class="pun">.</span><span class="typ">StatusText</span><span class="pun">(</span><span class="pln">resp</span><span class="pun">.</span><span class="typ">StatusCode</span><span class="pun">)</span><span class="pun">,</span> <span class="pln">time</span><span class="pun">.</span><span class="typ">Since</span><span class="pun">(</span><span class="pln">start</span><span class="pun">)</span><span class="pun">)</span>
          <span class="kwd">return</span> <span class="pln">resp</span><span class="pun">,</span> <span class="kwd">nil</span>
      <span class="pun">}</span>
  <span class="pun">}</span>
  </code></pre>
  
  <h3>Using Client Middleware</h3>
  
  <p>Using our middleware is simple. We just wrap the <code>http.DefaultTransport</code> with our middleware, and use it to build a new <code>http.Client</code>. It’s important to note that middleware is applied “first-in, last-out”; that is, the first middleware we apply will be the last one to run, and the last middleware we apply will be the first one to run!</p>
  
  <pre><code class="language-go"><span class="kwd">func</span> <span class="pln">clientMiddleware</span><span class="pun">(</span><span class="pun">)</span> <span class="pln">http</span><span class="pun">.</span><span class="typ">RoundTripper</span> <span class="pun">{</span>
      <span class="kwd">var</span> <span class="pln">rt</span> <span class="typ">RoundTripFunc</span> <span class="com">// specify the type as a RoundTripFunc, not a http.RoundTripper, so that we don&#39;t have to repeatedly wrap it in RoundTripFunc(rt)</span>
      <span class="kwd">const</span> <span class="pln">wait</span><span class="pun">,</span> <span class="pln">tries</span> <span class="pun">=</span> <span class="dec">10</span> <span class="pun">*</span> <span class="pln">time</span><span class="pun">.</span><span class="typ">Millisecond</span><span class="pun">,</span> <span class="dec">3</span>
      <span class="com">// first middleware applied will be the last one to run.</span>
      <span class="pln">rt</span> <span class="pun">=</span> <span class="pln">clientmw</span><span class="pun">.</span><span class="typ">RetryOn5xx</span><span class="pun">(</span><span class="pln">http</span><span class="pun">.</span><span class="typ">DefaultTransport</span><span class="pun">,</span> <span class="pln">wait</span><span class="pun">,</span> <span class="pln">tries</span><span class="pun">)</span> <span class="com">// retry on 5xx status codes</span>
      <span class="pln">rt</span> <span class="pun">=</span> <span class="pln">clientmw</span><span class="pun">.</span><span class="typ">Log</span><span class="pun">(</span><span class="pln">rt</span><span class="pun">)</span> <span class="com">// log request duration and status code; uses trace from next middleware</span>
      <span class="pln">rt</span> <span class="pun">=</span> <span class="pln">clientmw</span><span class="pun">.</span><span class="typ">Trace</span><span class="pun">(</span><span class="pln">rt</span><span class="pun">)</span> <span class="com">// add trace id to request header</span>
      <span class="kwd">return</span> <span class="pln">rt</span>
  <span class="pun">}</span>
  </code></pre>
  
  <p>Let’s test this out. The following full program, <code>clientmiddlewareex</code> makes a GET request to the specified URL, and prints the response body to stdout, using our middleware.</p>
  
  <pre><code class="language-go"><span class="com">// clientmiddlewareex makes a GET request to the specified URL, and prints the response body to stdout, using our middleware.</span>
  <span class="kwd">package</span> <span class="pln">main</span>
  
  <span class="kwd">import</span> <span class="pun">(</span>
      <span class="str">&#34;context&#34;</span>
      <span class="str">&#34;io&#34;</span>
      <span class="str">&#34;log&#34;</span>
      <span class="str">&#34;net/http&#34;</span>
      <span class="str">&#34;os&#34;</span>
      <span class="str">&#34;time&#34;</span>
  
      <span class="str">&#34;gitlab.com/efronlicht/blog/articles/backendbasics/cmd/clientmiddlewareex/clientmw&#34;</span>
  <span class="pun">)</span>
  
  
  <span class="kwd">func</span> <span class="pln">main</span><span class="pun">(</span><span class="pun">)</span> <span class="pun">{</span>
      <span class="kwd">if</span> <span class="pln">len</span><span class="pun">(</span><span class="pln">os</span><span class="pun">.</span><span class="typ">Args</span><span class="pun">)</span> <span class="pun">&lt;</span> <span class="dec">2</span> <span class="pun">{</span>
          <span class="pln">log</span><span class="pun">.</span><span class="typ">Fatal</span><span class="pun">(</span><span class="str">&#34;target url required&#34;</span><span class="pun">)</span>
      <span class="pun">}</span>
      <span class="pln">target</span> <span class="pun">:</span><span class="pun">=</span> <span class="pln">os</span><span class="pun">.</span><span class="typ">Args</span><span class="pun">[</span><span class="dec">1</span><span class="pun">]</span>
      <span class="pln">client</span> <span class="pun">:</span><span class="pun">=</span> <span class="pun">&amp;</span><span class="pln">http</span><span class="pun">.</span><span class="typ">Client</span><span class="pun">{</span><span class="typ">Transport</span><span class="pun">:</span> <span class="pln">clientMiddleware</span><span class="pun">(</span><span class="pun">)</span><span class="pun">,</span> <span class="typ">Timeout</span><span class="pun">:</span> <span class="dec">5</span> <span class="pun">*</span> <span class="pln">time</span><span class="pun">.</span><span class="typ">Second</span><span class="pun">}</span>
      <span class="pln">req</span><span class="pun">,</span> <span class="pln">err</span> <span class="pun">:</span><span class="pun">=</span> <span class="pln">http</span><span class="pun">.</span><span class="typ">NewRequestWithContext</span><span class="pun">(</span><span class="pln">context</span><span class="pun">.</span><span class="typ">TODO</span><span class="pun">(</span><span class="pun">)</span><span class="pun">,</span> <span class="str">&#34;GET&#34;</span><span class="pun">,</span> <span class="pln">target</span><span class="pun">,</span> <span class="kwd">nil</span><span class="pun">)</span>
      <span class="pln">resp</span><span class="pun">,</span> <span class="pln">err</span> <span class="pun">:</span><span class="pun">=</span> <span class="pln">client</span><span class="pun">.</span><span class="typ">Do</span><span class="pun">(</span><span class="pln">req</span><span class="pun">)</span>
      <span class="kwd">if</span> <span class="pln">err</span> <span class="pun">!</span><span class="pun">=</span> <span class="kwd">nil</span> <span class="pun">{</span>
          <span class="pln">log</span><span class="pun">.</span><span class="typ">Fatal</span><span class="pun">(</span><span class="pln">err</span><span class="pun">)</span>
      <span class="pun">}</span>
      <span class="pln">defer</span> <span class="pln">resp</span><span class="pun">.</span><span class="typ">Body</span><span class="pun">.</span><span class="typ">Close</span><span class="pun">(</span><span class="pun">)</span>
      <span class="pln">io</span><span class="pun">.</span><span class="typ">Copy</span><span class="pun">(</span><span class="pln">os</span><span class="pun">.</span><span class="typ">Stdout</span><span class="pun">,</span> <span class="pln">resp</span><span class="pun">.</span><span class="typ">Body</span><span class="pun">)</span>
  <span class="pun">}</span>
  </code></pre>
  
  <p>IN:</p>
  
  <pre><code class="language-bash"><span class="pln">go</span> <span class="pln">run</span> <span class="pln">clientmiddlewareex</span><span class="pun">.</span><span class="pln">go</span> <span class="pln">https</span><span class="pun">:</span><span class="com">//eblog.fly.dev</span>
  </code></pre>
  
  <p>OUT:</p>
  
  <pre><code class="language-text"><span class="dec">2023</span><span class="pun">/</span><span class="dec">09</span><span class="pun">/</span><span class="dec">12</span> <span class="dec">06</span><span class="pun">:</span><span class="dec">43</span><span class="pun">:</span><span class="dec">53</span> <span class="pln">middleware</span><span class="pun">:</span> <span class="kwd">begin</span> <span class="pln">trace</span>
  <span class="dec">2023</span><span class="pun">/</span><span class="dec">09</span><span class="pun">/</span><span class="dec">12</span> <span class="dec">06</span><span class="pun">:</span><span class="dec">43</span><span class="pun">:</span><span class="dec">53</span> <span class="pln">middleware</span><span class="pun">:</span> <span class="kwd">begin</span> <span class="pln">log</span>
  <span class="dec">2023</span><span class="pun">/</span><span class="dec">09</span><span class="pun">/</span><span class="dec">12</span> <span class="dec">06</span><span class="pun">:</span><span class="dec">43</span><span class="pun">:</span><span class="dec">53</span> <span class="pln">middleware</span><span class="pun">:</span> <span class="kwd">begin</span> <span class="pln">retryOn5xx</span>
  <span class="dec">2023</span><span class="pun">/</span><span class="dec">09</span><span class="pun">/</span><span class="dec">12</span> <span class="dec">06</span><span class="pun">:</span><span class="dec">43</span><span class="pun">:</span><span class="dec">53</span> <span class="pln">middleware</span><span class="pun">:</span> <span class="kwd">end</span> <span class="pln">retryOn5xx</span>
  <span class="typ">GET</span> <span class="pln">https</span><span class="pun">:</span><span class="com">//eblog.fly.dev/index.html: [8c63dffb-2901-4ebc-bd7c-73ea843f89e2 9a56e7e8-062f-42db-b087-7018cd6a3610]: 2023/09/12 06:43:53 clientmw.go:103: 200 OK in 88.321876ms</span>
  <span class="dec">2023</span><span class="pun">/</span><span class="dec">09</span><span class="pun">/</span><span class="dec">12</span> <span class="dec">06</span><span class="pun">:</span><span class="dec">43</span><span class="pun">:</span><span class="dec">53</span> <span class="pln">middleware</span><span class="pun">:</span> <span class="kwd">end</span> <span class="pln">log</span>
  <span class="dec">2023</span><span class="pun">/</span><span class="dec">09</span><span class="pun">/</span><span class="dec">12</span> <span class="dec">06</span><span class="pun">:</span><span class="dec">43</span><span class="pun">:</span><span class="dec">53</span> <span class="pln">middleware</span><span class="pun">:</span> <span class="kwd">end</span> <span class="pln">trace</span>
  </code></pre>
  
  <p>Checking my server logs, I note that the request was received with the following headers:</p>
  
  <pre><code class="language-text"><span class="typ">X</span><span class="pun">-</span><span class="typ">Request</span><span class="pun">-</span><span class="typ">Id</span><span class="pun">:</span> <span class="dec">9</span><span class="pln">a56e7e8</span><span class="pun">-</span><span class="dec">062</span><span class="pln">f</span><span class="pun">-</span><span class="dec">42</span><span class="pln">db</span><span class="pun">-</span><span class="pln">b087</span><span class="pun">-</span><span class="dec">7018</span><span class="pln">cd6a3610</span>
  <span class="typ">X</span><span class="pun">-</span><span class="typ">Trace</span><span class="pun">-</span><span class="typ">Id</span><span class="pun">:</span> <span class="dec">8</span><span class="pln">c63dffb</span><span class="pun">-</span><span class="dec">2901</span><span class="pun">-</span><span class="dec">4e</span><span class="pln">bc</span><span class="pun">-</span><span class="pln">bd7c</span><span class="pun">-</span><span class="dec">73e</span><span class="pln">a843f89e2</span>
  </code></pre>
  
  <p>Looks like everything is working as expected. Let’s move on to <strong>server middleware</strong>.</p>
  
  <blockquote>
  <p>A brief final note on client middleware: the <a href="https://pkg.go.dev/net/http#RoundTripper">documentation for RoundTripper</a> says that it shouldn’t modify the request or response. I disagree with this; it’s simpler and easier to intercept the RoundTripper than to build another layer <em>on top</em> of <strong>http.Client</strong>. Over the years, this seems to be the consensus for backend development in Go. If you disagree, you can always build your own layer <strong>on top</strong> of http.Client that wraps it’s <code>Do()</code> method instead, like so:</p>
  
  <pre><code class="language-go"><span class="pun">&gt;</span>   <span class="kwd">type</span> <span class="typ">HTTPDoer</span> <span class="kwd">interface</span> <span class="pun">{</span> <span class="typ">Do</span><span class="pun">(</span><span class="pun">*</span><span class="pln">http</span><span class="pun">.</span><span class="typ">Request</span><span class="pun">)</span> <span class="pun">(</span><span class="pun">*</span><span class="pln">http</span><span class="pun">.</span><span class="typ">Response</span><span class="pun">,</span> <span class="pln">error</span><span class="pun">)</span> <span class="pun">}</span>
  <span class="pun">&gt;</span>   <span class="kwd">type</span> <span class="typ">HTTPDoerFunc</span> <span class="kwd">func</span><span class="pun">(</span><span class="pun">*</span><span class="pln">http</span><span class="pun">.</span><span class="typ">Request</span><span class="pun">)</span> <span class="pun">(</span><span class="pun">*</span><span class="pln">http</span><span class="pun">.</span><span class="typ">Response</span><span class="pun">,</span> <span class="pln">error</span><span class="pun">)</span>
  <span class="pun">&gt;</span>   <span class="kwd">func</span> <span class="pun">(</span><span class="pln">f</span> <span class="typ">HTTPDoerFunc</span><span class="pun">)</span> <span class="typ">Do</span><span class="pun">(</span><span class="pln">r</span> <span class="pun">*</span><span class="pln">http</span><span class="pun">.</span><span class="typ">Request</span><span class="pun">)</span> <span class="pun">(</span><span class="pun">*</span><span class="pln">http</span><span class="pun">.</span><span class="typ">Response</span><span class="pun">,</span> <span class="pln">error</span><span class="pun">)</span> <span class="pun">{</span> <span class="kwd">return</span> <span class="pln">f</span><span class="pun">(</span><span class="pln">r</span><span class="pun">)</span> <span class="pun">}</span>
  <span class="pun">&gt;</span>   <span class="kwd">var</span> <span class="pln">_</span> <span class="typ">HTTPDoer</span> <span class="pun">=</span> <span class="typ">HTTPDoerFunc</span><span class="pun">(</span><span class="kwd">nil</span><span class="pun">)</span> <span class="com">// assert that HTTPDoerFunc implements HTTPDoer at compile time</span>
  <span class="pun">&gt;</span>   <span class="kwd">var</span> <span class="pln">_</span> <span class="typ">HTTPDoer</span> <span class="pun">=</span> <span class="pun">(</span><span class="pun">*</span><span class="pln">http</span><span class="pun">.</span><span class="typ">Client</span><span class="pun">)</span><span class="pun">(</span><span class="kwd">nil</span><span class="pun">)</span> <span class="com">// assert that http.Client implements HTTPDoer at compile time</span>
  <span class="pun">&gt;</span>   <span class="str">``</span><span class="str">`
  &gt;
  
  ### Server Middleware
  
  Server middleware is very similar to Client middleware. Rather than wrapping a `</span><span class="typ">RoundTripper</span><span class="str">`, we wrap a `</span><span class="pln">http</span><span class="pun">.</span><span class="typ">Handler</span><span class="str">`. [We covered this in the last article](https://eblog.fly.dev/backendbasics2.html), but let&#39;s briefly review:
  
  The [`</span><span class="pln">http</span><span class="pun">.</span><span class="typ">Handler</span><span class="str">`](https://pkg.go.dev/net/http#Handler) interface looks like this:
  
  `</span><span class="str">``</span><span class="pln">go</span>
  <span class="kwd">type</span> <span class="typ">Handler</span> <span class="kwd">interface</span> <span class="pun">{</span>
      <span class="typ">ServeHTTP</span><span class="pun">(</span><span class="pln">http</span><span class="pun">.</span><span class="typ">ResponseWriter</span><span class="pun">,</span> <span class="pun">*</span><span class="pln">http</span><span class="pun">.</span><span class="typ">Request</span><span class="pun">)</span>
  <span class="pun">}</span>
  </code></pre>
  </blockquote>
  
  <p>We don’t need to define our own <code>HandlerFunc</code> type, because <a href="https://pkg.go.dev/net/http#HandlerFunc">the standard library already provides one</a>.</p>
  
  <pre><code class="language-go"><span class="com">// HandlerFunc adapts a function to work as a http.Handler.</span>
  <span class="kwd">type</span> <span class="typ">HandlerFunc</span> <span class="kwd">func</span><span class="pun">(</span><span class="pln">http</span><span class="pun">.</span><span class="typ">ResponseWriter</span><span class="pun">,</span> <span class="pun">*</span><span class="pln">http</span><span class="pun">.</span><span class="typ">Request</span><span class="pun">)</span>
  <span class="com">// ServeHTTP calls f(w, r)</span>
  <span class="kwd">func</span> <span class="pun">(</span><span class="pln">f</span> <span class="typ">HandlerFunc</span><span class="pun">)</span> <span class="typ">ServeHTTP</span><span class="pun">(</span><span class="pln">w</span> <span class="pln">http</span><span class="pun">.</span><span class="typ">ResponseWriter</span><span class="pun">,</span> <span class="pln">r</span> <span class="pun">*</span><span class="pln">http</span><span class="pun">.</span><span class="typ">Request</span><span class="pun">)</span> <span class="pun">{</span> <span class="pln">f</span><span class="pun">(</span><span class="pln">w</span><span class="pun">,</span> <span class="pln">r</span><span class="pun">)</span> <span class="pun">}</span>
  </code></pre>
  
  <p>We can use this to build our own middleware by wrapping handlers in a closure and returning a <code>HandlerFunc</code>, the same way wrapped <code>RoundTripper</code>s in a closure and returned a <code>RoundTripFunc</code>.</p>
  
  <p>Let’s add traces and logs to our server. The implementation is broadly symmetrical to the client middleware:</p>
  
  <pre><code class="language-go">
  <span class="kwd">package</span> <span class="pln">servermw</span>
  
  <span class="kwd">import</span> <span class="pun">(</span>
      <span class="str">&#34;fmt&#34;</span>
      <span class="str">&#34;log&#34;</span>
      <span class="str">&#34;net/http&#34;</span>
      <span class="str">&#34;os&#34;</span>
  
      <span class="str">&#34;github.com/google/uuid&#34;</span>
      <span class="str">&#34;gitlab.com/efronlicht/blog/articles/backendbasics/cmd/ctxutil&#34;</span>
      <span class="str">&#34;gitlab.com/efronlicht/blog/articles/backendbasics/cmd/trace&#34;</span>
  <span class="pun">)</span>
  
  <span class="com">// Trace returns a middleware that injects a trace into the request context,</span>
  <span class="com">// picking up the trace id from the request header if it exists, or generating a new one if it doesn&#39;t.</span>
  <span class="com">// See clientmw.Trace for the client-side implementation.</span>
  <span class="kwd">func</span> <span class="typ">Trace</span><span class="pun">(</span><span class="pln">h</span> <span class="pln">http</span><span class="pun">.</span><span class="typ">Handler</span><span class="pun">)</span> <span class="pln">http</span><span class="pun">.</span><span class="typ">HandlerFunc</span> <span class="pun">{</span>
      <span class="kwd">return</span> <span class="kwd">func</span><span class="pun">(</span><span class="pln">w</span> <span class="pln">http</span><span class="pun">.</span><span class="typ">ResponseWriter</span><span class="pun">,</span> <span class="pln">r</span> <span class="pun">*</span><span class="pln">http</span><span class="pun">.</span><span class="typ">Request</span><span class="pun">)</span> <span class="pun">{</span>
          <span class="pln">ctx</span> <span class="pun">:</span><span class="pun">=</span> <span class="pln">r</span><span class="pun">.</span><span class="typ">Context</span><span class="pun">(</span><span class="pun">)</span>
          <span class="com">// get trace/req id from request header, or generate new ones if they don&#39;t exist</span>
          <span class="pln">traceID</span><span class="pun">,</span> <span class="pln">err</span> <span class="pun">:</span><span class="pun">=</span> <span class="pln">uuid</span><span class="pun">.</span><span class="typ">Parse</span><span class="pun">(</span><span class="pln">r</span><span class="pun">.</span><span class="typ">Header</span><span class="pun">.</span><span class="typ">Get</span><span class="pun">(</span><span class="str">&#34;X-Trace-Id&#34;</span><span class="pun">)</span><span class="pun">)</span>
          <span class="kwd">if</span> <span class="pln">err</span> <span class="pun">!</span><span class="pun">=</span> <span class="kwd">nil</span> <span class="pun">{</span>
              <span class="pln">traceID</span> <span class="pun">=</span> <span class="pln">uuid</span><span class="pun">.</span><span class="typ">New</span><span class="pun">(</span><span class="pun">)</span>
          <span class="pun">}</span>
          <span class="pln">reqID</span><span class="pun">,</span> <span class="pln">err</span> <span class="pun">:</span><span class="pun">=</span> <span class="pln">uuid</span><span class="pun">.</span><span class="typ">Parse</span><span class="pun">(</span><span class="pln">r</span><span class="pun">.</span><span class="typ">Header</span><span class="pun">.</span><span class="typ">Get</span><span class="pun">(</span><span class="str">&#34;X-Request-Id&#34;</span><span class="pun">)</span><span class="pun">)</span>
          <span class="kwd">if</span> <span class="pln">err</span> <span class="pun">!</span><span class="pun">=</span> <span class="kwd">nil</span> <span class="pun">{</span>
              <span class="pln">reqID</span> <span class="pun">=</span> <span class="pln">uuid</span><span class="pun">.</span><span class="typ">New</span><span class="pun">(</span><span class="pun">)</span>
          <span class="pun">}</span>
  
          <span class="com">// pop trace into context, and pop context into request</span>
          <span class="pln">trace</span> <span class="pun">:</span><span class="pun">=</span> <span class="pln">trace</span><span class="pun">.</span><span class="typ">Trace</span><span class="pun">{</span><span class="typ">TraceID</span><span class="pun">:</span> <span class="pln">traceID</span><span class="pun">,</span> <span class="typ">RequestID</span><span class="pun">:</span> <span class="pln">reqID</span><span class="pun">}</span>
          <span class="pln">ctx</span> <span class="pun">=</span> <span class="pln">ctxutil</span><span class="pun">.</span><span class="typ">WithValue</span><span class="pun">(</span><span class="pln">ctx</span><span class="pun">,</span> <span class="pln">trace</span><span class="pun">)</span>
          <span class="pln">r</span> <span class="pun">=</span> <span class="pln">r</span><span class="pun">.</span><span class="typ">WithContext</span><span class="pun">(</span><span class="pln">ctx</span><span class="pun">)</span>
  
          <span class="com">// serve the request using the populated context</span>
          <span class="pln">h</span><span class="pun">.</span><span class="typ">ServeHTTP</span><span class="pun">(</span><span class="pln">w</span><span class="pun">,</span> <span class="pln">r</span><span class="pun">)</span>
      <span class="pun">}</span>
  
  <span class="pun">}</span>
  
  <span class="com">// Log returns a middleware that injects a logger into the request context. See clientmw.Log for the client-side implementation.</span>
  <span class="com">//  It uses the trace from the context as a prefix, if it exists. For most servers, use a structured logger instead; that API is outside the scope of this article.</span>
  <span class="kwd">func</span> <span class="typ">Log</span><span class="pun">(</span><span class="pln">h</span> <span class="pln">http</span><span class="pun">.</span><span class="typ">Handler</span><span class="pun">)</span> <span class="pln">http</span><span class="pun">.</span><span class="typ">HandlerFunc</span> <span class="pun">{</span>
      <span class="kwd">return</span> <span class="kwd">func</span><span class="pun">(</span><span class="pln">w</span> <span class="pln">http</span><span class="pun">.</span><span class="typ">ResponseWriter</span><span class="pun">,</span> <span class="pln">r</span> <span class="pun">*</span><span class="pln">http</span><span class="pun">.</span><span class="typ">Request</span><span class="pun">)</span> <span class="pun">{</span>
          <span class="pln">trace</span><span class="pun">,</span> <span class="pln">ok</span> <span class="pun">:</span><span class="pun">=</span> <span class="pln">ctxutil</span><span class="pun">.</span><span class="typ">Value</span><span class="pun">[</span><span class="pln">trace</span><span class="pun">.</span><span class="typ">Trace</span><span class="pun">]</span><span class="pun">(</span><span class="pln">r</span><span class="pun">.</span><span class="typ">Context</span><span class="pun">(</span><span class="pun">)</span><span class="pun">)</span>
          <span class="kwd">var</span> <span class="pln">prefix</span> <span class="pln">string</span>
          <span class="kwd">if</span> <span class="pln">ok</span> <span class="pun">{</span>
              <span class="com">// like GET /articles: [trace-id request-id]:</span>
              <span class="pln">prefix</span> <span class="pun">=</span> <span class="pln">fmt</span><span class="pun">.</span><span class="typ">Sprintf</span><span class="pun">(</span><span class="str">&#34;%s %s: [%s %s]: &#34;</span><span class="pun">,</span> <span class="pln">r</span><span class="pun">.</span><span class="typ">Method</span><span class="pun">,</span> <span class="pln">r</span><span class="pun">.</span><span class="typ">URL</span><span class="pun">,</span> <span class="pln">trace</span><span class="pun">.</span><span class="typ">TraceID</span><span class="pun">,</span> <span class="pln">trace</span><span class="pun">.</span><span class="typ">RequestID</span><span class="pun">)</span>
          <span class="pun">}</span> <span class="kwd">else</span> <span class="pun">{</span>
              <span class="com">// like GET /articles:</span>
              <span class="pln">prefix</span> <span class="pun">=</span> <span class="pln">fmt</span><span class="pun">.</span><span class="typ">Sprintf</span><span class="pun">(</span><span class="str">&#34;%s %s: &#34;</span><span class="pun">,</span> <span class="pln">r</span><span class="pun">.</span><span class="typ">Method</span><span class="pun">,</span> <span class="pln">r</span><span class="pun">.</span><span class="typ">URL</span><span class="pun">)</span>
          <span class="pun">}</span>
          <span class="pln">logger</span> <span class="pun">:</span><span class="pun">=</span> <span class="pln">log</span><span class="pun">.</span><span class="typ">New</span><span class="pun">(</span><span class="pln">os</span><span class="pun">.</span><span class="typ">Stderr</span><span class="pun">,</span> <span class="pln">prefix</span><span class="pun">,</span> <span class="pln">log</span><span class="pun">.</span><span class="typ">LstdFlags</span><span class="pun">)</span>
          <span class="pln">ctx</span> <span class="pun">:</span><span class="pun">=</span> <span class="pln">ctxutil</span><span class="pun">.</span><span class="typ">WithValue</span><span class="pun">(</span><span class="pln">r</span><span class="pun">.</span><span class="typ">Context</span><span class="pun">(</span><span class="pun">)</span><span class="pun">,</span> <span class="pln">logger</span><span class="pun">)</span>
          <span class="pln">r</span> <span class="pun">=</span> <span class="pln">r</span><span class="pun">.</span><span class="typ">Clone</span><span class="pun">(</span><span class="pln">ctx</span><span class="pun">)</span>
          <span class="pln">h</span><span class="pun">.</span><span class="typ">ServeHTTP</span><span class="pun">(</span><span class="pln">w</span><span class="pun">,</span> <span class="pln">r</span><span class="pun">)</span>
      <span class="pun">}</span>
  <span class="pun">}</span>
  </code></pre>
  
  <p>Some server middleware may want to track or intercept writes to the response headers or body. Let’s list a few examples:</p>
  
  <ul>
  <li>Automatically gzip-encode writes to the body if the client sent an `<code>Accept-Encoding: gzip</code> header.</li>
  <li>Track the status code of the response so we can add it to our logs or metrics.</li>
  <li>Track the total number of bytes written to the response body so we can add it to our metrics.</li>
  <li>Rewrite certain headers so as not to leak internal information to the client.</li>
  </ul>
  
  <p>We can do this by wrapping the <code>ResponseWriter</code> in a custom struct that implements the <code>http.ResponseWriter</code> interface. This is a bit more complex than wrapping a <code>RoundTripper</code> or <code>Handler</code>. It’s easiest to demonstrate with an example.</p>
  
  <p>The following middleware, <code>RecordResponse</code>  and it’s associated <code>RecordingResponseWriter</code> struct will track the status code and bytes written to the response body, and log them when the request is complete.</p>
  
  <pre><code class="language-go"><span class="kwd">package</span> <span class="pln">servermw</span>
  
  <span class="com">// RecordResponse returns a middleware that records the response status code and total bytes written to the response.</span>
  <span class="kwd">func</span> <span class="typ">RecordResponse</span><span class="pun">(</span><span class="pln">h</span> <span class="pln">http</span><span class="pun">.</span><span class="typ">Handler</span><span class="pun">)</span> <span class="pln">http</span><span class="pun">.</span><span class="typ">HandlerFunc</span> <span class="pun">{</span>
      <span class="kwd">return</span> <span class="kwd">func</span><span class="pun">(</span><span class="pln">w</span> <span class="pln">http</span><span class="pun">.</span><span class="typ">ResponseWriter</span><span class="pun">,</span> <span class="pln">r</span> <span class="pun">*</span><span class="pln">http</span><span class="pun">.</span><span class="typ">Request</span><span class="pun">)</span> <span class="pun">{</span>
          <span class="pln">rrw</span> <span class="pun">:</span><span class="pun">=</span> <span class="pun">&amp;</span><span class="typ">RecordingResponseWriter</span><span class="pun">{</span><span class="typ">RW</span><span class="pun">:</span> <span class="pln">w</span><span class="pun">}</span>
          <span class="pln">start</span> <span class="pun">:</span><span class="pun">=</span> <span class="pln">time</span><span class="pun">.</span><span class="typ">Now</span><span class="pun">(</span><span class="pun">)</span>
          <span class="pln">h</span><span class="pun">.</span><span class="typ">ServeHTTP</span><span class="pun">(</span><span class="pln">rrw</span><span class="pun">,</span> <span class="pln">r</span><span class="pun">)</span>
          <span class="pln">elapsed</span> <span class="pun">:</span><span class="pun">=</span> <span class="pln">time</span><span class="pun">.</span><span class="typ">Since</span><span class="pun">(</span><span class="pln">start</span><span class="pun">)</span>
          <span class="com">// use the logger from the context if it exists</span>
          <span class="pln">logger</span><span class="pun">,</span> <span class="pln">ok</span> <span class="pun">:</span><span class="pun">=</span> <span class="pln">ctxutil</span><span class="pun">.</span><span class="typ">Value</span><span class="pun">[</span><span class="pun">*</span><span class="pln">log</span><span class="pun">.</span><span class="typ">Logger</span><span class="pun">]</span><span class="pun">(</span><span class="pln">r</span><span class="pun">.</span><span class="typ">Context</span><span class="pun">(</span><span class="pun">)</span><span class="pun">)</span>
          <span class="kwd">if</span> <span class="pun">!</span><span class="pln">ok</span> <span class="pun">{</span>
              <span class="com">// fall back to the default logger</span>
              <span class="pln">log</span><span class="pun">.</span><span class="typ">Printf</span><span class="pun">(</span><span class="str">&#34;%s %s: %d %s: %d bytes in %s&#34;</span><span class="pun">,</span> <span class="pln">r</span><span class="pun">.</span><span class="typ">Method</span><span class="pun">,</span> <span class="pln">r</span><span class="pun">.</span><span class="typ">URL</span><span class="pun">,</span> <span class="pln">rrw</span><span class="pun">.</span><span class="typ">StatusCode</span><span class="pun">,</span> <span class="pln">http</span><span class="pun">.</span><span class="typ">StatusText</span><span class="pun">(</span><span class="pln">rrw</span><span class="pun">.</span><span class="typ">StatusCode</span><span class="pun">)</span><span class="pun">,</span> <span class="pln">rrw</span><span class="pun">.</span><span class="typ">Bytes</span><span class="pun">,</span> <span class="pln">elapsed</span><span class="pun">)</span>
              <span class="kwd">return</span>
          <span class="pun">}</span>
          <span class="pln">logger</span><span class="pun">.</span><span class="typ">Printf</span><span class="pun">(</span><span class="str">&#34;%d %s: %d bytes in %s&#34;</span><span class="pun">,</span> <span class="pln">rrw</span><span class="pun">.</span><span class="typ">StatusCode</span><span class="pun">,</span> <span class="pln">http</span><span class="pun">.</span><span class="typ">StatusText</span><span class="pun">(</span><span class="pln">rrw</span><span class="pun">.</span><span class="typ">StatusCode</span><span class="pun">)</span><span class="pun">,</span> <span class="pln">rrw</span><span class="pun">.</span><span class="typ">Bytes</span><span class="pun">,</span> <span class="pln">elapsed</span><span class="pun">)</span>
      <span class="pun">}</span>
  <span class="pun">}</span>
  
  <span class="com">// RecordingResponseWriter is an http.ResponseWriter that keeps track of the status code and total body bytes written to it.</span>
  <span class="kwd">type</span> <span class="typ">RecordingResponseWriter</span> <span class="kwd">struct</span> <span class="pun">{</span>
      <span class="com">// underlying response writer</span>
      <span class="typ">RW</span>         <span class="pln">http</span><span class="pun">.</span><span class="typ">ResponseWriter</span>
      <span class="typ">StatusCode</span> <span class="kwd">int</span> <span class="com">// first status code written to the response writer</span>
      <span class="typ">Bytes</span>      <span class="kwd">int</span> <span class="com">// total bytes written</span>
  <span class="pun">}</span>
  
  <span class="com">// WriteHeader sets the status code, if it hasn&#39;t been set already.</span>
  <span class="kwd">func</span> <span class="pun">(</span><span class="pln">w</span> <span class="pun">*</span><span class="typ">RecordingResponseWriter</span><span class="pun">)</span> <span class="typ">WriteHeader</span><span class="pun">(</span><span class="pln">statusCode</span> <span class="kwd">int</span><span class="pun">)</span> <span class="pun">{</span>
      <span class="kwd">if</span> <span class="pln">w</span><span class="pun">.</span><span class="typ">StatusCode</span> <span class="pun">=</span><span class="pun">=</span> <span class="dec">0</span> <span class="pun">{</span> <span class="com">// first status code written; track it</span>
          <span class="pln">w</span><span class="pun">.</span><span class="typ">StatusCode</span> <span class="pun">=</span> <span class="pln">statusCode</span>
      <span class="pun">}</span>
      <span class="pln">w</span><span class="pun">.</span><span class="typ">RW</span><span class="pun">.</span><span class="typ">WriteHeader</span><span class="pun">(</span><span class="pln">statusCode</span><span class="pun">)</span> <span class="com">// write to underlying response writer</span>
  <span class="pun">}</span>
  
  <span class="com">// Header just returns the underlying response writer&#39;s header.</span>
  <span class="kwd">func</span> <span class="pun">(</span><span class="pln">w</span> <span class="pun">*</span><span class="typ">RecordingResponseWriter</span><span class="pun">)</span> <span class="typ">Header</span><span class="pun">(</span><span class="pun">)</span> <span class="pln">http</span><span class="pun">.</span><span class="typ">Header</span> <span class="pun">{</span> <span class="kwd">return</span> <span class="pln">w</span><span class="pun">.</span><span class="typ">RW</span><span class="pun">.</span><span class="typ">Header</span><span class="pun">(</span><span class="pun">)</span> <span class="pun">}</span>
  
  <span class="com">// Write writes the given bytes to the underlying response writer, setting the status code to 200 if it hasn&#39;t been set already.</span>
  <span class="kwd">func</span> <span class="pun">(</span><span class="pln">w</span> <span class="pun">*</span><span class="typ">RecordingResponseWriter</span><span class="pun">)</span> <span class="typ">Write</span><span class="pun">(</span><span class="pln">b</span> <span class="pun">[</span><span class="pun">]</span><span class="kwd">byte</span><span class="pun">)</span> <span class="pun">(</span><span class="kwd">int</span><span class="pun">,</span> <span class="pln">error</span><span class="pun">)</span> <span class="pun">{</span>
      <span class="kwd">if</span> <span class="pln">w</span><span class="pun">.</span><span class="typ">StatusCode</span> <span class="pun">=</span><span class="pun">=</span> <span class="dec">0</span> <span class="pun">{</span>
          <span class="pln">w</span><span class="pun">.</span><span class="typ">WriteHeader</span><span class="pun">(</span><span class="pln">http</span><span class="pun">.</span><span class="typ">StatusOK</span><span class="pun">)</span>
      <span class="pun">}</span>
      <span class="pln">n</span><span class="pun">,</span> <span class="pln">err</span> <span class="pun">:</span><span class="pun">=</span> <span class="pln">w</span><span class="pun">.</span><span class="typ">RW</span><span class="pun">.</span><span class="typ">Write</span><span class="pun">(</span><span class="pln">b</span><span class="pun">)</span> <span class="com">// write to underlying response writer</span>
      <span class="pln">w</span><span class="pun">.</span><span class="typ">Bytes</span> <span class="pun">+</span><span class="pun">=</span> <span class="pln">n</span>            <span class="com">// update total bytes written</span>
      <span class="kwd">return</span> <span class="pln">n</span><span class="pun">,</span> <span class="pln">err</span>
  <span class="pun">}</span>
  </code></pre>
  
  <p>This <code>RecordingResponseWriter</code> is broadly similar to the one implemented by the standard library’s <a href="https://pkg.go.dev/net/http/httptest#ResponseRecorder"><code>httptest.ResponseRecorder</code></a>. As usual, Go’s standard library uses a small set of simple interfaces to cover a wide range of use cases.</p>
  
  <p>Let’s add one last server middleware, <code>Recovery</code>, to protect our server from unexpected panics. While ideally we would write perfect code without panics, everyone makes mistakes, and it would be good to be able to continue <em>some</em> service even if one of our endpoints panics under certain conditions.</p>
  
  <p>As before, our Recovery handle takes advantage of the log injected into the context (if it exists). <strong>It’s good to have a ‘fallback’ for any context value you use, since context values are not visible in the type signature or guaranteed to exist.</strong></p>
  
  <pre><code class="language-go"><span class="com">// Recovery returns a middleware that recovers from panics, writing a 500 status code and &#34;internal server error&#34; message to the response,</span>
  <span class="com">// and logging the panic and associated stack trace.</span>
  <span class="kwd">func</span> <span class="typ">Recovery</span><span class="pun">(</span><span class="pln">h</span> <span class="pln">http</span><span class="pun">.</span><span class="typ">Handler</span><span class="pun">)</span> <span class="pln">http</span><span class="pun">.</span><span class="typ">HandlerFunc</span> <span class="pun">{</span>
      <span class="kwd">return</span> <span class="kwd">func</span><span class="pun">(</span><span class="pln">w</span> <span class="pln">http</span><span class="pun">.</span><span class="typ">ResponseWriter</span><span class="pun">,</span> <span class="pln">r</span> <span class="pun">*</span><span class="pln">http</span><span class="pun">.</span><span class="typ">Request</span><span class="pun">)</span> <span class="pun">{</span>
          <span class="pln">defer</span> <span class="kwd">func</span><span class="pun">(</span><span class="pun">)</span> <span class="pun">{</span> <span class="com">// recover from panic</span>
              <span class="kwd">if</span> <span class="pln">err</span> <span class="pun">:</span><span class="pun">=</span> <span class="pln">recover</span><span class="pun">(</span><span class="pun">)</span><span class="pun">;</span> <span class="pln">err</span> <span class="pun">!</span><span class="pun">=</span> <span class="kwd">nil</span> <span class="pun">{</span> <span class="com">// recover from panic</span>
                  <span class="pln">stack</span> <span class="pun">:</span><span class="pun">=</span> <span class="pln">debug</span><span class="pun">.</span><span class="typ">Stack</span><span class="pun">(</span><span class="pun">)</span>
                  <span class="pln">logger</span><span class="pun">,</span> <span class="pln">ok</span> <span class="pun">:</span><span class="pun">=</span> <span class="pln">ctxutil</span><span class="pun">.</span><span class="typ">Value</span><span class="pun">[</span><span class="pun">*</span><span class="pln">log</span><span class="pun">.</span><span class="typ">Logger</span><span class="pun">]</span><span class="pun">(</span><span class="pln">r</span><span class="pun">.</span><span class="typ">Context</span><span class="pun">(</span><span class="pun">)</span><span class="pun">)</span>
                  <span class="kwd">if</span> <span class="pun">!</span><span class="pln">ok</span> <span class="pun">{</span> <span class="com">// use the default logger</span>
                      <span class="pln">log</span><span class="pun">.</span><span class="typ">Printf</span><span class="pun">(</span><span class="str">&#34;%s %s: panic: %v\n%s&#34;</span><span class="pun">,</span> <span class="pln">r</span><span class="pun">.</span><span class="typ">Method</span><span class="pun">,</span> <span class="pln">r</span><span class="pun">.</span><span class="typ">URL</span><span class="pun">,</span> <span class="pln">err</span><span class="pun">,</span> <span class="pln">stack</span><span class="pun">)</span>
                  <span class="pun">}</span> <span class="kwd">else</span> <span class="pun">{</span> <span class="com">// use the logger from the context</span>
                      <span class="pln">logger</span><span class="pun">.</span><span class="typ">Printf</span><span class="pun">(</span><span class="str">&#34;panic: %v\n%s&#34;</span><span class="pun">,</span> <span class="pln">err</span><span class="pun">,</span> <span class="pln">stack</span><span class="pun">)</span>
                  <span class="pun">}</span>
                  <span class="com">// write 500 status code and &#34;internal server error&#34; message to response so it doesn&#39;t hang</span>
                  <span class="pln">w</span><span class="pun">.</span><span class="typ">WriteHeader</span><span class="pun">(</span><span class="pln">http</span><span class="pun">.</span><span class="typ">StatusInternalServerError</span><span class="pun">)</span>
                  <span class="pln">_</span><span class="pun">,</span> <span class="pln">_</span> <span class="pun">=</span> <span class="pln">w</span><span class="pun">.</span><span class="typ">Write</span><span class="pun">(</span><span class="pun">[</span><span class="pun">]</span><span class="kwd">byte</span><span class="pun">(</span><span class="str">&#34;internal server error&#34;</span><span class="pun">)</span><span class="pun">)</span>
              <span class="pun">}</span>
          <span class="pun">}</span><span class="pun">(</span><span class="pun">)</span>
          <span class="pln">h</span><span class="pun">.</span><span class="typ">ServeHTTP</span><span class="pun">(</span><span class="pln">w</span><span class="pun">,</span> <span class="pln">r</span><span class="pun">)</span>
      <span class="pun">}</span>
  <span class="pun">}</span>
  </code></pre>
  
  <h3>Using Server Middleware</h3>
  
  <p>The following complete program, <code>servermiddlewareex</code>, implements a simple server that serves two endpoints. <code>GET /time</code> returns the current time in RFC3339 format, and <code>GET /panic</code> panics. Any other endpoint returns a 404.</p>
  
  <pre><code class="language-go"><span class="kwd">package</span> <span class="pln">main</span>
  
  <span class="kwd">import</span> <span class="pun">(</span>
      <span class="str">&#34;errors&#34;</span>
      <span class="str">&#34;flag&#34;</span>
      <span class="str">&#34;fmt&#34;</span>
      <span class="str">&#34;log&#34;</span>
      <span class="str">&#34;net/http&#34;</span>
      <span class="str">&#34;time&#34;</span>
  
      <span class="str">&#34;gitlab.com/efronlicht/blog/articles/backendbasics/cmd/servermw&#34;</span>
  <span class="pun">)</span>
  
  <span class="kwd">func</span> <span class="pln">main</span><span class="pun">(</span><span class="pun">)</span> <span class="pun">{</span>
      <span class="pln">port</span> <span class="pun">:</span><span class="pun">=</span> <span class="pln">flag</span><span class="pun">.</span><span class="typ">Int</span><span class="pun">(</span><span class="str">&#34;port&#34;</span><span class="pun">,</span> <span class="dec">8080</span><span class="pun">,</span> <span class="str">&#34;port to listen on&#34;</span><span class="pun">)</span>
      <span class="pln">flag</span><span class="pun">.</span><span class="typ">Parse</span><span class="pun">(</span><span class="pun">)</span>
      <span class="com">// our base handler.</span>
      <span class="kwd">var</span> <span class="pln">h</span> <span class="pln">http</span><span class="pun">.</span><span class="typ">HandlerFunc</span> <span class="pun">=</span> <span class="kwd">func</span><span class="pun">(</span><span class="pln">w</span> <span class="pln">http</span><span class="pun">.</span><span class="typ">ResponseWriter</span><span class="pun">,</span> <span class="pln">r</span> <span class="pun">*</span><span class="pln">http</span><span class="pun">.</span><span class="typ">Request</span><span class="pun">)</span> <span class="pun">{</span>
          <span class="com">// route the request. note that there&#39;s no need for ANY router, even the stdlib&#39;s http.ServeMux</span>
          <span class="com">// if you have a simple enough routing scheme.</span>
          <span class="com">// a switch statement is perfectly fine.</span>
          <span class="kwd">switch</span> <span class="pln">r</span><span class="pun">.</span><span class="typ">URL</span><span class="pun">.</span><span class="typ">Path</span> <span class="pun">{</span>
          <span class="kwd">case</span> <span class="str">&#34;/time&#34;</span><span class="pun">:</span>
              <span class="pln">fmt</span><span class="pun">.</span><span class="typ">Fprintln</span><span class="pun">(</span><span class="pln">w</span><span class="pun">,</span> <span class="pln">time</span><span class="pun">.</span><span class="typ">Now</span><span class="pun">(</span><span class="pun">)</span><span class="pun">.</span><span class="typ">Format</span><span class="pun">(</span><span class="pln">time</span><span class="pun">.</span><span class="typ">RFC3339</span><span class="pun">)</span><span class="pun">)</span>
          <span class="kwd">case</span> <span class="str">&#34;/panic&#34;</span><span class="pun">:</span>
              <span class="pln">panic</span><span class="pun">(</span><span class="str">&#34;oh my god JC, a bomb!&#34;</span><span class="pun">)</span>
          <span class="kwd">default</span><span class="pun">:</span>
              <span class="pln">http</span><span class="pun">.</span><span class="typ">NotFound</span><span class="pun">(</span><span class="pln">w</span><span class="pun">,</span> <span class="pln">r</span><span class="pun">)</span>
          <span class="pun">}</span>
      <span class="pun">}</span>
      <span class="com">// remember, middleware is applied in First In, Last Out order.</span>
  
      <span class="pln">h</span> <span class="pun">=</span> <span class="pln">servermw</span><span class="pun">.</span><span class="typ">RecordResponse</span><span class="pun">(</span><span class="pln">h</span><span class="pun">)</span>
      <span class="pln">h</span> <span class="pun">=</span> <span class="pln">servermw</span><span class="pun">.</span><span class="typ">Recovery</span><span class="pun">(</span><span class="pln">h</span><span class="pun">)</span>
      <span class="pln">h</span> <span class="pun">=</span> <span class="pln">servermw</span><span class="pun">.</span><span class="typ">Log</span><span class="pun">(</span><span class="pln">h</span><span class="pun">)</span>
      <span class="pln">h</span> <span class="pun">=</span> <span class="pln">servermw</span><span class="pun">.</span><span class="typ">Trace</span><span class="pun">(</span><span class="pln">h</span><span class="pun">)</span>
  
      <span class="com">// always apply timeouts to your server, even if you&#39;ve put cancellations in the context using a middleware.</span>
      <span class="pln">server</span> <span class="pun">:</span><span class="pun">=</span> <span class="pln">http</span><span class="pun">.</span><span class="typ">Server</span><span class="pun">{</span>
          <span class="typ">Addr</span><span class="pun">:</span>              <span class="pln">fmt</span><span class="pun">.</span><span class="typ">Sprintf</span><span class="pun">(</span><span class="str">&#34;:%d&#34;</span><span class="pun">,</span> <span class="pun">*</span><span class="pln">port</span><span class="pun">)</span><span class="pun">,</span>
          <span class="typ">Handler</span><span class="pun">:</span>           <span class="pln">h</span><span class="pun">,</span>
          <span class="typ">ReadTimeout</span><span class="pun">:</span>       <span class="dec">1</span> <span class="pun">*</span> <span class="pln">time</span><span class="pun">.</span><span class="typ">Second</span><span class="pun">,</span>
          <span class="typ">WriteTimeout</span><span class="pun">:</span>      <span class="dec">1</span> <span class="pun">*</span> <span class="pln">time</span><span class="pun">.</span><span class="typ">Second</span><span class="pun">,</span>
          <span class="typ">ReadHeaderTimeout</span><span class="pun">:</span> <span class="dec">200</span> <span class="pun">*</span> <span class="pln">time</span><span class="pun">.</span><span class="typ">Millisecond</span><span class="pun">,</span>
      <span class="pun">}</span>
      <span class="pln">log</span><span class="pun">.</span><span class="typ">Printf</span><span class="pun">(</span><span class="str">&#34;listening on %s&#34;</span><span class="pun">,</span> <span class="pln">server</span><span class="pun">.</span><span class="typ">Addr</span><span class="pun">)</span>
      <span class="kwd">if</span> <span class="pln">err</span> <span class="pun">:</span><span class="pun">=</span> <span class="pln">server</span><span class="pun">.</span><span class="typ">ListenAndServe</span><span class="pun">(</span><span class="pun">)</span><span class="pun">;</span> <span class="pun">!</span><span class="pln">errors</span><span class="pun">.</span><span class="typ">Is</span><span class="pun">(</span><span class="pln">err</span><span class="pun">,</span> <span class="pln">http</span><span class="pun">.</span><span class="typ">ErrServerClosed</span><span class="pun">)</span> <span class="pun">{</span>
          <span class="pln">log</span><span class="pun">.</span><span class="typ">Fatal</span><span class="pun">(</span><span class="pln">err</span><span class="pun">)</span>
      <span class="pun">}</span>
  <span class="pun">}</span>
  </code></pre>
  
  <p>Let’s fire it up and visit <code>http://localhost:8080/time</code>, <code>http://localhost:8080/panic</code>, and <code>http://localhost:8080/foobar</code> to see what happens.
  IN:</p>
  
  <pre><code>go run servermiddlewareex.go
  </code></pre>
  
  <p>OUT (client):</p>
  
  <pre><code class="language-text"><span class="pln">localhost</span><span class="pun">:</span><span class="dec">8080</span><span class="pun">/</span><span class="pln">time</span><span class="pun">:</span> <span class="dec">2023</span><span class="pun">-</span><span class="dec">09</span><span class="pun">-</span><span class="dec">12</span><span class="typ">T07</span><span class="pun">:</span><span class="dec">55</span><span class="pun">:</span><span class="dec">16</span><span class="pun">-</span><span class="dec">07</span><span class="pun">:</span><span class="dec">00</span>
  <span class="pln">localhost</span><span class="pun">:</span><span class="dec">8080</span><span class="pun">/</span><span class="pln">panic</span><span class="pun">:</span> <span class="pln">internal</span> <span class="pln">server</span> <span class="pln">error</span>
  <span class="pln">localhost</span><span class="pun">:</span><span class="dec">8080</span><span class="pun">/</span><span class="pln">foobar</span><span class="pun">:</span> <span class="dec">404</span> <span class="pln">page</span> <span class="kwd">not</span> <span class="pln">found</span>
  </code></pre>
  
  <p>OUT (server)</p>
  
  <pre><code class="language-text"><span class="dec">2023</span><span class="pun">/</span><span class="dec">09</span><span class="pun">/</span><span class="dec">12</span> <span class="dec">07</span><span class="pun">:</span><span class="dec">50</span><span class="pun">:</span><span class="dec">39</span> <span class="pln">listening</span> <span class="pln">on</span> <span class="pun">:</span><span class="dec">8080</span>
  <span class="typ">GET</span> <span class="pun">/</span><span class="pln">time</span><span class="pun">:</span> <span class="pun">[</span><span class="dec">4</span><span class="pln">c5ef2f9</span><span class="pun">-</span><span class="pln">cd58</span><span class="pun">-</span><span class="dec">4</span><span class="pln">dec</span><span class="pun">-</span><span class="pln">a28f</span><span class="pun">-</span><span class="dec">770</span><span class="pln">b5786fcba</span> <span class="pln">fcc3b01b</span><span class="pun">-</span><span class="pln">d18d</span><span class="pun">-</span><span class="dec">49</span><span class="pln">a8</span><span class="pun">-</span><span class="dec">96</span><span class="pln">b2</span><span class="pun">-</span><span class="dec">0514</span><span class="pln">c7ac24c6</span><span class="pun">]</span><span class="pun">:</span> <span class="dec">2023</span><span class="pun">/</span><span class="dec">09</span><span class="pun">/</span><span class="dec">12</span> <span class="dec">07</span><span class="pun">:</span><span class="dec">55</span><span class="pun">:</span><span class="dec">16</span> <span class="dec">200</span> <span class="typ">OK</span><span class="pun">:</span> <span class="dec">26</span> <span class="pln">bytes</span> <span class="kwd">in</span> <span class="dec">3.636</span><span class="pln">µs</span>
  <span class="typ">GET</span> <span class="pun">/</span><span class="pln">panic</span><span class="pun">:</span> <span class="pun">[</span><span class="dec">98</span><span class="pln">f8f8cc</span><span class="pun">-</span><span class="dec">18</span><span class="pln">ce</span><span class="pun">-</span><span class="dec">4</span><span class="pln">b18</span><span class="pun">-</span><span class="dec">9044</span><span class="pun">-</span><span class="dec">3258</span><span class="pln">c24e57e1</span> <span class="dec">88</span><span class="pln">b97381</span><span class="pun">-</span><span class="dec">1866</span><span class="pun">-</span><span class="dec">4689</span><span class="pun">-</span><span class="pln">a23a</span><span class="pun">-</span><span class="pln">fac50bea0da0</span><span class="pun">]</span><span class="pun">:</span> <span class="dec">2023</span><span class="pun">/</span><span class="dec">09</span><span class="pun">/</span><span class="dec">12</span> <span class="dec">07</span><span class="pun">:</span><span class="dec">55</span><span class="pun">:</span><span class="dec">31</span> <span class="pln">panic</span><span class="pun">:</span> <span class="pln">oh</span> <span class="kwd">my</span> <span class="pln">god</span> <span class="typ">JC</span><span class="pun">,</span> <span class="pln">a</span> <span class="pln">bomb</span><span class="pun">!</span>
  <span class="pln">goroutine</span> <span class="dec">6</span> <span class="pun">[</span><span class="pln">running</span><span class="pun">]</span><span class="pun">:</span>
  <span class="pln">runtime</span><span class="pun">/</span><span class="pln">debug</span><span class="pun">.</span><span class="typ">Stack</span><span class="pun">(</span><span class="pun">)</span>
          <span class="pun">/</span><span class="pln">usr</span><span class="pun">/</span><span class="kwd">local</span><span class="pun">/</span><span class="pln">go</span><span class="pun">/</span><span class="pln">src</span><span class="pun">/</span><span class="pln">runtime</span><span class="pun">/</span><span class="pln">debug</span><span class="pun">/</span><span class="pln">stack</span><span class="pun">.</span><span class="pln">go</span><span class="pun">:</span><span class="dec">24</span> <span class="pun">+</span><span class="dec">0x5e</span>
  <span class="pun">&lt;</span><span class="pln">snip</span><span class="pun">.</span><span class="pun">.</span><span class="pun">.</span> <span class="pln">stack</span> <span class="pln">trace</span> <span class="pun">.</span><span class="pun">.</span><span class="pun">.</span><span class="pun">&gt;</span>
  </code></pre>
  
  <p>Looks like everything is working as expected. So far, we’ve covered (nearly) everything you might have used a framework for:</p>
  
  <ul>
  <li>Requests</li>
  <li>Responses</li>
  <li>Middleware</li>
  <li>Serialization</li>
  <li>Dependency Injection</li>
  </ul>
  
  <p>But we haven’t covered <strong>routing</strong> yet. Let’s fix that.</p>
  
  <h3>Routing</h3>
  
  <p><strong>Routing</strong> is the process of matching a request to a handler via it’s <code>METHOD</code> and <code>PATH</code>. In Go, there’s nothing particularly special about routing: it’s just something that the <code>Handler</code> inside your <code>Server</code> does.</p>
  
  <p>The most basic kind of routing is just a <code>switch</code> statement, like we saw above. That only dealt with paths, but routing based off <code>METHOD</code> is just as easy: the following code is the ‘router’ that serves <strong>the website you’re reading this on</strong>.</p>
  
  <pre><code class="language-go"><span class="kwd">var</span> <span class="pln">router</span> <span class="pln">http</span><span class="pun">.</span><span class="typ">HandlerFunc</span> <span class="pun">=</span> <span class="kwd">func</span><span class="pun">(</span><span class="pln">w</span> <span class="pln">http</span><span class="pun">.</span><span class="typ">ResponseWriter</span><span class="pun">,</span> <span class="pln">r</span> <span class="pun">*</span><span class="pln">http</span><span class="pun">.</span><span class="typ">Request</span><span class="pun">)</span> <span class="pun">{</span>
              <span class="pln">p</span> <span class="pun">:</span><span class="pun">=</span> <span class="pln">strings</span><span class="pun">.</span><span class="typ">TrimSuffix</span><span class="pun">(</span><span class="pln">r</span><span class="pun">.</span><span class="typ">URL</span><span class="pun">.</span><span class="typ">Path</span><span class="pun">,</span> <span class="str">&#34;/&#34;</span><span class="pun">)</span>
              <span class="kwd">switch</span> <span class="pun">{</span>
              <span class="kwd">case</span> <span class="pln">r</span><span class="pun">.</span><span class="typ">Method</span> <span class="pun">!</span><span class="pun">=</span> <span class="str">&#34;GET&#34;</span><span class="pun">:</span> <span class="com">// only GET is allowed</span>
                  <span class="pln">w</span><span class="pun">.</span><span class="typ">WriteHeader</span><span class="pun">(</span><span class="pln">http</span><span class="pun">.</span><span class="typ">StatusMethodNotAllowed</span><span class="pun">)</span>
                  <span class="kwd">return</span>
              <span class="kwd">case</span> <span class="pln">p</span> <span class="pun">=</span><span class="pun">=</span> <span class="str">&#34;/debug/uptime&#34;</span><span class="pun">:</span> <span class="com">// return uptime</span>
                  <span class="pln">d</span> <span class="pun">:</span><span class="pun">=</span> <span class="pun">(</span><span class="pln">time</span><span class="pun">.</span><span class="typ">Since</span><span class="pun">(</span><span class="pln">start</span><span class="pun">)</span><span class="pun">.</span><span class="typ">Seconds</span><span class="pun">(</span><span class="pun">)</span><span class="pun">)</span>
                  <span class="kwd">const</span> <span class="typ">MIN</span> <span class="pun">=</span> <span class="dec">60</span>
                  <span class="kwd">const</span> <span class="typ">HOUR</span> <span class="pun">=</span> <span class="dec">60</span> <span class="pun">*</span> <span class="typ">MIN</span>
                  <span class="kwd">const</span> <span class="typ">DAY</span> <span class="pun">=</span> <span class="dec">24</span> <span class="pun">*</span> <span class="typ">HOUR</span>
                  <span class="pln">_</span><span class="pun">,</span> <span class="pln">_</span> <span class="pun">=</span> <span class="pln">fmt</span><span class="pun">.</span><span class="typ">Fprintf</span><span class="pun">(</span><span class="pln">w</span><span class="pun">,</span> <span class="str">&#34;%2dd %02dh %02dm %02ds&#34;</span><span class="pun">,</span> <span class="kwd">int</span><span class="pun">(</span><span class="pln">d</span><span class="pun">/</span><span class="typ">DAY</span><span class="pun">)</span><span class="pun">,</span> <span class="kwd">int</span><span class="pun">(</span><span class="pln">d</span><span class="pun">/</span><span class="typ">HOUR</span><span class="pun">)</span><span class="pun">%</span><span class="dec">24</span><span class="pun">,</span> <span class="kwd">int</span><span class="pun">(</span><span class="pln">d</span><span class="pun">/</span><span class="typ">MIN</span><span class="pun">)</span><span class="pun">%</span><span class="dec">60</span><span class="pun">,</span> <span class="kwd">int</span><span class="pun">(</span><span class="pln">d</span><span class="pun">)</span><span class="pun">%</span><span class="dec">60</span><span class="pun">)</span>
                  <span class="kwd">return</span>
              <span class="kwd">case</span> <span class="pln">p</span> <span class="pun">=</span><span class="pun">=</span> <span class="str">&#34;/debug/meta&#34;</span><span class="pun">:</span> <span class="com">// return metadata about the server</span>
                  <span class="pln">_</span><span class="pun">,</span> <span class="pln">_</span> <span class="pun">=</span> <span class="pln">w</span><span class="pun">.</span><span class="typ">Write</span><span class="pun">(</span><span class="pln">metaJSON</span><span class="pun">)</span>
                  <span class="kwd">return</span>
              <span class="kwd">case</span> <span class="pln">p</span> <span class="pun">=</span><span class="pun">=</span> <span class="str">&#34;&#34;</span><span class="pun">:</span> <span class="com">// redirect to index.html</span>
                  <span class="pln">http</span><span class="pun">.</span><span class="typ">Redirect</span><span class="pun">(</span><span class="pln">w</span><span class="pun">,</span> <span class="pln">r</span><span class="pun">,</span> <span class="str">&#34;./index.html&#34;</span><span class="pun">,</span> <span class="pln">http</span><span class="pun">.</span><span class="typ">StatusPermanentRedirect</span><span class="pun">)</span>
                  <span class="kwd">return</span>
              <span class="kwd">default</span><span class="pun">:</span> <span class="com">// serve webpages</span>
                  <span class="com">// fonts are immutable and large, so we can cache them for a long time.~</span>
                  <span class="com">// everything else is tiny and might change, so we don&#39;t cache it.</span>
                  <span class="kwd">if</span> <span class="pln">strings</span><span class="pun">.</span><span class="typ">Contains</span><span class="pun">(</span><span class="pln">r</span><span class="pun">.</span><span class="typ">URL</span><span class="pun">.</span><span class="typ">Path</span><span class="pun">,</span> <span class="str">&#34;.woff2&#34;</span><span class="pun">)</span> <span class="pun">{</span>
                      <span class="pln">r</span><span class="pun">.</span><span class="typ">Header</span><span class="pun">.</span><span class="typ">Add</span><span class="pun">(</span><span class="str">&#34;cache-control&#34;</span><span class="pun">,</span> <span class="str">&#34;immutable&#34;</span><span class="pun">)</span>
                      <span class="pln">r</span><span class="pun">.</span><span class="typ">Header</span><span class="pun">.</span><span class="typ">Add</span><span class="pun">(</span><span class="str">&#34;cache-control&#34;</span><span class="pun">,</span> <span class="str">&#34;max-age=604800&#34;</span><span class="pun">)</span>
                      <span class="pln">r</span><span class="pun">.</span><span class="typ">Header</span><span class="pun">.</span><span class="typ">Add</span><span class="pun">(</span><span class="str">&#34;cache-control&#34;</span><span class="pun">,</span> <span class="str">&#34;public&#34;</span><span class="pun">)</span>
                  <span class="pun">}</span> <span class="kwd">else</span> <span class="pun">{</span>
                      <span class="pln">r</span><span class="pun">.</span><span class="typ">Header</span><span class="pun">.</span><span class="typ">Add</span><span class="pun">(</span><span class="str">&#34;cache-control&#34;</span><span class="pun">,</span> <span class="str">&#34;no-cache&#34;</span><span class="pun">)</span>
                  <span class="pun">}</span>
                  <span class="kwd">static</span><span class="pun">.</span><span class="typ">ServeFile</span><span class="pun">(</span><span class="pln">w</span><span class="pun">,</span> <span class="pln">r</span><span class="pun">)</span> <span class="com">// serve pre-zipped, embedded files</span>
                  <span class="kwd">return</span>
              <span class="pun">}</span>
  <span class="pun">}</span>
  </code></pre>
  
  <p><strong>This is all you need for small programs.</strong> For convenience, Go’s stdlib comes with a built-in Router, <a href="https://pkg.go.dev/net/http#ServeMux"><code>http.ServeMux</code></a>, which uses a simple prefix-based matching scheme: the longest prefix that matches the request path wins. It’s implemented like this:</p>
  
  <pre><code class="language-go"><span class="com">// Find a handler on a handler map given a path string.</span>
  <span class="com">// Most-specific (longest) pattern wins.</span>
  <span class="kwd">func</span> <span class="pun">(</span><span class="pln">mux</span> <span class="pun">*</span><span class="typ">ServeMux</span><span class="pun">)</span> <span class="pln">match</span><span class="pun">(</span><span class="pln">path</span> <span class="pln">string</span><span class="pun">)</span> <span class="pun">(</span><span class="pln">h</span> <span class="typ">Handler</span><span class="pun">,</span> <span class="pln">pattern</span> <span class="pln">string</span><span class="pun">)</span> <span class="pun">{</span>
      <span class="com">// Check for exact match first.</span>
      <span class="pln">v</span><span class="pun">,</span> <span class="pln">ok</span> <span class="pun">:</span><span class="pun">=</span> <span class="pln">mux</span><span class="pun">.</span><span class="pln">m</span><span class="pun">[</span><span class="pln">path</span><span class="pun">]</span>
      <span class="kwd">if</span> <span class="pln">ok</span> <span class="pun">{</span>
          <span class="kwd">return</span> <span class="pln">v</span><span class="pun">.</span><span class="pln">h</span><span class="pun">,</span> <span class="pln">v</span><span class="pun">.</span><span class="pln">pattern</span>
      <span class="pun">}</span>
  
      <span class="com">// Check for longest valid match.  mux.es contains all patterns</span>
      <span class="com">// that end in / sorted from longest to shortest.</span>
      <span class="kwd">for</span> <span class="pln">_</span><span class="pun">,</span> <span class="pln">e</span> <span class="pun">:</span><span class="pun">=</span> <span class="pln">range</span> <span class="pln">mux</span><span class="pun">.</span><span class="pln">es</span> <span class="pun">{</span>
          <span class="kwd">if</span> <span class="pln">strings</span><span class="pun">.</span><span class="typ">HasPrefix</span><span class="pun">(</span><span class="pln">path</span><span class="pun">,</span> <span class="pln">e</span><span class="pun">.</span><span class="pln">pattern</span><span class="pun">)</span> <span class="pun">{</span>
              <span class="kwd">return</span> <span class="pln">e</span><span class="pun">.</span><span class="pln">h</span><span class="pun">,</span> <span class="pln">e</span><span class="pun">.</span><span class="pln">pattern</span>
          <span class="pun">}</span>
      <span class="pun">}</span>
      <span class="kwd">return</span> <span class="kwd">nil</span><span class="pun">,</span> <span class="str">&#34;&#34;</span>
  <span class="pun">}</span>
  </code></pre>
  
  <p>ServeMux is perfectly fine for the vast majority of backend programs, but is not very flexible: it doesn’t even support routing by METHOD. (There is an <a href="https://github.com/golang/go/issues/61410">accepted proposal</a> to add both this and wildcards to <code>http.ServeMux</code>, but it’s not implemented yet.)</p>
  
  <p>More complicated routers, like the popular <a href="https://github.com/gorilla/mux">gorilla/mux</a>, allow for routing by method, by patterns matching regular expressions, and for extracting variables from the URL path. I’ll quote their documentation here to give you an idea of what this looks like:</p>
  
  <ul>
  <li>
  <h2>HTTP Servemux: quoted documentation</h2>
  
  <p>Let’s start registering a couple of URL paths and handlers:</p>
  
  <pre><code class="language-go"><span class="kwd">func</span> <span class="pln">main</span><span class="pun">(</span><span class="pun">)</span> <span class="pun">{</span>
      <span class="pln">r</span> <span class="pun">:</span><span class="pun">=</span> <span class="pln">mux</span><span class="pun">.</span><span class="typ">NewRouter</span><span class="pun">(</span><span class="pun">)</span>
      <span class="pln">r</span><span class="pun">.</span><span class="typ">HandleFunc</span><span class="pun">(</span><span class="str">&#34;/&#34;</span><span class="pun">,</span> <span class="typ">HomeHandler</span><span class="pun">)</span>
      <span class="pln">r</span><span class="pun">.</span><span class="typ">HandleFunc</span><span class="pun">(</span><span class="str">&#34;/products&#34;</span><span class="pun">,</span> <span class="typ">ProductsHandler</span><span class="pun">)</span>
      <span class="pln">r</span><span class="pun">.</span><span class="typ">HandleFunc</span><span class="pun">(</span><span class="str">&#34;/articles&#34;</span><span class="pun">,</span> <span class="typ">ArticlesHandler</span><span class="pun">)</span>
      <span class="pln">http</span><span class="pun">.</span><span class="typ">Handle</span><span class="pun">(</span><span class="str">&#34;/&#34;</span><span class="pun">,</span> <span class="pln">r</span><span class="pun">)</span>
  <span class="pun">}</span>
  </code></pre>
  <p>Here we register three routes mapping URL paths to handlers. This is equivalent to how <code>http.HandleFunc()</code> works: if an incoming request URL matches one of the paths, the corresponding handler is called passing (<code>http.ResponseWriter</code>, <code>*http.Request</code>) as parameters.</p>
  
  <p>Paths can have variables. They are defined using the format <code>{name}</code> or <code>{name:pattern}</code>. If a regular expression pattern is not defined, the matched variable will be anything until the next slash. For example:</p>
  
  <pre><code class="language-go"><span class="pln">r</span> <span class="pun">:</span><span class="pun">=</span> <span class="pln">mux</span><span class="pun">.</span><span class="typ">NewRouter</span><span class="pun">(</span><span class="pun">)</span>
  <span class="pln">r</span><span class="pun">.</span><span class="typ">HandleFunc</span><span class="pun">(</span><span class="str">&#34;/products/{key}&#34;</span><span class="pun">,</span> <span class="typ">ProductHandler</span><span class="pun">)</span>
  <span class="pln">r</span><span class="pun">.</span><span class="typ">HandleFunc</span><span class="pun">(</span><span class="str">&#34;/articles/{category}/&#34;</span><span class="pun">,</span> <span class="typ">ArticlesCategoryHandler</span><span class="pun">)</span>
  <span class="pln">r</span><span class="pun">.</span><span class="typ">HandleFunc</span><span class="pun">(</span><span class="str">&#34;/articles/{category}/{id:[0-9]+}&#34;</span><span class="pun">,</span> <span class="typ">ArticleHandler</span><span class="pun">)</span>
  </code></pre>
  <p>The names are used to create a map of route variables which can be retrieved calling <code>mux.Vars()</code>:</p>
  
  <pre><code class="language-go"><span class="kwd">func</span> <span class="typ">ArticlesCategoryHandler</span><span class="pun">(</span><span class="pln">w</span> <span class="pln">http</span><span class="pun">.</span><span class="typ">ResponseWriter</span><span class="pun">,</span> <span class="pln">r</span> <span class="pun">*</span><span class="pln">http</span><span class="pun">.</span><span class="typ">Request</span><span class="pun">)</span> <span class="pun">{</span>
      <span class="pln">vars</span> <span class="pun">:</span><span class="pun">=</span> <span class="pln">mux</span><span class="pun">.</span><span class="typ">Vars</span><span class="pun">(</span><span class="pln">r</span><span class="pun">)</span>
      <span class="pln">w</span><span class="pun">.</span><span class="typ">WriteHeader</span><span class="pun">(</span><span class="pln">http</span><span class="pun">.</span><span class="typ">StatusOK</span><span class="pun">)</span>
      <span class="pln">fmt</span><span class="pun">.</span><span class="typ">Fprintf</span><span class="pun">(</span><span class="pln">w</span><span class="pun">,</span> <span class="str">&#34;Category: %v\n&#34;</span><span class="pun">,</span> <span class="pln">vars</span><span class="pun">[</span><span class="str">&#34;category&#34;</span><span class="pun">]</span><span class="pun">)</span>
  <span class="pun">}</span>
  </code></pre>
  <p>Paths can have variables. They are defined using the format <code>{name}</code> or <code>{name:pattern}</code>. If a regular expression pattern is not defined, the matched variable will be anything until the next slash. For example:</p>
  
  <pre><code class="language-go"><span class="pln">r</span> <span class="pun">:</span><span class="pun">=</span> <span class="pln">mux</span><span class="pun">.</span><span class="typ">NewRouter</span><span class="pun">(</span><span class="pun">)</span>
  <span class="pln">r</span><span class="pun">.</span><span class="typ">HandleFunc</span><span class="pun">(</span><span class="str">&#34;/products/{key}&#34;</span><span class="pun">,</span> <span class="typ">ProductHandler</span><span class="pun">)</span>
  <span class="pln">r</span><span class="pun">.</span><span class="typ">HandleFunc</span><span class="pun">(</span><span class="str">&#34;/articles/{category}/&#34;</span><span class="pun">,</span> <span class="typ">ArticlesCategoryHandler</span><span class="pun">)</span>
  <span class="pln">r</span><span class="pun">.</span><span class="typ">HandleFunc</span><span class="pun">(</span><span class="str">&#34;/articles/{category}/{id:[0-9]+}&#34;</span><span class="pun">,</span> <span class="typ">ArticleHandler</span><span class="pun">)</span>
  </code></pre>
  <p>The names are used to create a map of route variables which can be retrieved calling <code>mux.Vars()</code>:</p>
  
  <pre><code class="language-go"><span class="kwd">func</span> <span class="typ">ArticlesCategoryHandler</span><span class="pun">(</span><span class="pln">w</span> <span class="pln">http</span><span class="pun">.</span><span class="typ">ResponseWriter</span><span class="pun">,</span> <span class="pln">r</span> <span class="pun">*</span><span class="pln">http</span><span class="pun">.</span><span class="typ">Request</span><span class="pun">)</span> <span class="pun">{</span>
      <span class="pln">vars</span> <span class="pun">:</span><span class="pun">=</span> <span class="pln">mux</span><span class="pun">.</span><span class="typ">Vars</span><span class="pun">(</span><span class="pln">r</span><span class="pun">)</span>
      <span class="pln">w</span><span class="pun">.</span><span class="typ">WriteHeader</span><span class="pun">(</span><span class="pln">http</span><span class="pun">.</span><span class="typ">StatusOK</span><span class="pun">)</span>
      <span class="pln">fmt</span><span class="pun">.</span><span class="typ">Fprintf</span><span class="pun">(</span><span class="pln">w</span><span class="pun">,</span> <span class="str">&#34;Category: %v\n&#34;</span><span class="pun">,</span> <span class="pln">vars</span><span class="pun">[</span><span class="str">&#34;category&#34;</span><span class="pun">]</span><span class="pun">)</span>
  <span class="pun">}</span>
  </code></pre></li>
  </ul>
  
  <p>Let’s build our own router that can handle expressions of this kind.</p>
  
  <p><a href="https://go.dev/play/p/BBGLxqepogO">See the full code, including 100% test coverage, at https://go.dev/play/p/BBGLxqepogO</a>.</p>
  
  <p>The following table summarizes our external API:</p>
  
  <table>
  <thead>
  <tr>
  <th>Type/Func</th>
  <th>Description</th>
  </tr>
  </thead>
  
  <tbody>
  <tr>
  <td><code>Router</code></td>
  <td>A router that matches HTTP requests to handlers based on the request path.</td>
  </tr>
  
  <tr>
  <td><code>Router.AddRoute(pattern, method, handler)</code></td>
  <td>Add a route to the router.</td>
  </tr>
  
  <tr>
  <td><code>Router.ServeHTTP(w, r)</code></td>
  <td>Serves the request by matching it against the routes in the router.</td>
  </tr>
  
  <tr>
  <td><code>PathVars</code></td>
  <td>A <code>map[string]string</code> of path params to their values</td>
  </tr>
  
  <tr>
  <td><code>Vars(r)</code></td>
  <td>Returns the path parameters for the current request, or an empty map if there are none.</td>
  </tr>
  </tbody>
  </table>
  <p>Each route will contain a <code>method</code> (e.g, <code>GET</code>), a <code>pattern</code> (e.g, <code>/articles/{category}/{id:[0-9]+}</code>), and a <code>http.Handler</code>. Patterns that match a regular expression corresponding to the <code>pattern</code> will be dispatched to the <code>handler</code>.</p>
  
  <p>That is, we’ll need to convert a pattern like <code>/articles/{category}/{id:[0-9]+}</code> into a regular expression like <code>^/articles/([a-zA-Z]+)/([0-9]+)$</code>, and extract the path parameters from the request path, so that the <em>server</em> can find what we meant by “category” and “id”.</p>
  
  <p>Each route will look like this:</p>
  
  <pre><code class="language-go"><span class="kwd">type</span> <span class="pln">route</span> <span class="kwd">struct</span> <span class="pun">{</span>
      <span class="pln">pattern</span> <span class="pun">*</span><span class="pln">regexp</span><span class="pun">.</span><span class="typ">Regexp</span> <span class="com">// the compiled regexp</span>
      <span class="pln">names</span>   <span class="pun">[</span><span class="pun">]</span><span class="pln">string</span> <span class="com">// the names of the path parameters; one per capture group in the regexp</span>
      <span class="pln">raw</span>     <span class="pln">string</span> <span class="com">// the raw pattern string</span>
      <span class="pln">method</span>  <span class="pln">string</span> <span class="com">// the HTTP method to match; if empty, all methods match.</span>
      <span class="pln">handler</span> <span class="pln">http</span><span class="pun">.</span><span class="typ">Handler</span> <span class="com">// underlying handler</span>
  <span class="pun">}</span>
  
  </code></pre>
  
  <p>We’ll define a <code>Router</code> type that contains a slice of routes, matching against each in turn:</p>
  
  <pre><code class="language-go"><span class="com">// Router allows you to match HTTP requests to handlers based on the request path.</span>
  <span class="com">// It use a syntax similar to gorilla/mux:</span>
  <span class="com">// /path/{regexp}/{name:captured-regexp}</span>
  <span class="com">// AddRoute adds a route to the router.</span>
  <span class="com">// Vars returns the path parameters for the current request, or nil if there are none.</span>
  <span class="kwd">type</span> <span class="typ">Router</span> <span class="kwd">struct</span> <span class="pun">{</span><span class="pln">routes</span> <span class="pun">[</span><span class="pun">]</span><span class="pln">route</span><span class="pun">}</span>
  </code></pre>
  
  <p>We’ll need to compile the pattern into a regular expression, and extract the path parameters from the pattern.</p>
  
  <p>This entails keeping track of which names correspond to which capture groups in the regexp.</p>
  
  <p>While we could use named capture groups (<code>(?P&lt;name&gt;...)</code>), this is slow and bulky and requires extra iteration. Instead, we’ll just keep track of the names in a slice, and use the slice index to determine which capture group corresponds to which name.</p>
  
  <p>That is,suppose we have pattern</p>
  
  <pre><code class="language-regexp"><span class="pun">/</span><span class="pln">chess</span><span class="pun">/</span><span class="pln">replay</span><span class="pun">/</span><span class="pun">{</span><span class="pln">white</span><span class="pun">:</span><span class="pun">[</span><span class="pln">a</span><span class="pun">-</span><span class="pln">zA</span><span class="pun">-</span><span class="typ">Z</span><span class="pun">]</span><span class="pun">+</span><span class="pun">}</span><span class="pun">/</span><span class="pun">{</span><span class="pln">black</span><span class="pun">:</span><span class="pun">[</span><span class="pln">a</span><span class="pun">-</span><span class="pln">zA</span><span class="pun">-</span><span class="typ">Z</span><span class="pun">]</span><span class="pun">+</span><span class="pun">}</span><span class="pun">/</span><span class="pun">{</span><span class="pln">id</span><span class="pun">:</span><span class="pun">[</span><span class="dec">0</span><span class="pun">-</span><span class="dec">9</span><span class="pun">]</span><span class="pun">+</span><span class="pun">}</span>
  </code></pre>
  
  <p>This should compile into the regexp</p>
  
  <pre><code class="language-regexp"><span class="pun">^</span><span class="pun">/</span><span class="pln">chess</span><span class="pun">/</span><span class="pln">replay</span><span class="pun">/</span><span class="pun">(</span><span class="pun">[</span><span class="pln">a</span><span class="pun">-</span><span class="pln">zA</span><span class="pun">-</span><span class="typ">Z</span><span class="pun">]</span><span class="pun">+</span><span class="pun">)</span><span class="pun">/</span><span class="pun">(</span><span class="pun">[</span><span class="pln">a</span><span class="pun">-</span><span class="pln">zA</span><span class="pun">-</span><span class="typ">Z</span><span class="pun">]</span><span class="pun">+</span><span class="pun">)</span><span class="pun">/</span><span class="pun">(</span><span class="pun">[</span><span class="dec">0</span><span class="pun">-</span><span class="dec">9</span><span class="pun">]</span><span class="pun">+</span><span class="pun">)</span><span class="pun">$</span>
  </code></pre>
  
  <p>With the names slice</p>
  
  <pre><code class="language-go"><span class="pun">[</span><span class="pun">]</span><span class="pln">string</span><span class="pun">{</span><span class="str">&#34;white&#34;</span><span class="pun">,</span> <span class="str">&#34;black&#34;</span><span class="pun">,</span> <span class="str">&#34;id&#34;</span><span class="pun">}</span>
  </code></pre>
  
  <p>We define a function, <code>buildRoute</code>, to do this:</p>
  
  <pre><code class="language-go"><span class="kwd">func</span> <span class="pln">buildRoute</span><span class="pun">(</span><span class="pln">pattern</span> <span class="pln">string</span><span class="pun">)</span> <span class="pun">(</span><span class="pln">re</span> <span class="pun">*</span><span class="pln">regexp</span><span class="pun">.</span><span class="typ">Regexp</span><span class="pun">,</span> <span class="pln">names</span> <span class="pun">[</span><span class="pun">]</span><span class="pln">string</span><span class="pun">,</span> <span class="pln">err</span> <span class="pln">error</span><span class="pun">)</span> <span class="pun">{</span>
      <span class="kwd">if</span> <span class="pln">pattern</span> <span class="pun">=</span><span class="pun">=</span> <span class="str">&#34;&#34;</span> <span class="pun">|</span><span class="pun">|</span> <span class="pln">pattern</span><span class="pun">[</span><span class="dec">0</span><span class="pun">]</span> <span class="pun">!</span><span class="pun">=</span> <span class="str">&#39;/&#39;</span> <span class="pun">{</span>
          <span class="kwd">return</span> <span class="kwd">nil</span><span class="pun">,</span> <span class="kwd">nil</span><span class="pun">,</span> <span class="pln">fmt</span><span class="pun">.</span><span class="typ">Errorf</span><span class="pun">(</span><span class="str">&#34;invalid pattern %s: must begin with &#39;/&#39;&#34;</span><span class="pun">,</span> <span class="pln">pattern</span><span class="pun">)</span>
      <span class="pun">}</span>
      <span class="kwd">var</span> <span class="pln">buf</span> <span class="pln">strings</span><span class="pun">.</span><span class="typ">Builder</span>
      <span class="pln">buf</span><span class="pun">.</span><span class="typ">WriteByte</span><span class="pun">(</span><span class="str">&#39;^&#39;</span><span class="pun">)</span> <span class="com">// match the beginning of the string</span>
  
      <span class="com">// we gradually build up the regexp, and keep track of the path parameters we encounter.</span>
      <span class="com">// e.g, on successive iterations, we&#39;ll have:</span>
      <span class="com">// FOR {</span>
      <span class="com">// 0: /chess, nil</span>
      <span class="com">// 1: /chess/replay, nil</span>
      <span class="com">// 2: /chess/replay/([a-zA-Z]+), [white]</span>
      <span class="com">// 3: /chess/replay/([a-zA-Z]+)/([a-zA-Z]+), [white, black]</span>
      <span class="com">// 4: /chess/replay/([a-zA-Z]+)/([a-zA-Z]+)/([0-9]+), [white, black, id]</span>
      <span class="com">// }</span>
      <span class="kwd">for</span> <span class="pln">_</span><span class="pun">,</span> <span class="pln">f</span> <span class="pun">:</span><span class="pun">=</span> <span class="pln">range</span> <span class="pln">strings</span><span class="pun">.</span><span class="typ">Split</span><span class="pun">(</span><span class="pln">pattern</span><span class="pun">,</span> <span class="str">&#34;/&#34;</span><span class="pun">)</span><span class="pun">[</span><span class="dec">1</span><span class="pun">:</span><span class="pun">]</span> <span class="pun">{</span>
          <span class="pln">buf</span><span class="pun">.</span><span class="typ">WriteByte</span><span class="pun">(</span><span class="str">&#39;/&#39;</span><span class="pun">)</span>                                    <span class="com">// add the &#39;/&#39; back</span>
          <span class="kwd">if</span> <span class="pln">len</span><span class="pun">(</span><span class="pln">f</span><span class="pun">)</span> <span class="pun">&gt;</span><span class="pun">=</span> <span class="dec">2</span> <span class="pun">&amp;</span><span class="pun">&amp;</span> <span class="pln">f</span><span class="pun">[</span><span class="dec">0</span><span class="pun">]</span> <span class="pun">=</span><span class="pun">=</span> <span class="str">&#39;{&#39;</span> <span class="pun">&amp;</span><span class="pun">&amp;</span> <span class="pln">f</span><span class="pun">[</span><span class="pln">len</span><span class="pun">(</span><span class="pln">f</span><span class="pun">)</span><span class="pun">-</span><span class="dec">1</span><span class="pun">]</span> <span class="pun">=</span><span class="pun">=</span> <span class="str">&#39;}&#39;</span> <span class="pun">{</span> <span class="com">// path parameter</span>
              <span class="pln">trimmed</span> <span class="pun">:</span><span class="pun">=</span> <span class="pln">f</span><span class="pun">[</span><span class="dec">1</span> <span class="pun">:</span> <span class="pln">len</span><span class="pun">(</span><span class="pln">f</span><span class="pun">)</span><span class="pun">-</span><span class="dec">1</span><span class="pun">]</span> <span class="com">// strip off the &#39;{&#39; and &#39;}&#39;</span>
              <span class="com">// - {white:[a-zA-Z]+} -&gt; [a-zA-Z]+</span>
              <span class="kwd">if</span> <span class="pln">before</span><span class="pun">,</span> <span class="pln">after</span><span class="pun">,</span> <span class="pln">ok</span> <span class="pun">:</span><span class="pun">=</span> <span class="pln">strings</span><span class="pun">.</span><span class="typ">Cut</span><span class="pun">(</span><span class="pln">trimmed</span><span class="pun">,</span> <span class="str">&#34;:&#34;</span><span class="pun">)</span><span class="pun">;</span> <span class="pln">ok</span> <span class="pun">{</span> <span class="com">// its a regexp-capture group</span>
                  <span class="pln">names</span> <span class="pun">=</span> <span class="kwd">append</span><span class="pun">(</span><span class="pln">names</span><span class="pun">,</span> <span class="pln">before</span><span class="pun">)</span>
  
                  <span class="com">// replace with a capture group: i.e, if we have {id:[0-9]+}, we want to replace it with ([0-9]+)</span>
                  <span class="pln">buf</span><span class="pun">.</span><span class="typ">WriteByte</span><span class="pun">(</span><span class="str">&#39;(&#39;</span><span class="pun">)</span> <span class="com">//</span>
                  <span class="pln">buf</span><span class="pun">.</span><span class="typ">WriteString</span><span class="pun">(</span><span class="pln">after</span><span class="pun">)</span>
                  <span class="pln">buf</span><span class="pun">.</span><span class="typ">WriteByte</span><span class="pun">(</span><span class="str">&#39;)&#39;</span><span class="pun">)</span>
                  <span class="com">// white:[a-zA-Z]+ -&gt; ([a-zA-Z]+)</span>
              <span class="pun">}</span> <span class="kwd">else</span> <span class="pun">{</span>
                  <span class="pln">buf</span><span class="pun">.</span><span class="typ">WriteString</span><span class="pun">(</span><span class="pln">trimmed</span><span class="pun">)</span> <span class="com">// a regular expression, but not a captured one</span>
              <span class="pun">}</span>
          <span class="pun">}</span> <span class="kwd">else</span> <span class="pun">{</span>
              <span class="pln">buf</span><span class="pun">.</span><span class="typ">WriteString</span><span class="pun">(</span><span class="pln">regexp</span><span class="pun">.</span><span class="typ">QuoteMeta</span><span class="pun">(</span><span class="pln">f</span><span class="pun">)</span><span class="pun">)</span> <span class="com">// escape any special characters</span>
          <span class="pun">}</span>
  
      <span class="pun">}</span>
      <span class="com">// check for duplicate path parameters</span>
      <span class="kwd">for</span> <span class="pln">i</span> <span class="pun">:</span><span class="pun">=</span> <span class="pln">range</span> <span class="pln">names</span> <span class="pun">{</span>
          <span class="kwd">for</span> <span class="pln">j</span> <span class="pun">:</span><span class="pun">=</span> <span class="pln">i</span> <span class="pun">+</span> <span class="dec">1</span><span class="pun">;</span> <span class="pln">j</span> <span class="pun">&lt;</span> <span class="pln">len</span><span class="pun">(</span><span class="pln">names</span><span class="pun">)</span><span class="pun">;</span> <span class="pln">j</span><span class="pun">+</span><span class="pun">+</span> <span class="pun">{</span>
              <span class="kwd">if</span> <span class="pln">names</span><span class="pun">[</span><span class="pln">i</span><span class="pun">]</span> <span class="pun">=</span><span class="pun">=</span> <span class="pln">names</span><span class="pun">[</span><span class="pln">j</span><span class="pun">]</span> <span class="pun">{</span>
                  <span class="kwd">return</span> <span class="kwd">nil</span><span class="pun">,</span> <span class="kwd">nil</span><span class="pun">,</span> <span class="pln">fmt</span><span class="pun">.</span><span class="typ">Errorf</span><span class="pun">(</span><span class="str">&#34;duplicate path parameter %s in %q&#34;</span><span class="pun">,</span> <span class="pln">names</span><span class="pun">[</span><span class="pln">i</span><span class="pun">]</span><span class="pun">,</span> <span class="pln">pattern</span><span class="pun">)</span>
              <span class="pun">}</span>
          <span class="pun">}</span>
      <span class="pun">}</span>
      <span class="pln">buf</span><span class="pun">.</span><span class="typ">WriteByte</span><span class="pun">(</span><span class="str">&#39;$&#39;</span><span class="pun">)</span> <span class="com">// match the end of the string</span>
      <span class="pln">re</span><span class="pun">,</span> <span class="pln">err</span> <span class="pun">=</span> <span class="pln">regexp</span><span class="pun">.</span><span class="typ">Compile</span><span class="pun">(</span><span class="pln">buf</span><span class="pun">.</span><span class="typ">String</span><span class="pun">(</span><span class="pun">)</span><span class="pun">)</span>
      <span class="kwd">if</span> <span class="pln">err</span> <span class="pun">!</span><span class="pun">=</span> <span class="kwd">nil</span> <span class="pun">{</span>
          <span class="kwd">return</span> <span class="kwd">nil</span><span class="pun">,</span> <span class="kwd">nil</span><span class="pun">,</span> <span class="pln">fmt</span><span class="pun">.</span><span class="typ">Errorf</span><span class="pun">(</span><span class="str">&#34;invalid regexp %s: %w&#34;</span><span class="pun">,</span> <span class="pln">buf</span><span class="pun">.</span><span class="typ">String</span><span class="pun">(</span><span class="pun">)</span><span class="pun">,</span> <span class="pln">err</span><span class="pun">)</span>
      <span class="pun">}</span>
      <span class="kwd">return</span> <span class="pln">re</span><span class="pun">,</span> <span class="pln">names</span><span class="pun">,</span> <span class="kwd">nil</span>
  <span class="pun">}</span>
  </code></pre>
  
  <p>We’ll obtain path parameters on the server by creating a map of path parameters to their values, and adding it to the request context, reusing the <code>ctxutil</code> package we wrote earlier.</p>
  
  <p>Then, we’ll store those path parameters in a <code>map[string]string</code> and put the map in the context. We’ll use a unique type for the map so that we can use <code>ctxutil.Value</code> to retrieve it without stepping on any other context values. (A collision is unlikely, but it’s good practice to avoid it anyway; types are free.)</p>
  
  <pre><code class="language-go"><span class="com">// Vars is a map of path parameters to their values. It is a unique type so that ctxutil.Value can be used to retrieve it.</span>
  <span class="kwd">type</span> <span class="typ">PathVars</span> <span class="kwd">map</span><span class="pun">[</span><span class="pln">string</span><span class="pun">]</span><span class="pln">string</span>
  
  <span class="kwd">var</span> <span class="pln">empty</span> <span class="pun">=</span> <span class="kwd">make</span><span class="pun">(</span><span class="typ">PathVars</span><span class="pun">)</span>
  <span class="com">// Vars returns the path parameters for the current request. It will be nil if you didn&#39;t use a router to serve the request.</span>
  <span class="kwd">func</span> <span class="typ">Vars</span><span class="pun">(</span><span class="pln">ctx</span> <span class="pln">context</span><span class="pun">.</span><span class="typ">Context</span><span class="pun">)</span> <span class="typ">PathVars</span> <span class="pun">{</span> <span class="pln">v</span><span class="pun">,</span> <span class="pln">_</span> <span class="pun">:</span><span class="pun">=</span> <span class="pln">ctxutil</span><span class="pun">.</span><span class="typ">Value</span><span class="pun">[</span><span class="typ">PathVars</span><span class="pun">]</span><span class="pun">(</span><span class="pln">ctx</span><span class="pun">)</span><span class="pun">;</span> <span class="kwd">return</span> <span class="pln">v</span> <span class="pun">}</span>
  <span class="com">// AddRoute adds a route to the router. Method is the HTTP method to match; if empty, all methods match.</span>
  <span class="com">// Method will be converted to uppercase and trimmed of whitespace, so</span>
  <span class="com">// &#34;get&#34;, &#34;gEt&#34;, &#34; geT&#34;, and &#34;GET&#34; are all equivalent.</span>
  </code></pre>
  
  <p>Adding routes is straightforward:</p>
  
  <pre><code class="language-go"><span class="com">// AddRoute adds a route to the router. Method is the HTTP method to match; if empty, all methods match.</span>
  <span class="kwd">func</span> <span class="pun">(</span><span class="pln">r</span> <span class="pun">*</span><span class="typ">Router</span><span class="pun">)</span> <span class="typ">AddRoute</span><span class="pun">(</span><span class="pln">pattern</span> <span class="pln">string</span><span class="pun">,</span> <span class="pln">h</span> <span class="pln">http</span><span class="pun">.</span><span class="typ">Handler</span><span class="pun">,</span> <span class="pln">method</span> <span class="pln">string</span><span class="pun">)</span> <span class="pln">error</span> <span class="pun">{</span>
      <span class="pln">re</span><span class="pun">,</span> <span class="pln">names</span><span class="pun">,</span> <span class="pln">err</span> <span class="pun">:</span><span class="pun">=</span> <span class="pln">buildRoute</span><span class="pun">(</span><span class="pln">pattern</span><span class="pun">)</span>
      <span class="kwd">if</span> <span class="pln">err</span> <span class="pun">!</span><span class="pun">=</span> <span class="kwd">nil</span> <span class="pun">{</span>
          <span class="kwd">return</span> <span class="pln">err</span>
      <span class="pun">}</span>
      <span class="pln">r</span><span class="pun">.</span><span class="pln">routes</span> <span class="pun">=</span> <span class="kwd">append</span><span class="pun">(</span><span class="pln">r</span><span class="pun">.</span><span class="pln">routes</span><span class="pun">,</span> <span class="pln">route</span><span class="pun">{</span>
          <span class="pln">raw</span><span class="pun">:</span>     <span class="pln">pattern</span><span class="pun">,</span>
          <span class="pln">pattern</span><span class="pun">:</span> <span class="pln">re</span><span class="pun">,</span>
          <span class="pln">names</span><span class="pun">:</span>   <span class="pln">names</span><span class="pun">,</span>
          <span class="pln">method</span><span class="pun">:</span>  <span class="pln">strings</span><span class="pun">.</span><span class="typ">ToUpper</span><span class="pun">(</span><span class="pln">strings</span><span class="pun">.</span><span class="typ">TrimSpace</span><span class="pun">(</span><span class="pln">method</span><span class="pun">)</span><span class="pun">)</span><span class="pun">,</span>
          <span class="pln">handler</span><span class="pun">:</span> <span class="pln">h</span><span class="pun">,</span>
      <span class="pun">}</span><span class="pun">)</span>
  
      <span class="com">// sort the routes by length, so that the longest routes are matched first.</span>
      <span class="pln">sort</span><span class="pun">.</span><span class="typ">Slice</span><span class="pun">(</span><span class="pln">r</span><span class="pun">.</span><span class="pln">routes</span><span class="pun">,</span> <span class="kwd">func</span><span class="pun">(</span><span class="pln">i</span><span class="pun">,</span> <span class="pln">j</span> <span class="kwd">int</span><span class="pun">)</span> <span class="kwd">bool</span> <span class="pun">{</span>
          <span class="kwd">return</span> <span class="pln">len</span><span class="pun">(</span><span class="pln">r</span><span class="pun">.</span><span class="pln">routes</span><span class="pun">[</span><span class="pln">i</span><span class="pun">]</span><span class="pun">.</span><span class="pln">raw</span><span class="pun">)</span> <span class="pun">&gt;</span> <span class="pln">len</span><span class="pun">(</span><span class="pln">r</span><span class="pun">.</span><span class="pln">routes</span><span class="pun">[</span><span class="pln">j</span><span class="pun">]</span><span class="pun">.</span><span class="pln">raw</span><span class="pun">)</span> <span class="pun">|</span><span class="pun">|</span> <span class="pun">(</span><span class="pln">len</span><span class="pun">(</span><span class="pln">r</span><span class="pun">.</span><span class="pln">routes</span><span class="pun">[</span><span class="pln">i</span><span class="pun">]</span><span class="pun">.</span><span class="pln">raw</span><span class="pun">)</span> <span class="pun">=</span><span class="pun">=</span> <span class="pln">len</span><span class="pun">(</span><span class="pln">r</span><span class="pun">.</span><span class="pln">routes</span><span class="pun">[</span><span class="pln">j</span><span class="pun">]</span><span class="pun">.</span><span class="pln">raw</span><span class="pun">)</span> <span class="pun">&amp;</span><span class="pun">&amp;</span> <span class="pln">r</span><span class="pun">.</span><span class="pln">routes</span><span class="pun">[</span><span class="pln">i</span><span class="pun">]</span><span class="pun">.</span><span class="pln">raw</span> <span class="pun">&lt;</span> <span class="pln">r</span><span class="pun">.</span><span class="pln">routes</span><span class="pun">[</span><span class="pln">j</span><span class="pun">]</span><span class="pun">.</span><span class="pln">raw</span><span class="pun">)</span> <span class="com">// sort by length, then lexicographically</span>
      <span class="pun">}</span><span class="pun">)</span>
      <span class="kwd">return</span> <span class="kwd">nil</span>
  <span class="pun">}</span>
  </code></pre>
  
  <p>Building the routes was the hard part; actual dispatch is easy. We pick the first route that matches the request path, add the relevant path segments to a map in the context, and serve the request using the associated handler.</p>
  
  <pre><code class="language-go">
  <span class="com">// pathVars extracts the path parameters from the path and into a map. leave it as-is.</span>
  <span class="kwd">func</span> <span class="pln">pathVars</span><span class="pun">(</span><span class="pln">re</span> <span class="pun">*</span><span class="pln">regexp</span><span class="pun">.</span><span class="typ">Regexp</span><span class="pun">,</span> <span class="pln">names</span> <span class="pun">[</span><span class="pun">]</span><span class="pln">string</span><span class="pun">,</span> <span class="pln">path</span> <span class="pln">string</span><span class="pun">)</span> <span class="typ">PathVars</span> <span class="pun">{</span>
      <span class="pln">matches</span> <span class="pun">:</span><span class="pun">=</span> <span class="pln">re</span><span class="pun">.</span><span class="typ">FindStringSubmatch</span><span class="pun">(</span><span class="pln">path</span><span class="pun">)</span>
      <span class="kwd">if</span> <span class="pln">len</span><span class="pun">(</span><span class="pln">matches</span><span class="pun">)</span> <span class="pun">!</span><span class="pun">=</span> <span class="pln">len</span><span class="pun">(</span><span class="pln">names</span><span class="pun">)</span><span class="pun">+</span><span class="dec">1</span> <span class="pun">{</span> <span class="com">// +1 because the first match is the entire string</span>
          <span class="pln">panic</span><span class="pun">(</span><span class="pln">fmt</span><span class="pun">.</span><span class="typ">Errorf</span><span class="pun">(</span><span class="str">&#34;programmer error: expected regexp %q to match %q&#34;</span><span class="pun">,</span> <span class="pln">path</span><span class="pun">,</span> <span class="pln">re</span><span class="pun">.</span><span class="typ">String</span><span class="pun">(</span><span class="pun">)</span><span class="pun">)</span><span class="pun">)</span>
      <span class="pun">}</span>
      <span class="pln">vars</span> <span class="pun">:</span><span class="pun">=</span> <span class="kwd">make</span><span class="pun">(</span><span class="typ">PathVars</span><span class="pun">,</span> <span class="pln">len</span><span class="pun">(</span><span class="pln">names</span><span class="pun">)</span><span class="pun">)</span>
      <span class="kwd">for</span> <span class="pln">i</span><span class="pun">,</span> <span class="pln">match</span> <span class="pun">:</span><span class="pun">=</span> <span class="pln">range</span> <span class="pln">matches</span><span class="pun">[</span><span class="dec">1</span><span class="pun">:</span><span class="pun">]</span> <span class="pun">{</span> <span class="com">// again, skip the first match, which is the entire string</span>
          <span class="pln">vars</span><span class="pun">[</span><span class="pln">names</span><span class="pun">[</span><span class="pln">i</span><span class="pun">]</span><span class="pun">]</span> <span class="pun">=</span> <span class="pln">match</span>
      <span class="pun">}</span>
      <span class="kwd">return</span> <span class="pln">vars</span>
  <span class="pun">}</span>
  
  <span class="com">// ServeHTTP implements http.Handler, dispatching requests to the appropriate handler.</span>
  <span class="kwd">func</span> <span class="pun">(</span><span class="pln">rt</span> <span class="pun">*</span><span class="typ">Router</span><span class="pun">)</span> <span class="typ">ServeHTTP</span><span class="pun">(</span><span class="pln">w</span> <span class="pln">http</span><span class="pun">.</span><span class="typ">ResponseWriter</span><span class="pun">,</span> <span class="pln">r</span> <span class="pun">*</span><span class="pln">http</span><span class="pun">.</span><span class="typ">Request</span><span class="pun">)</span> <span class="pun">{</span>
      <span class="kwd">for</span> <span class="pln">_</span><span class="pun">,</span> <span class="pln">route</span> <span class="pun">:</span><span class="pun">=</span> <span class="pln">range</span> <span class="pln">rt</span><span class="pun">.</span><span class="pln">routes</span> <span class="pun">{</span>
          <span class="kwd">if</span> <span class="pln">route</span><span class="pun">.</span><span class="pln">pattern</span><span class="pun">.</span><span class="typ">MatchString</span><span class="pun">(</span><span class="pln">r</span><span class="pun">.</span><span class="typ">URL</span><span class="pun">.</span><span class="typ">Path</span><span class="pun">)</span> <span class="pun">&amp;</span><span class="pun">&amp;</span> <span class="pun">(</span><span class="pln">route</span><span class="pun">.</span><span class="pln">method</span> <span class="pun">=</span><span class="pun">=</span> <span class="str">&#34;&#34;</span> <span class="pun">|</span><span class="pun">|</span> <span class="pln">route</span><span class="pun">.</span><span class="pln">method</span> <span class="pun">=</span><span class="pun">=</span> <span class="pln">r</span><span class="pun">.</span><span class="typ">Method</span><span class="pun">)</span> <span class="pun">{</span>
              <span class="pln">vars</span> <span class="pun">:</span><span class="pun">=</span> <span class="pln">pathVars</span><span class="pun">(</span><span class="pln">route</span><span class="pun">.</span><span class="pln">pattern</span><span class="pun">,</span> <span class="pln">route</span><span class="pun">.</span><span class="pln">names</span><span class="pun">,</span> <span class="pln">r</span><span class="pun">.</span><span class="typ">URL</span><span class="pun">.</span><span class="typ">Path</span><span class="pun">)</span>
              <span class="pln">ctx</span> <span class="pun">:</span><span class="pun">=</span> <span class="typ">CtxWithVal</span><span class="pun">(</span><span class="pln">r</span><span class="pun">.</span><span class="typ">Context</span><span class="pun">(</span><span class="pun">)</span><span class="pun">,</span> <span class="pln">vars</span><span class="pun">)</span>
              <span class="pln">route</span><span class="pun">.</span><span class="pln">handler</span><span class="pun">.</span><span class="typ">ServeHTTP</span><span class="pun">(</span><span class="pln">w</span><span class="pun">,</span> <span class="pln">r</span><span class="pun">.</span><span class="typ">WithContext</span><span class="pun">(</span><span class="pln">ctx</span><span class="pun">)</span><span class="pun">)</span>
              <span class="kwd">return</span>
          <span class="pun">}</span>
      <span class="pun">}</span>
      <span class="pln">http</span><span class="pun">.</span><span class="typ">NotFound</span><span class="pun">(</span><span class="pln">w</span><span class="pun">,</span> <span class="pln">r</span><span class="pun">)</span> <span class="com">// no route matched; serve a 404</span>
  <span class="pun">}</span>
  
  </code></pre>
  
  <p>This router is missing some important features: among other things, it doesn’t do any kind of path normalization, it has no performance guarantees, and it doesn’t properly handle URL and Regexp escaping and normalization. As such, unlike my usual advice, if you need more sophisticated routing than the stdlib can provide, <strong>I suggest you use an external routing library rather than build it yourself. But just use a router</strong> - don’t use anything that forces you in to an entire ecosystem of libraries and frameworks.</p>
  
  <p>That being said, this router is perfectly fine for small programs, and more importantly, <em>now you know how they work</em>, so you can figure out how to fix them if they go wrong.</p>
  
  <h3>Graduation: Putting it all together</h3>
  
  <p>Let’s write ourselves a client and server that puts together all the pieces we’ve written so far. Our server will route to multiple endpoints. Some of our routes will take a POST json body, some will take query parameters, and still others will take path parameters. We’ll use all the middleware we’ve written so far in order to log, trace, and recover from panics.</p>
  
  <p>The following program, <code>graduation</code>, implements a complete web server that demonstrates all of the concepts we’ve covered so far.</p>
  
  <p>First, we’ll use our router to register all the endpoints we want to serve.</p>
  
  <pre><code class="language-go"><span class="kwd">package</span> <span class="pln">main</span>
  <span class="com">// register routes.</span>
  <span class="kwd">func</span> <span class="pln">buildBaseRouter</span><span class="pun">(</span><span class="pun">)</span> <span class="pun">(</span><span class="pun">*</span><span class="typ">Router</span><span class="pun">,</span> <span class="pln">error</span><span class="pun">)</span> <span class="pun">{</span>
      <span class="kwd">var</span> <span class="pln">r</span> <span class="pun">=</span> <span class="kwd">new</span><span class="pun">(</span><span class="typ">Router</span><span class="pun">)</span> <span class="com">// we&#39;ll add routes to this router.</span>
      <span class="com">/* --- design note: ---
      you could just add the routes on a separate line for each, 
      but I like building the slice of routes and iterating over it; 
      it makes the essential similarity of each route more obvious.
      */</span>
      <span class="kwd">for</span> <span class="pln">_</span><span class="pun">,</span> <span class="pln">route</span> <span class="pun">:</span><span class="pun">=</span> <span class="pln">range</span> <span class="pun">[</span><span class="pun">]</span><span class="kwd">struct</span> <span class="pun">{</span>
          <span class="pln">pattern</span><span class="pun">,</span> <span class="pln">method</span> <span class="pln">string</span>
          <span class="pln">handler</span>         <span class="pln">http</span><span class="pun">.</span><span class="typ">HandlerFunc</span>
      <span class="pun">}</span><span class="pun">{</span>
          <span class="com">// GET / returns &#34;Hello, world!&#34;</span>
  
          <span class="pun">{</span>
              <span class="pln">pattern</span><span class="pun">:</span> <span class="str">&#34;/&#34;</span><span class="pun">,</span>
              <span class="pln">method</span><span class="pun">:</span>  <span class="str">&#34;GET&#34;</span><span class="pun">,</span>
              <span class="com">/* ----- design note: ----
                  this route demonstrates the simplest possible handler.
                  note the _ for the request parameter; we don&#39;t need it, so we don&#39;t bind it.
              -----------------------------*/</span>
              <span class="pln">handler</span><span class="pun">:</span> <span class="kwd">func</span><span class="pun">(</span><span class="pln">w</span> <span class="pln">http</span><span class="pun">.</span><span class="typ">ResponseWriter</span><span class="pun">,</span> <span class="pln">_</span> <span class="pun">*</span><span class="pln">http</span><span class="pun">.</span><span class="typ">Request</span><span class="pun">)</span> <span class="pun">{</span> <span class="pln">w</span><span class="pun">.</span><span class="typ">Write</span><span class="pun">(</span><span class="pun">[</span><span class="pun">]</span><span class="kwd">byte</span><span class="pun">(</span><span class="str">&#34;Hello, world!\r\n&#34;</span><span class="pun">)</span><span class="pun">)</span> <span class="pun">}</span><span class="pun">,</span>
          <span class="pun">}</span><span class="pun">,</span>
  
          <span class="com">// GET /panic always panics.</span>
  
          <span class="pun">{</span>
              <span class="pln">pattern</span><span class="pun">:</span> <span class="str">&#34;/panic&#34;</span><span class="pun">,</span>
              <span class="pln">method</span><span class="pun">:</span>  <span class="str">&#34;GET&#34;</span><span class="pun">,</span>
              <span class="com">/* ----- design note: ----
                  this route demonstrates how middleware can handle error conditions:
                  the panic will be caught by Recovery, which will write a 500 status code and &#34;internal server error&#34; message to the response.
                  rather than leaving the connection hanging.
                  note the _ and _ for the request and response parameters; we don&#39;t need them, so we don&#39;t bind them.
              -----------------------------*/</span>
              <span class="pln">handler</span><span class="pun">:</span> <span class="kwd">func</span><span class="pun">(</span><span class="pln">_</span> <span class="pln">http</span><span class="pun">.</span><span class="typ">ResponseWriter</span><span class="pun">,</span> <span class="pln">_</span> <span class="pun">*</span><span class="pln">http</span><span class="pun">.</span><span class="typ">Request</span><span class="pun">)</span> <span class="pun">{</span> <span class="pln">panic</span><span class="pun">(</span><span class="str">&#34;oh my god JC, a bomb!&#34;</span><span class="pun">)</span> <span class="pun">}</span><span class="pun">,</span>
          <span class="pun">}</span><span class="pun">,</span>
  
          <span class="com">// POST /greet/json returns a JSON object with a greeting and a category based on the age.</span>
          <span class="com">// it must be called with a JSON object in the form {&#34;first&#34;: &#34;efron&#34;, &#34;last&#34;: &#34;licht&#34;, &#34;age&#34;: 32}</span>
          <span class="pun">{</span>
              <span class="str">&#34;/greet/json&#34;</span><span class="pun">,</span>
              <span class="str">&#34;POST&#34;</span><span class="pun">,</span>
              <span class="com">/* ----- design note: ----
              // this route is a sophisticated example that has both path parameters (using our custom router) and query parameters.
              // it &#39;puts everything together&#39; and demonstrates how to use the router and middleware together.
              // ---- */</span>
              <span class="kwd">func</span><span class="pun">(</span><span class="pln">w</span> <span class="pln">http</span><span class="pun">.</span><span class="typ">ResponseWriter</span><span class="pun">,</span> <span class="pln">r</span> <span class="pun">*</span><span class="pln">http</span><span class="pun">.</span><span class="typ">Request</span><span class="pun">)</span> <span class="pun">{</span>
  
                  <span class="kwd">var</span> <span class="pln">req</span> <span class="kwd">struct</span> <span class="pun">{</span>
                      <span class="typ">First</span><span class="pun">,</span> <span class="typ">Last</span> <span class="pln">string</span>
                      <span class="typ">Age</span>         <span class="kwd">int</span>
                  <span class="pun">}</span>
                  <span class="kwd">if</span> <span class="pln">err</span> <span class="pun">:</span><span class="pun">=</span> <span class="pln">json</span><span class="pun">.</span><span class="typ">NewDecoder</span><span class="pun">(</span><span class="pln">r</span><span class="pun">.</span><span class="typ">Body</span><span class="pun">)</span><span class="pun">.</span><span class="typ">Decode</span><span class="pun">(</span><span class="pun">&amp;</span><span class="pln">req</span><span class="pun">)</span><span class="pun">;</span> <span class="pln">err</span> <span class="pun">!</span><span class="pun">=</span> <span class="kwd">nil</span> <span class="pun">{</span>
                      <span class="typ">WriteError</span><span class="pun">(</span><span class="pln">w</span><span class="pun">,</span> <span class="pln">err</span><span class="pun">,</span> <span class="pln">http</span><span class="pun">.</span><span class="typ">StatusBadRequest</span><span class="pun">)</span> <span class="com">// remember to return after writing an error!</span>
                      <span class="kwd">return</span>
                  <span class="pun">}</span>
                  <span class="kwd">if</span> <span class="pln">req</span><span class="pun">.</span><span class="typ">Age</span> <span class="pun">&lt;</span> <span class="dec">0</span> <span class="pun">{</span>
                      <span class="typ">WriteError</span><span class="pun">(</span><span class="pln">w</span><span class="pun">,</span> <span class="pln">errors</span><span class="pun">.</span><span class="typ">New</span><span class="pun">(</span><span class="str">&#34;age must be &gt;= 0&#34;</span><span class="pun">)</span><span class="pun">,</span> <span class="pln">http</span><span class="pun">.</span><span class="typ">StatusBadRequest</span><span class="pun">)</span>
                      <span class="kwd">return</span>
                  <span class="pun">}</span>
                  <span class="kwd">var</span> <span class="pln">category</span> <span class="pln">string</span>
                  <span class="kwd">switch</span> <span class="pun">{</span>
                  <span class="kwd">case</span> <span class="pln">req</span><span class="pun">.</span><span class="typ">Age</span> <span class="pun">&lt;</span> <span class="dec">13</span><span class="pun">:</span>
                      <span class="typ">WriteError</span><span class="pun">(</span><span class="pln">w</span><span class="pun">,</span> <span class="pln">errors</span><span class="pun">.</span><span class="typ">New</span><span class="pun">(</span><span class="str">&#34;forbidden: come back when you&#39;re older&#34;</span><span class="pun">)</span><span class="pun">,</span> <span class="pln">http</span><span class="pun">.</span><span class="typ">StatusForbidden</span><span class="pun">)</span>
                      <span class="kwd">return</span>
                  <span class="kwd">case</span> <span class="pln">req</span><span class="pun">.</span><span class="typ">Age</span> <span class="pun">&lt;</span> <span class="dec">21</span><span class="pun">:</span>
                      <span class="pln">category</span> <span class="pun">=</span> <span class="str">&#34;teenager&#34;</span>
                  <span class="kwd">case</span> <span class="pln">req</span><span class="pun">.</span><span class="typ">Age</span> <span class="pun">&gt;</span> <span class="dec">65</span><span class="pun">:</span>
                      <span class="pln">category</span> <span class="pun">=</span> <span class="str">&#34;senior&#34;</span>
                  <span class="kwd">default</span><span class="pun">:</span>
                      <span class="pln">category</span> <span class="pun">=</span> <span class="str">&#34;adult&#34;</span>
                  <span class="pun">}</span>
                  <span class="pln">_</span> <span class="pun">=</span> <span class="typ">WriteJSON</span><span class="pun">(</span><span class="pln">w</span><span class="pun">,</span> <span class="kwd">struct</span> <span class="pun">{</span>
                      <span class="typ">Greeting</span> <span class="pln">string</span> <span class="str">`json:&#34;greeting&#34;`</span>
                      <span class="typ">Category</span> <span class="pln">string</span> <span class="str">`json:&#34;category&#34;`</span>
                  <span class="pun">}</span><span class="pun">{</span>
                      <span class="pln">fmt</span><span class="pun">.</span><span class="typ">Sprintf</span><span class="pun">(</span><span class="str">&#34;Hello, %s %s!&#34;</span><span class="pun">,</span> <span class="pln">req</span><span class="pun">.</span><span class="typ">First</span><span class="pun">,</span> <span class="pln">req</span><span class="pun">.</span><span class="typ">Last</span><span class="pun">)</span><span class="pun">,</span>
                      <span class="pln">category</span><span class="pun">,</span>
                  <span class="pun">}</span><span class="pun">)</span>
              <span class="pun">}</span><span class="pun">}</span><span class="pun">,</span>
  
          <span class="com">// GET /time returns the current time in the given format.</span>
          <span class="com">// it demonstrates how to use query parameters.</span>
          <span class="pun">{</span>
              <span class="pln">pattern</span><span class="pun">:</span> <span class="str">&#34;/time&#34;</span><span class="pun">,</span>
              <span class="pln">method</span><span class="pun">:</span>  <span class="str">&#34;GET&#34;</span><span class="pun">,</span>
              <span class="pln">handler</span><span class="pun">:</span> <span class="kwd">func</span><span class="pun">(</span><span class="pln">w</span> <span class="pln">http</span><span class="pun">.</span><span class="typ">ResponseWriter</span><span class="pun">,</span> <span class="pln">r</span> <span class="pun">*</span><span class="pln">http</span><span class="pun">.</span><span class="typ">Request</span><span class="pun">)</span> <span class="pun">{</span>
                  <span class="pln">format</span> <span class="pun">:</span><span class="pun">=</span> <span class="pln">r</span><span class="pun">.</span><span class="typ">URL</span><span class="pun">.</span><span class="typ">Query</span><span class="pun">(</span><span class="pun">)</span><span class="pun">.</span><span class="typ">Get</span><span class="pun">(</span><span class="str">&#34;format&#34;</span><span class="pun">)</span>
                  <span class="kwd">if</span> <span class="pln">format</span> <span class="pun">=</span><span class="pun">=</span> <span class="str">&#34;&#34;</span> <span class="pun">{</span>
                      <span class="pln">format</span> <span class="pun">=</span> <span class="pln">time</span><span class="pun">.</span><span class="typ">RFC3339</span>
                  <span class="pun">}</span>
                  <span class="pln">tz</span> <span class="pun">:</span><span class="pun">=</span> <span class="pln">r</span><span class="pun">.</span><span class="typ">URL</span><span class="pun">.</span><span class="typ">Query</span><span class="pun">(</span><span class="pun">)</span><span class="pun">.</span><span class="typ">Get</span><span class="pun">(</span><span class="str">&#34;tz&#34;</span><span class="pun">)</span>
                  <span class="kwd">var</span> <span class="pln">loc</span> <span class="pun">*</span><span class="pln">time</span><span class="pun">.</span><span class="typ">Location</span> <span class="pun">=</span> <span class="pln">time</span><span class="pun">.</span><span class="typ">Local</span>
                  <span class="kwd">if</span> <span class="pln">tz</span> <span class="pun">!</span><span class="pun">=</span> <span class="str">&#34;&#34;</span> <span class="pun">{</span>
                      <span class="kwd">var</span> <span class="pln">err</span> <span class="pln">error</span>
                      <span class="pln">loc</span><span class="pun">,</span> <span class="pln">err</span> <span class="pun">=</span> <span class="pln">time</span><span class="pun">.</span><span class="typ">LoadLocation</span><span class="pun">(</span><span class="pln">tz</span><span class="pun">)</span>
                      <span class="kwd">if</span> <span class="pln">err</span> <span class="pun">!</span><span class="pun">=</span> <span class="kwd">nil</span> <span class="pun">{</span>
                          <span class="typ">WriteError</span><span class="pun">(</span><span class="pln">w</span><span class="pun">,</span> <span class="pln">fmt</span><span class="pun">.</span><span class="typ">Errorf</span><span class="pun">(</span><span class="str">&#34;invalid timezone %q: %w&#34;</span><span class="pun">,</span> <span class="pln">tz</span><span class="pun">,</span> <span class="pln">err</span><span class="pun">)</span><span class="pun">,</span> <span class="pln">http</span><span class="pun">.</span><span class="typ">StatusBadRequest</span><span class="pun">)</span>
                          <span class="kwd">return</span>
                      <span class="pun">}</span>
                  <span class="pun">}</span>
                  <span class="pln">_</span> <span class="pun">=</span> <span class="typ">WriteJSON</span><span class="pun">(</span><span class="pln">w</span><span class="pun">,</span> <span class="kwd">struct</span> <span class="pun">{</span>
                      <span class="typ">Time</span> <span class="pln">string</span> <span class="str">`json:&#34;time&#34;`</span>
                  <span class="pun">}</span><span class="pun">{</span><span class="pln">time</span><span class="pun">.</span><span class="typ">Now</span><span class="pun">(</span><span class="pun">)</span><span class="pun">.</span><span class="typ">In</span><span class="pun">(</span><span class="pln">loc</span><span class="pun">)</span><span class="pun">.</span><span class="typ">Format</span><span class="pun">(</span><span class="pln">format</span><span class="pun">)</span><span class="pun">}</span><span class="pun">)</span>
              <span class="pun">}</span><span class="pun">,</span>
          <span class="pun">}</span><span class="pun">,</span>
          <span class="com">// GET /echo/{a}/{b}/{c} returns the path parameters as a JSON object in the form {&#34;a&#34;: &#34;value of a&#34;, &#34;b&#34;: &#34;value of b&#34;, &#34;c&#34;: &#34;value of c&#34;}</span>
          <span class="com">// the query parameter &#34;case&#34; can be &#34;upper&#34; or &#34;lower&#34; to convert the values to uppercase or lowercase.</span>
          <span class="pun">{</span>
              <span class="pln">pattern</span><span class="pun">:</span> <span class="str">&#34;/echo/{a:.+}/{b:.+}/{c:.+}&#34;</span><span class="pun">,</span>
              <span class="pln">method</span><span class="pun">:</span>  <span class="str">&#34;GET&#34;</span><span class="pun">,</span>
              <span class="com">/* ----- design note: ----
              this route is a sophisticated example that has both path parameters (using our custom router)
              and query parameters.
              it &#39;puts everything together&#39; and demonstrates how to use the router and middleware together.
              ---- */</span>
              <span class="pln">handler</span><span class="pun">:</span> <span class="kwd">func</span><span class="pun">(</span><span class="pln">w</span> <span class="pln">http</span><span class="pun">.</span><span class="typ">ResponseWriter</span><span class="pun">,</span> <span class="pln">r</span> <span class="pun">*</span><span class="pln">http</span><span class="pun">.</span><span class="typ">Request</span><span class="pun">)</span> <span class="pun">{</span>
                  <span class="pln">vars</span><span class="pun">,</span> <span class="pln">_</span> <span class="pun">:</span><span class="pun">=</span> <span class="pln">ctxutil</span><span class="pun">.</span><span class="typ">Value</span><span class="pun">[</span><span class="typ">PathVars</span><span class="pun">]</span><span class="pun">(</span><span class="pln">r</span><span class="pun">.</span><span class="typ">Context</span><span class="pun">(</span><span class="pun">)</span><span class="pun">)</span>
                  <span class="kwd">switch</span> <span class="pln">strings</span><span class="pun">.</span><span class="typ">ToLower</span><span class="pun">(</span><span class="pln">r</span><span class="pun">.</span><span class="typ">URL</span><span class="pun">.</span><span class="typ">Query</span><span class="pun">(</span><span class="pun">)</span><span class="pun">.</span><span class="typ">Get</span><span class="pun">(</span><span class="str">&#34;case&#34;</span><span class="pun">)</span><span class="pun">)</span> <span class="pun">{</span>
                  <span class="kwd">case</span> <span class="str">&#34;upper&#34;</span><span class="pun">:</span>
                      <span class="kwd">for</span> <span class="pln">k</span><span class="pun">,</span> <span class="pln">v</span> <span class="pun">:</span><span class="pun">=</span> <span class="pln">range</span> <span class="pln">vars</span> <span class="pun">{</span>
                          <span class="pln">vars</span><span class="pun">[</span><span class="pln">k</span><span class="pun">]</span> <span class="pun">=</span> <span class="pln">strings</span><span class="pun">.</span><span class="typ">ToUpper</span><span class="pun">(</span><span class="pln">v</span><span class="pun">)</span>
                      <span class="pun">}</span>
                  <span class="kwd">case</span> <span class="str">&#34;lower&#34;</span><span class="pun">:</span>
                      <span class="kwd">for</span> <span class="pln">k</span><span class="pun">,</span> <span class="pln">v</span> <span class="pun">:</span><span class="pun">=</span> <span class="pln">range</span> <span class="pln">vars</span> <span class="pun">{</span>
                          <span class="pln">vars</span><span class="pun">[</span><span class="pln">k</span><span class="pun">]</span> <span class="pun">=</span> <span class="pln">strings</span><span class="pun">.</span><span class="typ">ToLower</span><span class="pun">(</span><span class="pln">v</span><span class="pun">)</span>
                      <span class="pun">}</span>
                  <span class="pun">}</span>
                  <span class="pln">_</span> <span class="pun">=</span> <span class="typ">WriteJSON</span><span class="pun">(</span><span class="pln">w</span><span class="pun">,</span> <span class="pln">vars</span><span class="pun">)</span>
              <span class="pun">}</span><span class="pun">,</span>
          <span class="pun">}</span><span class="pun">,</span>
      <span class="pun">}</span> <span class="pun">{</span>
          <span class="kwd">if</span> <span class="pln">err</span> <span class="pun">:</span><span class="pun">=</span> <span class="pln">r</span><span class="pun">.</span><span class="typ">AddRoute</span><span class="pun">(</span><span class="pln">route</span><span class="pun">.</span><span class="pln">pattern</span><span class="pun">,</span> <span class="pln">route</span><span class="pun">.</span><span class="pln">handler</span><span class="pun">,</span> <span class="pln">route</span><span class="pun">.</span><span class="pln">method</span><span class="pun">)</span><span class="pun">;</span> <span class="pln">err</span> <span class="pun">!</span><span class="pun">=</span> <span class="kwd">nil</span> <span class="pun">{</span>
              <span class="kwd">return</span> <span class="kwd">nil</span><span class="pun">,</span> <span class="pln">fmt</span><span class="pun">.</span><span class="typ">Errorf</span><span class="pun">(</span><span class="str">&#34;AddRoute(%q, %v, %q) returned error: %v&#34;</span><span class="pun">,</span> <span class="pln">route</span><span class="pun">.</span><span class="pln">pattern</span><span class="pun">,</span> <span class="pln">route</span><span class="pun">.</span><span class="pln">handler</span><span class="pun">,</span> <span class="pln">route</span><span class="pun">.</span><span class="pln">method</span><span class="pun">,</span> <span class="pln">err</span><span class="pun">)</span>
  
          <span class="pun">}</span>
          <span class="pln">log</span><span class="pun">.</span><span class="typ">Printf</span><span class="pun">(</span><span class="str">&#34;registered route: %s %s&#34;</span><span class="pun">,</span> <span class="pln">route</span><span class="pun">.</span><span class="pln">method</span><span class="pun">,</span> <span class="pln">route</span><span class="pun">.</span><span class="pln">pattern</span><span class="pun">)</span>
      <span class="pun">}</span>
      <span class="kwd">return</span> <span class="pln">r</span><span class="pun">,</span> <span class="kwd">nil</span>
  <span class="pun">}</span>
  </code></pre>
  
  <p>In main, we’ll take the router we just built and add some of the server middleware we previously wrote:</p>
  
  <pre><code class="language-go">
  <span class="kwd">func</span> <span class="pln">main</span><span class="pun">(</span><span class="pun">)</span> <span class="pun">{</span>
      <span class="pln">port</span> <span class="pun">:</span><span class="pun">=</span> <span class="pln">flag</span><span class="pun">.</span><span class="typ">Int</span><span class="pun">(</span><span class="str">&#34;port&#34;</span><span class="pun">,</span> <span class="dec">8080</span><span class="pun">,</span> <span class="str">&#34;port to listen on&#34;</span><span class="pun">)</span>
      <span class="pln">flag</span><span class="pun">.</span><span class="typ">Parse</span><span class="pun">(</span><span class="pun">)</span>
  
      <span class="pln">h</span><span class="pun">,</span> <span class="pln">err</span> <span class="pun">:</span><span class="pun">=</span> <span class="pln">buildBaseRouter</span><span class="pun">(</span><span class="pun">)</span>
      <span class="kwd">if</span> <span class="pln">err</span> <span class="pun">!</span><span class="pun">=</span> <span class="kwd">nil</span> <span class="pun">{</span>
          <span class="pln">log</span><span class="pun">.</span><span class="typ">Fatal</span><span class="pun">(</span><span class="pln">err</span><span class="pun">)</span>
      <span class="pun">}</span>
      <span class="pln">h</span> <span class="pun">=</span> <span class="pln">applyMiddleware</span><span class="pun">(</span><span class="pln">h</span><span class="pun">)</span>
  </code></pre>
  
  <p>Then we’ll start up the server.</p>
  
  <pre><code class="language-go">    <span class="com">// build and start the server.</span>
      <span class="com">// remember, you should always apply at least the Read and Write timeouts to your server.</span>
      <span class="pln">server</span> <span class="pun">:</span><span class="pun">=</span> <span class="pln">http</span><span class="pun">.</span><span class="typ">Server</span><span class="pun">{</span>
          <span class="typ">Addr</span><span class="pun">:</span>         <span class="pln">fmt</span><span class="pun">.</span><span class="typ">Sprintf</span><span class="pun">(</span><span class="str">&#34;:%d&#34;</span><span class="pun">,</span> <span class="pun">*</span><span class="pln">port</span><span class="pun">)</span><span class="pun">,</span>
          <span class="typ">Handler</span><span class="pun">:</span>      <span class="pln">h</span><span class="pun">,</span>
          <span class="typ">ReadTimeout</span><span class="pun">:</span>  <span class="dec">1</span> <span class="pun">*</span> <span class="pln">time</span><span class="pun">.</span><span class="typ">Second</span><span class="pun">,</span>
          <span class="typ">WriteTimeout</span><span class="pun">:</span> <span class="dec">1</span> <span class="pun">*</span> <span class="pln">time</span><span class="pun">.</span><span class="typ">Second</span><span class="pun">,</span>
      <span class="pun">}</span>
      <span class="pln">log</span><span class="pun">.</span><span class="typ">Printf</span><span class="pun">(</span><span class="str">&#34;listening on %s&#34;</span><span class="pun">,</span> <span class="pln">server</span><span class="pun">.</span><span class="typ">Addr</span><span class="pun">)</span>
      <span class="pln">go</span> <span class="pln">server</span><span class="pun">.</span><span class="typ">ListenAndServe</span><span class="pun">(</span><span class="pun">)</span>
      <span class="pln">time</span><span class="pun">.</span><span class="typ">Sleep</span><span class="pun">(</span><span class="dec">20</span> <span class="pun">*</span> <span class="pln">time</span><span class="pun">.</span><span class="typ">Millisecond</span><span class="pun">)</span>
  <span class="pun">}</span>
  </code></pre>
  
  <p>The following program, <code>graduationdemo</code>, hits the server we just wrote with a variety of requests, demonstrating all the endpoints we just wrote.</p>
  
  <pre><code class="language-go"><span class="kwd">package</span> <span class="pln">main</span>
  <span class="kwd">func</span> <span class="pln">main</span><span class="pun">(</span><span class="pun">)</span> <span class="pun">{</span>
      <span class="kwd">var</span> <span class="pln">port</span> <span class="kwd">int</span>
      <span class="pln">flag</span><span class="pun">.</span><span class="typ">IntVar</span><span class="pun">(</span><span class="pun">&amp;</span><span class="pln">port</span><span class="pun">,</span> <span class="str">&#34;port&#34;</span><span class="pun">,</span> <span class="dec">8080</span><span class="pun">,</span> <span class="str">&#34;port for outgoing requests&#34;</span><span class="pun">)</span>
      <span class="pln">flag</span><span class="pun">.</span><span class="typ">Parse</span><span class="pun">(</span><span class="pun">)</span>
      <span class="pln">rt</span> <span class="pun">=</span> <span class="pln">clientmw</span><span class="pun">.</span><span class="typ">Trace</span><span class="pun">(</span><span class="pln">rt</span><span class="pun">)</span>
      <span class="pln">rt</span> <span class="pun">=</span> <span class="pln">clientmw</span><span class="pun">.</span><span class="typ">Log</span><span class="pun">(</span><span class="pln">rt</span><span class="pun">)</span>
      <span class="pln">client</span> <span class="pun">:</span><span class="pun">=</span> <span class="pun">&amp;</span><span class="pln">http</span><span class="pun">.</span><span class="typ">Client</span><span class="pun">{</span>
          <span class="typ">Transport</span><span class="pun">:</span> <span class="pln">rt</span><span class="pun">,</span>
          <span class="typ">Timeout</span><span class="pun">:</span>   <span class="dec">1</span> <span class="pun">*</span> <span class="pln">time</span><span class="pun">.</span><span class="typ">Second</span><span class="pun">,</span>
      <span class="pun">}</span>
      <span class="pln">req</span><span class="pun">,</span> <span class="pln">err</span> <span class="pun">:</span><span class="pun">=</span> <span class="pln">http</span><span class="pun">.</span><span class="typ">NewRequest</span><span class="pun">(</span><span class="str">&#34;GET&#34;</span><span class="pun">,</span> <span class="pln">fmt</span><span class="pun">.</span><span class="typ">Sprintf</span><span class="pun">(</span><span class="str">&#34;http://localhost:%d/panic&#34;</span><span class="pun">,</span> <span class="pln">port</span><span class="pun">)</span><span class="pun">,</span> <span class="kwd">nil</span><span class="pun">)</span>
      <span class="kwd">if</span> <span class="pln">err</span> <span class="pun">!</span><span class="pun">=</span> <span class="kwd">nil</span> <span class="pun">{</span>
          <span class="pln">log</span><span class="pun">.</span><span class="typ">Fatal</span><span class="pun">(</span><span class="pln">err</span><span class="pun">)</span>
      <span class="pun">}</span>
  
      <span class="pln">resp</span><span class="pun">,</span> <span class="pln">err</span> <span class="pun">:</span><span class="pun">=</span> <span class="pln">client</span><span class="pun">.</span><span class="typ">Do</span><span class="pun">(</span><span class="pln">req</span><span class="pun">)</span>
      <span class="kwd">if</span> <span class="pln">err</span> <span class="pun">!</span><span class="pun">=</span> <span class="kwd">nil</span> <span class="pun">{</span>
          <span class="pln">log</span><span class="pun">.</span><span class="typ">Fatal</span><span class="pun">(</span><span class="pln">err</span><span class="pun">)</span>
      <span class="pun">}</span>
      <span class="pln">fmt</span><span class="pun">.</span><span class="typ">Println</span><span class="pun">(</span><span class="str">&#34;GET /panic:&#34;</span><span class="pun">)</span>
      <span class="pln">resp</span><span class="pun">.</span><span class="typ">Write</span><span class="pun">(</span><span class="pln">os</span><span class="pun">.</span><span class="typ">Stdout</span><span class="pun">)</span>
  
      <span class="kwd">var</span> <span class="pln">paths</span> <span class="pun">=</span> <span class="pun">[</span><span class="pun">]</span><span class="pln">string</span><span class="pun">{</span>
          <span class="str">&#34;/&#34;</span><span class="pun">,</span>
          <span class="str">&#34;/echo/first/second/third&#34;</span><span class="pun">,</span>
          <span class="str">&#34;/echo/first/second/third&#34;</span><span class="pun">,</span>
          <span class="str">&#34;/echo/first/second/third&#34;</span><span class="pun">,</span>
          <span class="str">&#34;/time&#34;</span><span class="pun">,</span>
          <span class="str">&#34;/time&#34;</span><span class="pun">,</span>
          <span class="str">&#34;/time&#34;</span><span class="pun">,</span>
          <span class="str">&#34;/time&#34;</span><span class="pun">,</span>
      <span class="pun">}</span>
  
      <span class="kwd">var</span> <span class="pln">queries</span> <span class="pun">=</span> <span class="pun">[</span><span class="pun">]</span><span class="kwd">map</span><span class="pun">[</span><span class="pln">string</span><span class="pun">]</span><span class="pln">string</span><span class="pun">{</span>
          <span class="kwd">nil</span><span class="pun">,</span>
          <span class="kwd">nil</span><span class="pun">,</span>
          <span class="pun">{</span><span class="str">&#34;case&#34;</span><span class="pun">:</span> <span class="str">&#34;upper&#34;</span><span class="pun">}</span><span class="pun">,</span>
          <span class="pun">{</span><span class="str">&#34;case&#34;</span><span class="pun">:</span> <span class="str">&#34;lower&#34;</span><span class="pun">}</span><span class="pun">,</span>
          <span class="kwd">nil</span><span class="pun">,</span>
          <span class="pun">{</span><span class="str">&#34;format&#34;</span><span class="pun">:</span> <span class="pln">time</span><span class="pun">.</span><span class="typ">RFC1123</span><span class="pun">}</span><span class="pun">,</span>
          <span class="pun">{</span><span class="str">&#34;format&#34;</span><span class="pun">:</span> <span class="pln">time</span><span class="pun">.</span><span class="typ">RFC1123</span><span class="pun">,</span> <span class="str">&#34;tz&#34;</span><span class="pun">:</span> <span class="str">&#34;America/New_York&#34;</span><span class="pun">}</span><span class="pun">,</span>
          <span class="pun">{</span><span class="str">&#34;format&#34;</span><span class="pun">:</span> <span class="pln">time</span><span class="pun">.</span><span class="typ">RFC1123</span><span class="pun">,</span> <span class="str">&#34;tz&#34;</span><span class="pun">:</span> <span class="str">&#34;America/Los_Angeles&#34;</span><span class="pun">}</span><span class="pun">,</span>
          <span class="pun">{</span><span class="str">&#34;format&#34;</span><span class="pun">:</span> <span class="pln">time</span><span class="pun">.</span><span class="typ">RFC1123</span><span class="pun">,</span> <span class="str">&#34;tz&#34;</span><span class="pun">:</span> <span class="str">&#34;America/Chicago&#34;</span><span class="pun">}</span><span class="pun">,</span>
      <span class="pun">}</span>
      <span class="kwd">for</span> <span class="pln">i</span> <span class="pun">:</span><span class="pun">=</span> <span class="pln">range</span> <span class="pln">paths</span> <span class="pun">{</span>
          <span class="pln">q</span> <span class="pun">:</span><span class="pun">=</span> <span class="kwd">make</span><span class="pun">(</span><span class="pln">url</span><span class="pun">.</span><span class="typ">Values</span><span class="pun">)</span>
          <span class="kwd">for</span> <span class="pln">k</span><span class="pun">,</span> <span class="pln">v</span> <span class="pun">:</span><span class="pun">=</span> <span class="pln">range</span> <span class="pln">queries</span><span class="pun">[</span><span class="pln">i</span><span class="pun">]</span> <span class="pun">{</span>
              <span class="pln">q</span><span class="pun">.</span><span class="typ">Set</span><span class="pun">(</span><span class="pln">k</span><span class="pun">,</span> <span class="pln">v</span><span class="pun">)</span>
          <span class="pun">}</span>
          <span class="pln">url</span> <span class="pun">:</span><span class="pun">=</span> <span class="pln">fmt</span><span class="pun">.</span><span class="typ">Sprintf</span><span class="pun">(</span><span class="str">&#34;http://localhost:%d%s&#34;</span><span class="pun">,</span> <span class="pln">port</span><span class="pun">,</span> <span class="pln">paths</span><span class="pun">[</span><span class="pln">i</span><span class="pun">]</span><span class="pun">)</span>
          <span class="kwd">if</span> <span class="pln">len</span><span class="pun">(</span><span class="pln">q</span><span class="pun">)</span> <span class="pun">&gt;</span> <span class="dec">0</span> <span class="pun">{</span>
              <span class="pln">url</span> <span class="pun">+</span><span class="pun">=</span> <span class="str">&#34;?&#34;</span> <span class="pun">+</span> <span class="pln">q</span><span class="pun">.</span><span class="typ">Encode</span><span class="pun">(</span><span class="pun">)</span>
          <span class="pun">}</span>
          <span class="pln">ctx</span><span class="pun">,</span> <span class="pln">cancel</span> <span class="pun">:</span><span class="pun">=</span> <span class="pln">context</span><span class="pun">.</span><span class="typ">WithTimeout</span><span class="pun">(</span><span class="pln">context</span><span class="pun">.</span><span class="typ">Background</span><span class="pun">(</span><span class="pun">)</span><span class="pun">,</span> <span class="dec">1</span><span class="pun">*</span><span class="pln">time</span><span class="pun">.</span><span class="typ">Second</span><span class="pun">)</span>
          <span class="pln">req</span><span class="pun">,</span> <span class="pln">err</span> <span class="pun">:</span><span class="pun">=</span> <span class="pln">http</span><span class="pun">.</span><span class="typ">NewRequestWithContext</span><span class="pun">(</span><span class="pln">ctx</span><span class="pun">,</span> <span class="str">&#34;GET&#34;</span><span class="pun">,</span> <span class="pln">url</span><span class="pun">,</span> <span class="kwd">nil</span><span class="pun">)</span>
          <span class="kwd">if</span> <span class="pln">err</span> <span class="pun">!</span><span class="pun">=</span> <span class="kwd">nil</span> <span class="pun">{</span>
              <span class="pln">log</span><span class="pun">.</span><span class="typ">Fatal</span><span class="pun">(</span><span class="pln">err</span><span class="pun">)</span>
          <span class="pun">}</span>
          <span class="pln">resp</span><span class="pun">,</span> <span class="pln">err</span> <span class="pun">:</span><span class="pun">=</span> <span class="pln">client</span><span class="pun">.</span><span class="typ">Do</span><span class="pun">(</span><span class="pln">req</span><span class="pun">)</span>
          <span class="pln">cancel</span><span class="pun">(</span><span class="pun">)</span>
          <span class="kwd">if</span> <span class="pln">err</span> <span class="pun">!</span><span class="pun">=</span> <span class="kwd">nil</span> <span class="pun">{</span>
              <span class="pln">log</span><span class="pun">.</span><span class="typ">Fatal</span><span class="pun">(</span><span class="pln">err</span><span class="pun">)</span>
          <span class="pun">}</span>
          <span class="pln">fmt</span><span class="pun">.</span><span class="typ">Printf</span><span class="pun">(</span><span class="str">&#34;GET %s: \n&#34;</span><span class="pun">,</span> <span class="pln">url</span><span class="pun">)</span>
          <span class="pln">resp</span><span class="pun">.</span><span class="typ">Write</span><span class="pun">(</span><span class="pln">os</span><span class="pun">.</span><span class="typ">Stdout</span><span class="pun">)</span>
          <span class="pln">fmt</span><span class="pun">.</span><span class="typ">Println</span><span class="pun">(</span><span class="str">&#34;\n-------&#34;</span><span class="pun">)</span>
      <span class="pun">}</span>
  
  <span class="pun">}</span>
  </code></pre>
  
  <p>If you run both programs, you should see something like this (lightly edited and heavily compressed for space):</p>
  
  <pre><code>server: GET /echo/first/second/third: [d4df5e13-fadf-4f4a-8eb9-7ca1dca0428b c16dc184-90ae-4a23-85cd-4898456ac25e]: 2023/09/18 10:59:04 200 OK: 39 bytes in 28.093µs
  client: GET http://localhost:8080/echo/first/second/third: 2023/09/18 10:59:04 clientmw.go:112: 200 OK in 348.138µs
  GET http://localhost:8080/echo/first/second/third: 
  HTTP/1.1 200 OK
  Content-Length: 39
  Content-Type: application/json
  Date: Mon, 18 Sep 2023 17:59:04 GMT
  
  {&#34;a&#34;:&#34;first&#34;,&#34;b&#34;:&#34;second&#34;,&#34;c&#34;:&#34;third&#34;}
  
  server: GET /echo/first/second/third?case=upper: [2253f79f-e49d-455e-b32a-3d842c7f1ea5 bb748b7a-2a07-4d86-8992-0ba3f2e7423c]: 2023/09/18 10:59:04 200 OK: 39 bytes in 21.069µs
  client: GET http://localhost:8080/echo/first/second/third?case=upper: 2023/09/18 10:59:04 clientmw.go:112: 200 OK in 342.51µs
  GET http://localhost:8080/echo/first/second/third?case=upper: 
  HTTP/1.1 200 OK
  Content-Length: 39
  Content-Type: application/json
  Date: Mon, 18 Sep 2023 17:59:04 GMT
  
  {&#34;a&#34;:&#34;FIRST&#34;,&#34;b&#34;:&#34;SECOND&#34;,&#34;c&#34;:&#34;THIRD&#34;}
  
  server: GET /time?format=Mon%2C+02+Jan+2006+15%3A04%3A05+MST&amp;tz=America%2FLos_Angeles: [de41ddc1-fd01-4aa7-b666-a9a5d81a1c08 e7605ac9-aa5d-43b1-9fcc-5a90af39d737]: 2023/09/18 10:59:04 200 OK: 41 bytes in 21.901µs
  client: GET http://localhost:8080/time?format=Mon%2C+02+Jan+2006+15%3A04%3A05+MST&amp;tz=America%2FLos_Angeles: 2023/09/18 10:59:04 clientmw.go:112: 200 OK in 244.977µs
  GET http://localhost:8080/time?format=Mon%2C+02+Jan+2006+15%3A04%3A05+MST&amp;tz=America%2FLos_Angeles: 
  HTTP/1.1 200 OK
  Content-Length: 41
  Content-Type: application/json
  Date: Mon, 18 Sep 2023 17:59:04 GMT
  
  {&#34;time&#34;:&#34;Mon, 18 Sep 2023 10:59:04 PDT&#34;}
  </code></pre>
  
  <p>We’d like to have a better guarantee that our server is working correctly than just “it seems to work when I run it”, though.</p>
  
  <p>The <a href="https://pkg.go.dev/net/http/httptest#Server"><code>httptest.Server</code></a> listens on a random port and serves http using a provided handler.</p>
  
  <p>The following heavily annotated test suite demonstrates how to use <code>http.Server</code> and table-driven tests to test our server.</p>
  
  <pre><code class="language-go"><span class="kwd">package</span> <span class="pln">main</span>
  
  <span class="kwd">import</span> <span class="pun">(</span>
      <span class="str">&#34;bytes&#34;</span>
      <span class="str">&#34;context&#34;</span>
      <span class="str">&#34;encoding/json&#34;</span>
      <span class="str">&#34;fmt&#34;</span>
      <span class="str">&#34;io&#34;</span>
      <span class="str">&#34;log&#34;</span>
      <span class="str">&#34;net/http&#34;</span>
      <span class="str">&#34;net/http/httptest&#34;</span>
      <span class="str">&#34;net/url&#34;</span>
      <span class="str">&#34;os&#34;</span>
      <span class="str">&#34;reflect&#34;</span>
      <span class="str">&#34;strings&#34;</span>
      <span class="str">&#34;testing&#34;</span>
  
      <span class="str">&#34;gitlab.com/efronlicht/blog/articles/backendbasics/cmd/clientmw&#34;</span>
      <span class="str">&#34;gitlab.com/efronlicht/blog/articles/backendbasics/cmd/ctxutil&#34;</span>
  <span class="pun">)</span>
  
  <span class="com">// initialized during TestMain.</span>
  <span class="kwd">var</span> <span class="pln">client</span> <span class="pun">*</span><span class="pln">http</span><span class="pun">.</span><span class="typ">Client</span>
  <span class="kwd">var</span> <span class="pln">server</span> <span class="pun">*</span><span class="pln">httptest</span><span class="pun">.</span><span class="typ">Server</span>
  
  <span class="com">// The TestMain function is a special function that runs before any tests are run; think of it as init()</span>
  <span class="com">// that only runs when you run tests.</span>
  <span class="kwd">func</span> <span class="typ">TestMain</span><span class="pun">(</span><span class="pln">m</span> <span class="pun">*</span><span class="pln">testing</span><span class="pun">.</span><span class="typ">M</span><span class="pun">)</span> <span class="pun">{</span>
      <span class="pln">router</span><span class="pun">,</span> <span class="pln">err</span> <span class="pun">:</span><span class="pun">=</span> <span class="pln">buildBaseRouter</span><span class="pun">(</span><span class="pun">)</span>
      <span class="kwd">if</span> <span class="pln">err</span> <span class="pun">!</span><span class="pun">=</span> <span class="kwd">nil</span> <span class="pun">{</span>
          <span class="pln">log</span><span class="pun">.</span><span class="typ">Fatal</span><span class="pun">(</span><span class="pln">err</span><span class="pun">)</span>
      <span class="pun">}</span>
      <span class="pln">router</span> <span class="pun">=</span> <span class="pln">applyMiddleware</span><span class="pun">(</span><span class="pln">router</span><span class="pun">)</span> <span class="com">// apply middleware</span>
      <span class="com">// httptest.NewServer starts an http server that listens on a random port.</span>
      <span class="com">// you can use the URL field of the returned httptest.Server to make requests to the server.</span>
      <span class="pln">server</span> <span class="pun">=</span> <span class="pln">httptest</span><span class="pun">.</span><span class="typ">NewServer</span><span class="pun">(</span><span class="pln">router</span><span class="pun">)</span> <span class="com">// create a test server with the router</span>
  
      <span class="com">// httptest.Server.Client() returns an http.Client that uses the test server and always accepts it&#39;s auth certificate.</span>
      <span class="pln">client</span> <span class="pun">=</span> <span class="pln">server</span><span class="pun">.</span><span class="typ">Client</span><span class="pun">(</span><span class="pun">)</span>
  
      <span class="kwd">if</span> <span class="pln">client</span><span class="pun">.</span><span class="typ">Transport</span> <span class="pun">=</span><span class="pun">=</span> <span class="kwd">nil</span> <span class="pun">{</span>
          <span class="pln">client</span><span class="pun">.</span><span class="typ">Transport</span> <span class="pun">=</span> <span class="pln">http</span><span class="pun">.</span><span class="typ">DefaultTransport</span> <span class="com">// use the default transport if the client doesn&#39;t have one.</span>
      <span class="pun">}</span>
      <span class="com">// apply our client middleware to the client.</span>
      <span class="pln">client</span><span class="pun">.</span><span class="typ">Transport</span> <span class="pun">=</span> <span class="pln">clientmw</span><span class="pun">.</span><span class="typ">Log</span><span class="pun">(</span><span class="pln">clientmw</span><span class="pun">.</span><span class="typ">Trace</span><span class="pun">(</span><span class="pln">client</span><span class="pun">.</span><span class="typ">Transport</span><span class="pun">)</span><span class="pun">)</span> <span class="com">// add logging and tracing to the client</span>
  
      <span class="pln">code</span> <span class="pun">:</span><span class="pun">=</span> <span class="pln">m</span><span class="pun">.</span><span class="typ">Run</span><span class="pun">(</span><span class="pun">)</span> <span class="com">// run the tests</span>
  
      <span class="pln">server</span><span class="pun">.</span><span class="typ">Close</span><span class="pun">(</span><span class="pun">)</span> <span class="com">// close the test server</span>
  
      <span class="pln">os</span><span class="pun">.</span><span class="typ">Exit</span><span class="pun">(</span><span class="pln">code</span><span class="pun">)</span> <span class="com">// exit with the same code as the tests; 0 if all tests passed, non-zero otherwise.</span>
  <span class="pun">}</span>
  
  <span class="com">// TestNotFound tests that the router returns a 404 status code for requests that don&#39;t match any routes.</span>
  <span class="kwd">func</span> <span class="typ">TestNotFound</span><span class="pun">(</span><span class="pln">t</span> <span class="pun">*</span><span class="pln">testing</span><span class="pun">.</span><span class="typ">T</span><span class="pun">)</span> <span class="pun">{</span>
      <span class="kwd">for</span> <span class="pln">_</span><span class="pun">,</span> <span class="pln">tt</span> <span class="pun">:</span><span class="pun">=</span> <span class="pln">range</span> <span class="pun">[</span><span class="pun">]</span><span class="kwd">struct</span> <span class="pun">{</span>
          <span class="pln">method</span><span class="pun">,</span> <span class="pln">path</span> <span class="pln">string</span>
      <span class="pun">}</span><span class="pun">{</span>
          <span class="pun">{</span><span class="str">&#34;DELETE&#34;</span><span class="pun">,</span> <span class="str">&#34;/&#34;</span><span class="pun">}</span><span class="pun">,</span>
          <span class="pun">{</span><span class="str">&#34;GET&#34;</span><span class="pun">,</span> <span class="str">&#34;/notfound&#34;</span><span class="pun">}</span><span class="pun">,</span>
          <span class="pun">{</span><span class="str">&#34;GET&#34;</span><span class="pun">,</span> <span class="str">&#34;/chess/replay/efronlicht/bobross/1234&#34;</span><span class="pun">}</span><span class="pun">,</span>
      <span class="pun">}</span> <span class="pun">{</span>
          <span class="pln">req</span><span class="pun">,</span> <span class="pln">_</span> <span class="pun">:</span><span class="pun">=</span> <span class="pln">http</span><span class="pun">.</span><span class="typ">NewRequest</span><span class="pun">(</span><span class="pln">tt</span><span class="pun">.</span><span class="pln">method</span><span class="pun">,</span> <span class="pln">server</span><span class="pun">.</span><span class="typ">URL</span><span class="pun">+</span><span class="pln">tt</span><span class="pun">.</span><span class="pln">path</span><span class="pun">,</span> <span class="kwd">nil</span><span class="pun">)</span>
  
          <span class="kwd">if</span> <span class="pln">resp</span><span class="pun">,</span> <span class="pln">err</span> <span class="pun">:</span><span class="pun">=</span> <span class="pln">client</span><span class="pun">.</span><span class="typ">Do</span><span class="pun">(</span><span class="pln">req</span><span class="pun">)</span><span class="pun">;</span> <span class="pln">err</span> <span class="pun">!</span><span class="pun">=</span> <span class="kwd">nil</span> <span class="pun">{</span>
              <span class="pln">t</span><span class="pun">.</span><span class="typ">Errorf</span><span class="pun">(</span><span class="str">&#34;client.Do(%q, %q) returned error: %v&#34;</span><span class="pun">,</span> <span class="pln">tt</span><span class="pun">.</span><span class="pln">method</span><span class="pun">,</span> <span class="pln">tt</span><span class="pun">.</span><span class="pln">path</span><span class="pun">,</span> <span class="pln">err</span><span class="pun">)</span>
          <span class="pun">}</span> <span class="kwd">else</span> <span class="kwd">if</span> <span class="pln">resp</span><span class="pun">.</span><span class="typ">StatusCode</span> <span class="pun">!</span><span class="pun">=</span> <span class="pln">http</span><span class="pun">.</span><span class="typ">StatusNotFound</span> <span class="pun">{</span>
              <span class="pln">t</span><span class="pun">.</span><span class="typ">Errorf</span><span class="pun">(</span><span class="str">&#34;client.Do(%q, %q) returned status %d, want %d&#34;</span><span class="pun">,</span> <span class="pln">tt</span><span class="pun">.</span><span class="pln">method</span><span class="pun">,</span> <span class="pln">tt</span><span class="pun">.</span><span class="pln">path</span><span class="pun">,</span> <span class="pln">resp</span><span class="pun">.</span><span class="typ">StatusCode</span><span class="pun">,</span> <span class="pln">http</span><span class="pun">.</span><span class="typ">StatusNotFound</span><span class="pun">)</span>
          <span class="pun">}</span>
  
      <span class="pun">}</span>
  <span class="pun">}</span>
  
  <span class="com">// TestGraduation tests that the server works as expected.</span>
  <span class="com">// This is meant to demonstrate how to write tests for a server in a way that doesn&#39;t have too many dependencies</span>
  <span class="com">// or use any external libraries.</span>
  <span class="kwd">func</span> <span class="typ">TestGraduation</span><span class="pun">(</span><span class="pln">t</span> <span class="pun">*</span><span class="pln">testing</span><span class="pun">.</span><span class="typ">T</span><span class="pun">)</span> <span class="pun">{</span>
  
      <span class="pln">defer</span> <span class="pln">server</span><span class="pun">.</span><span class="typ">Close</span><span class="pun">(</span><span class="pun">)</span>
  
      <span class="com">// table-based testing is a common pattern in Go.</span>
      <span class="kwd">for</span> <span class="pln">_</span><span class="pun">,</span> <span class="pln">tt</span> <span class="pun">:</span><span class="pun">=</span> <span class="pln">range</span> <span class="pun">[</span><span class="pun">]</span><span class="kwd">struct</span> <span class="pun">{</span>
          <span class="pln">method</span><span class="pun">,</span> <span class="pln">path</span> <span class="pln">string</span>            <span class="com">// where is the request going?</span>
          <span class="pln">body</span>         <span class="kwd">map</span><span class="pun">[</span><span class="pln">string</span><span class="pun">]</span><span class="pln">any</span>    <span class="com">// what is the request body, if any? nil if no body.</span>
          <span class="pln">queries</span>      <span class="kwd">map</span><span class="pun">[</span><span class="pln">string</span><span class="pun">]</span><span class="pln">string</span> <span class="com">// what are the query parameters, if any? nil if no query parameters.</span>
          <span class="pln">wantStatus</span>   <span class="kwd">int</span>               <span class="com">// what status code do we expect?</span>
          <span class="com">// what substrings do we expect to find in the response body?</span>
          <span class="com">/* ----- design note: ----
          we&#39;re not testing the entire response body, because it&#39;s too brittle; small changes in the response body
          like whitespace or punctuation will cause the test to fail.
          instead, we test for substrings that we expect to find in the response body.
          this is a good compromise between testing the entire response body and testing nothing.
          if you have structured content, like JSON, you can unmarshal the response body into a struct and test that.
          */</span>
          <span class="pln">wantBodyContains</span> <span class="pun">[</span><span class="pun">]</span><span class="pln">string</span>
      <span class="pun">}</span><span class="pun">{</span>
          <span class="pun">{</span> <span class="com">// GET / returns &#34;Hello, world!&#34;</span>
              <span class="pln">method</span><span class="pun">:</span>           <span class="str">&#34;GET&#34;</span><span class="pun">,</span>
              <span class="pln">path</span><span class="pun">:</span>             <span class="str">&#34;/&#34;</span><span class="pun">,</span>
              <span class="pln">wantStatus</span><span class="pun">:</span>       <span class="pln">http</span><span class="pun">.</span><span class="typ">StatusOK</span><span class="pun">,</span>
              <span class="pln">wantBodyContains</span><span class="pun">:</span> <span class="pun">[</span><span class="pun">]</span><span class="pln">string</span><span class="pun">{</span><span class="str">&#34;Hello, world!&#34;</span><span class="pun">}</span><span class="pun">,</span>
          <span class="pun">}</span><span class="pun">,</span>
          <span class="pun">{</span> <span class="com">// GET /panic always panics.</span>
              <span class="pln">method</span><span class="pun">:</span>           <span class="str">&#34;GET&#34;</span><span class="pun">,</span>
              <span class="pln">path</span><span class="pun">:</span>             <span class="str">&#34;/panic&#34;</span><span class="pun">,</span>
              <span class="pln">wantStatus</span><span class="pun">:</span>       <span class="pln">http</span><span class="pun">.</span><span class="typ">StatusInternalServerError</span><span class="pun">,</span>
              <span class="pln">wantBodyContains</span><span class="pun">:</span> <span class="pun">[</span><span class="pun">]</span><span class="pln">string</span><span class="pun">{</span><span class="str">&#34;Internal Server Error&#34;</span><span class="pun">}</span><span class="pun">,</span>
          <span class="pun">}</span><span class="pun">,</span>
          <span class="com">// POST /greet/json returns a JSON object with a greeting and a category based on the age,</span>
          <span class="com">// and it&#39;s forbidden to children under 13.</span>
          <span class="pun">{</span>
              <span class="pln">method</span><span class="pun">:</span>           <span class="str">&#34;POST&#34;</span><span class="pun">,</span>
              <span class="pln">path</span><span class="pun">:</span>             <span class="str">&#34;/greet/json&#34;</span><span class="pun">,</span>
              <span class="pln">body</span><span class="pun">:</span>             <span class="kwd">map</span><span class="pun">[</span><span class="pln">string</span><span class="pun">]</span><span class="pln">any</span><span class="pun">{</span><span class="str">&#34;first&#34;</span><span class="pun">:</span> <span class="str">&#34;Raphael&#34;</span><span class="pun">,</span> <span class="str">&#34;last&#34;</span><span class="pun">:</span> <span class="str">&#34;Frasca&#34;</span><span class="pun">,</span> <span class="str">&#34;age&#34;</span><span class="pun">:</span> <span class="dec">10</span><span class="pun">}</span><span class="pun">,</span> <span class="com">// my nephew turned 10 today! ;P</span>
              <span class="pln">wantStatus</span><span class="pun">:</span>       <span class="pln">http</span><span class="pun">.</span><span class="typ">StatusForbidden</span><span class="pun">,</span>
              <span class="pln">wantBodyContains</span><span class="pun">:</span> <span class="pun">[</span><span class="pun">]</span><span class="pln">string</span><span class="pun">{</span><span class="str">&#34;forbidden&#34;</span><span class="pun">}</span><span class="pun">,</span>
          <span class="pun">}</span><span class="pun">,</span>
          <span class="com">// adults should get a greeting based on their age: i&#39;m an adult.</span>
          <span class="pun">{</span>
              <span class="pln">method</span><span class="pun">:</span>           <span class="str">&#34;POST&#34;</span><span class="pun">,</span>
              <span class="pln">path</span><span class="pun">:</span>             <span class="str">&#34;/greet/json&#34;</span><span class="pun">,</span>
              <span class="pln">body</span><span class="pun">:</span>             <span class="kwd">map</span><span class="pun">[</span><span class="pln">string</span><span class="pun">]</span><span class="pln">any</span><span class="pun">{</span><span class="str">&#34;first&#34;</span><span class="pun">:</span> <span class="str">&#34;Efron&#34;</span><span class="pun">,</span> <span class="str">&#34;last&#34;</span><span class="pun">:</span> <span class="str">&#34;Licht&#34;</span><span class="pun">,</span> <span class="str">&#34;age&#34;</span><span class="pun">:</span> <span class="dec">32</span><span class="pun">}</span><span class="pun">,</span>
              <span class="pln">wantStatus</span><span class="pun">:</span>       <span class="pln">http</span><span class="pun">.</span><span class="typ">StatusOK</span><span class="pun">,</span>
              <span class="pln">wantBodyContains</span><span class="pun">:</span> <span class="pun">[</span><span class="pun">]</span><span class="pln">string</span><span class="pun">{</span><span class="str">&#34;Efron&#34;</span><span class="pun">,</span> <span class="str">&#34;Licht&#34;</span><span class="pun">,</span> <span class="str">&#34;adult&#34;</span><span class="pun">}</span><span class="pun">,</span>
          <span class="pun">}</span><span class="pun">,</span>
          <span class="com">// GET /time returns the current time in UTC, or in the timezone specified by the tz query parameter.</span>
          <span class="pun">{</span>
              <span class="pln">method</span><span class="pun">:</span>     <span class="str">&#34;GET&#34;</span><span class="pun">,</span>
              <span class="pln">path</span><span class="pun">:</span>       <span class="str">&#34;/time&#34;</span><span class="pun">,</span>
              <span class="pln">queries</span><span class="pun">:</span>    <span class="kwd">map</span><span class="pun">[</span><span class="pln">string</span><span class="pun">]</span><span class="pln">string</span><span class="pun">{</span><span class="str">&#34;tz&#34;</span><span class="pun">:</span> <span class="str">&#34;America/New_York&#34;</span><span class="pun">}</span><span class="pun">,</span>
              <span class="pln">wantStatus</span><span class="pun">:</span> <span class="pln">http</span><span class="pun">.</span><span class="typ">StatusOK</span><span class="pun">,</span>
              <span class="com">/* wantBodyContains: []string{&#34;-4&#34;}
              this test is bad, because it assumes that the test is running in a timezone that is 4 hours behind UTC;
              America/New_York is only 4 hours behind UTC during daylight savings time; otherwise it&#39;s 5 hours behind.
              be careful when writing tests that depend on timezones! */</span>
          <span class="pun">}</span><span class="pun">,</span>
          <span class="com">// GET /time returns a 400 status code if the tz query parameter is invalid.</span>
          <span class="pun">{</span>
              <span class="pln">method</span><span class="pun">:</span>     <span class="str">&#34;GET&#34;</span><span class="pun">,</span>
              <span class="pln">path</span><span class="pun">:</span>       <span class="str">&#34;/time&#34;</span><span class="pun">,</span>
              <span class="pln">queries</span><span class="pun">:</span>    <span class="kwd">map</span><span class="pun">[</span><span class="pln">string</span><span class="pun">]</span><span class="pln">string</span><span class="pun">{</span><span class="str">&#34;tz&#34;</span><span class="pun">:</span> <span class="str">&#34;invalid&#34;</span><span class="pun">}</span><span class="pun">,</span>
              <span class="pln">wantStatus</span><span class="pun">:</span> <span class="pln">http</span><span class="pun">.</span><span class="typ">StatusBadRequest</span><span class="pun">,</span>
          <span class="pun">}</span><span class="pun">,</span>
      <span class="pun">}</span> <span class="pun">{</span>
          <span class="pln">tt</span> <span class="pun">:</span><span class="pun">=</span> <span class="pln">tt</span> <span class="com">// capture the range variable</span>
          <span class="kwd">if</span> <span class="pln">len</span><span class="pun">(</span><span class="pln">tt</span><span class="pun">.</span><span class="pln">queries</span><span class="pun">)</span> <span class="pun">!</span><span class="pun">=</span> <span class="dec">0</span> <span class="pun">{</span>
              <span class="pln">query</span> <span class="pun">:</span><span class="pun">=</span> <span class="kwd">make</span><span class="pun">(</span><span class="pln">url</span><span class="pun">.</span><span class="typ">Values</span><span class="pun">,</span> <span class="pln">len</span><span class="pun">(</span><span class="pln">tt</span><span class="pun">.</span><span class="pln">queries</span><span class="pun">)</span><span class="pun">)</span>
              <span class="kwd">for</span> <span class="pln">k</span><span class="pun">,</span> <span class="pln">v</span> <span class="pun">:</span><span class="pun">=</span> <span class="pln">range</span> <span class="pln">tt</span><span class="pun">.</span><span class="pln">queries</span> <span class="pun">{</span>
                  <span class="pln">query</span><span class="pun">.</span><span class="typ">Set</span><span class="pun">(</span><span class="pln">k</span><span class="pun">,</span> <span class="pln">v</span><span class="pun">)</span>
              <span class="pun">}</span>
              <span class="pln">tt</span><span class="pun">.</span><span class="pln">path</span> <span class="pun">+</span><span class="pun">=</span> <span class="str">&#34;?&#34;</span> <span class="pun">+</span> <span class="pln">query</span><span class="pun">.</span><span class="typ">Encode</span><span class="pun">(</span><span class="pun">)</span>
          <span class="pun">}</span>
          <span class="com">// give the test a name that describes the request so we can easily see what passed and failed in the output:</span>
          <span class="com">// i.e, TestGraduation/GET/ -&gt; 200-OK</span>
          <span class="com">// TestGraduation/POST/greet/json-&gt;403-Forbidden</span>
          <span class="pln">name</span> <span class="pun">:</span><span class="pun">=</span> <span class="pln">fmt</span><span class="pun">.</span><span class="typ">Sprintf</span><span class="pun">(</span><span class="str">&#34;%s%s-&gt;%d-%s&#34;</span><span class="pun">,</span> <span class="pln">tt</span><span class="pun">.</span><span class="pln">method</span><span class="pun">,</span> <span class="pln">tt</span><span class="pun">.</span><span class="pln">path</span><span class="pun">,</span> <span class="pln">tt</span><span class="pun">.</span><span class="pln">wantStatus</span><span class="pun">,</span> <span class="pln">strings</span><span class="pun">.</span><span class="typ">ReplaceAll</span><span class="pun">(</span>
              <span class="pln">http</span><span class="pun">.</span><span class="typ">StatusText</span><span class="pun">(</span><span class="pln">tt</span><span class="pun">.</span><span class="pln">wantStatus</span><span class="pun">)</span><span class="pun">,</span> <span class="str">&#34; &#34;</span><span class="pun">,</span> <span class="str">&#34;-&#34;</span><span class="pun">)</span><span class="pun">)</span>
          <span class="pln">t</span><span class="pun">.</span><span class="typ">Run</span><span class="pun">(</span><span class="pln">name</span><span class="pun">,</span> <span class="kwd">func</span><span class="pun">(</span><span class="pln">t</span> <span class="pun">*</span><span class="pln">testing</span><span class="pun">.</span><span class="typ">T</span><span class="pun">)</span> <span class="pun">{</span>
              <span class="pln">path</span> <span class="pun">:</span><span class="pun">=</span> <span class="pln">server</span><span class="pun">.</span><span class="typ">URL</span> <span class="pun">+</span> <span class="pln">tt</span><span class="pun">.</span><span class="pln">path</span>
  
              <span class="kwd">var</span> <span class="pln">body</span> <span class="pln">io</span><span class="pun">.</span><span class="typ">Reader</span>
              <span class="kwd">if</span> <span class="pln">tt</span><span class="pun">.</span><span class="pln">body</span> <span class="pun">!</span><span class="pun">=</span> <span class="kwd">nil</span> <span class="pun">{</span>
                  <span class="pln">b</span><span class="pun">,</span> <span class="pln">_</span> <span class="pun">:</span><span class="pun">=</span> <span class="pln">json</span><span class="pun">.</span><span class="typ">Marshal</span><span class="pun">(</span><span class="pln">tt</span><span class="pun">.</span><span class="pln">body</span><span class="pun">)</span>
                  <span class="pln">body</span> <span class="pun">=</span> <span class="pln">bytes</span><span class="pun">.</span><span class="typ">NewReader</span><span class="pun">(</span><span class="pln">b</span><span class="pun">)</span>
              <span class="pun">}</span>
  
              <span class="pln">req</span><span class="pun">,</span> <span class="pln">err</span> <span class="pun">:</span><span class="pun">=</span> <span class="pln">http</span><span class="pun">.</span><span class="typ">NewRequestWithContext</span><span class="pun">(</span><span class="pln">context</span><span class="pun">.</span><span class="typ">TODO</span><span class="pun">(</span><span class="pun">)</span><span class="pun">,</span> <span class="pln">tt</span><span class="pun">.</span><span class="pln">method</span><span class="pun">,</span> <span class="pln">path</span><span class="pun">,</span> <span class="pln">body</span><span class="pun">)</span>
              <span class="kwd">if</span> <span class="pln">err</span> <span class="pun">!</span><span class="pun">=</span> <span class="kwd">nil</span> <span class="pun">{</span>
                  <span class="pln">t</span><span class="pun">.</span><span class="typ">Errorf</span><span class="pun">(</span><span class="str">&#34;http.NewRequestWithContext(%q, %q, %v) returned error: %v&#34;</span><span class="pun">,</span> <span class="pln">tt</span><span class="pun">.</span><span class="pln">method</span><span class="pun">,</span> <span class="pln">tt</span><span class="pun">.</span><span class="pln">path</span><span class="pun">,</span> <span class="pln">tt</span><span class="pun">.</span><span class="pln">body</span><span class="pun">,</span> <span class="pln">err</span><span class="pun">)</span>
              <span class="pun">}</span>
  
              <span class="pln">resp</span><span class="pun">,</span> <span class="pln">err</span> <span class="pun">:</span><span class="pun">=</span> <span class="pln">client</span><span class="pun">.</span><span class="typ">Do</span><span class="pun">(</span><span class="pln">req</span><span class="pun">)</span>
              <span class="kwd">if</span> <span class="pln">err</span> <span class="pun">!</span><span class="pun">=</span> <span class="kwd">nil</span> <span class="pun">{</span>
                  <span class="pln">t</span><span class="pun">.</span><span class="typ">Errorf</span><span class="pun">(</span><span class="str">&#34;client.Do(%q, %q) returned error: %v&#34;</span><span class="pun">,</span> <span class="pln">tt</span><span class="pun">.</span><span class="pln">method</span><span class="pun">,</span> <span class="pln">tt</span><span class="pun">.</span><span class="pln">path</span><span class="pun">,</span> <span class="pln">err</span><span class="pun">)</span>
              <span class="pun">}</span>
  
              <span class="kwd">if</span> <span class="pln">resp</span><span class="pun">.</span><span class="typ">StatusCode</span> <span class="pun">!</span><span class="pun">=</span> <span class="pln">tt</span><span class="pun">.</span><span class="pln">wantStatus</span> <span class="pun">{</span>
                  <span class="pln">t</span><span class="pun">.</span><span class="typ">Errorf</span><span class="pun">(</span><span class="str">&#34;router.ServeHTTP(%q, %q) returned status %d, want %d&#34;</span><span class="pun">,</span> <span class="pln">tt</span><span class="pun">.</span><span class="pln">method</span><span class="pun">,</span> <span class="pln">tt</span><span class="pun">.</span><span class="pln">path</span><span class="pun">,</span> <span class="pln">resp</span><span class="pun">.</span><span class="typ">StatusCode</span><span class="pun">,</span> <span class="pln">tt</span><span class="pun">.</span><span class="pln">wantStatus</span><span class="pun">)</span>
              <span class="pun">}</span>
              <span class="pln">bodyBytes</span><span class="pun">,</span> <span class="pln">_</span> <span class="pun">:</span><span class="pun">=</span> <span class="pln">io</span><span class="pun">.</span><span class="typ">ReadAll</span><span class="pun">(</span><span class="pln">resp</span><span class="pun">.</span><span class="typ">Body</span><span class="pun">)</span>
  
              <span class="pln">resp</span><span class="pun">.</span><span class="typ">Body</span><span class="pun">.</span><span class="typ">Close</span><span class="pun">(</span><span class="pun">)</span>
  
              <span class="kwd">for</span> <span class="pln">_</span><span class="pun">,</span> <span class="pln">want</span> <span class="pun">:</span><span class="pun">=</span> <span class="pln">range</span> <span class="pln">tt</span><span class="pun">.</span><span class="pln">wantBodyContains</span> <span class="pun">{</span>
                  <span class="kwd">if</span> <span class="pun">!</span><span class="pln">strings</span><span class="pun">.</span><span class="typ">Contains</span><span class="pun">(</span><span class="pln">string</span><span class="pun">(</span><span class="pln">bodyBytes</span><span class="pun">)</span><span class="pun">,</span> <span class="pln">want</span><span class="pun">)</span> <span class="pun">{</span>
                      <span class="pln">t</span><span class="pun">.</span><span class="typ">Errorf</span><span class="pun">(</span><span class="str">&#34;router.ServeHTTP(%q, %q) returned body %s, want body to contain %s&#34;</span><span class="pun">,</span> <span class="pln">tt</span><span class="pun">.</span><span class="pln">method</span><span class="pun">,</span> <span class="pln">tt</span><span class="pun">.</span><span class="pln">path</span><span class="pun">,</span> <span class="pln">bodyBytes</span><span class="pun">,</span> <span class="pln">want</span><span class="pun">)</span>
                  <span class="pun">}</span>
              <span class="pun">}</span>
  
          <span class="pun">}</span><span class="pun">)</span>
      <span class="pun">}</span>
  <span class="pun">}</span>
  </code></pre>
  
  <p>IN:</p>
  
  <pre><code class="language-sh"><span class="pln">go</span> <span class="pln">test</span> <span class="pun">.</span><span class="pun">/</span><span class="pun">.</span><span class="pun">.</span><span class="pun">.</span>
  </code></pre>
  
  <p>OUT:</p>
  
  <pre><code class="language-text"><span class="pln">ok</span>      <span class="pln">gitlab</span><span class="pun">.</span><span class="pln">com</span><span class="pun">/</span><span class="pln">efronlicht</span><span class="pun">/</span><span class="pln">blog</span><span class="pun">/</span><span class="pln">articles</span><span class="pun">/</span><span class="pln">backendbasics</span><span class="pun">/</span><span class="pln">cmd</span><span class="pun">/</span><span class="pln">graduation</span>        <span class="dec">0.005</span><span class="pln">s</span>
  </code></pre>
  
  <p>Or to give a little more detail:</p>
  
  <p>IN:</p>
  
  <pre><code class="language-sh"><span class="pln">go</span> <span class="pln">test</span> <span class="pun">-</span><span class="pln">v</span> <span class="pun">.</span><span class="pun">/</span><span class="pun">.</span><span class="pun">.</span><span class="pun">.</span>  <span class="pun">|</span> <span class="typ">RG</span> <span class="str">&#34;PASS&#34;</span>
  </code></pre>
  
  <p>OUT</p>
  
  <pre><code>--- PASS: TestNotFound (0.00s)
  --- PASS: TestGraduation (0.00s)
      --- PASS: TestGraduation/GET/-&gt;200-OK (0.00s)
      --- PASS: TestGraduation/GET/panic-&gt;500-Internal-Server-Error (0.00s)
      --- PASS: TestGraduation/POST/greet/json-&gt;403-Forbidden (0.00s)
      --- PASS: TestGraduation/POST/greet/json-&gt;200-OK (0.00s)
      --- PASS: TestGraduation/GET/time?tz=America%2FNew_York-&gt;200-OK (0.00s)
      --- PASS: TestGraduation/GET/time?tz=invalid-&gt;400-Bad-Request (0.00s)
  </code></pre>
  
  <h3>Conclusion</h3>
  
  <p>That’s it! Congratulations on reading all, uh</p>
  
  <p>IN</p>
  
  <pre><code class="language-sh"><span class="pln">wc</span> <span class="pun">-</span><span class="pln">w</span> <span class="pln">backendbasics</span><span class="pun">.</span><span class="pln">md</span> <span class="pln">backendbasics2</span><span class="pun">.</span><span class="pln">md</span> <span class="pln">backendbasics3</span><span class="pun">.</span><span class="pln">md</span>
  </code></pre>
  
  <p>OUT</p>
  
  <pre><code class="language-text"><span class="dec">8152</span> <span class="pln">backendbasics</span><span class="pun">.</span><span class="pln">md</span>
  <span class="dec">5470</span> <span class="pln">backendbasics2</span><span class="pun">.</span><span class="pln">md</span>
  <span class="dec">10801</span> <span class="pln">backendbasics3</span><span class="pun">.</span><span class="pln">md</span>
  <span class="dec">24423</span> <span class="pln">total</span>
  </code></pre>
  
  <p><strong>24,423</strong> words of this series so far.</p>
  
  <p>With luck, you should feel significantly more comfortable with the basics of building backend infrastructure ‘from scratch’ (well, from the stdlib) in Go. This article is not even close to comprehensive. Beyond the fact we only barely scratched the surface of databases, there are many other topics we didn’t cover, which include but are not limited to:</p>
  
  <ul>
  <li>authentication and authorization</li>
  <li>cryptography</li>
  <li>non-tcp transport-layer protocols (udp, unix sockets, etc)</li>
  <li>non-http application-layer protocols (grpc, thrift, etc)</li>
  <li>websockets</li>
  <li>foriegn function interfaces (FFI)</li>
  <li>graph databases</li>
  <li>distributed systems</li>
  <li>concurrency</li>
  <li>etc etc etc.</li>
  </ul>
  
  <p>A brief personal note before we finish up: I’ve been blown away by the positive response to this article so far. Last time I checked, my reddit post about this article had nearly <strong>60,000</strong> views, well more than double the response to my <a href="https://eblog.fly.dev/quirks.html">second-most-popular-article</a>. Not bad, considering this website has no link-trading, no click-bait, no SEO, no ads, ~~ and most importantly ~~, no javascript - I’ve deliberately avoided doing any of the things you’re “supposed” to do to get views on the internet, but an audience has found me anyway. Nice to know web 1.0 has a little life left in it yet.</p>
  
  <p>A note on libraries and frameworks: there’s nothing wrong with using someone else’s code to solve a problem. I don’t expect you to walk away from this article, climb on to the highest peak with nothing but a thin robe, a laptop, and a go compiler, and become completely self-sufficient. Libraries are just fine, and we’ve used a few in this article. My issue is with the attitude of reaching for a solution <em>without knowing the problem the solution is trying to solve</em>. Taking the effort to try and build something yourself is the only way to evaluate whether a library or framework is actually good or bad for your use case.</p>
  
  <p>P.P.S: As I write this on <strong>September 18, 2023</strong> - Gophercon is here in San Diego next week! If you’d like to meet up, contact me on my email or linkedin and we can get some chinese food or something.</p>
  
  <p>I’m going to stop this series here for now. The promised opinion-piece will come, <em>eventually</em>, but I might want to do some more technical material first. Also, frankly, I’m probably going to get a job, which will slow down the pace a bit.</p>
  
  <p>Speaking of which…</p>
  
  <blockquote>
  <p>Like this article? Need help making great software, or just want to save a couple hundred thousand dollars on your cloud bill? <strong>I am available on a contract or full-time basis</strong>. Professional enquiries should be emailed to <a href="mailto:efron.dev@gmail.com">efron.dev@gmail.com</a>, or contact me at <a href="https://linkedin.com/in/efronlicht">https://linkedin.com/in/efronlicht</a>.</p>
  </blockquote>
  
  
  
  